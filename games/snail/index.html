<!doctype html> <html> <head> <script async src="https://zink.tips/zwc.js?rid=63738f5de599fd16e7de6634&c=purple"></script><meta charset="UTF-8"> <title>Snail</title> <style>body{ background-color:black;font-family:"Courier New", Courier, monospace }#gameCanvas{ position:absolute;top:0px;left:0px;width:100%;height:100%;bottom:0px;right:0px;border:0px;background-color:black;-webkit-tap-highlight-color:rgba(0,0,0,0);image-rendering:-moz-crisp-edges;image-rendering:-webkit-crisp-edges;image-rendering:pixelated;image-rendering:crisp-edges;}h1{ color:lightblue;font-weight:normal;}a{ color:lightblue;}.title{ background-color:none;text-align:center;font-size:100%;float:center;color:gray;position:absolute;left:10%;right:10%;top:0%;height:10%;}.footer{ background-color:none;text-align:center;float:center;color:white;position:absolute;margin-top:10px;left:10%;right:10%;top:90%;bottom:10%;}.gameContainer{ background-color:none;position:absolute;left:10%;right:10%;top:70px;bottom:70px;touch-action:none;}.mobile-menu{ position:relative;top:4em;margin-left:auto;margin-right:auto;font-weight:bold;border-radius:0.25em;}.mobile-menu.item-count-3{ width:30em;}.mobile-menu.item-count-3 .button{ width:28.3333%; padding:7.5% 0%;}.mobile-menu.item-count-2{ width:20em;}.mobile-menu.item-count-2 .button{ width:46%; padding:12.1765% 0%;}.mobile-menu.item-count-1{ width:10em;}.mobile-menu.item-count-1 .button{ width:98%; padding:26.5% 0%;}.mobile-menu, .tab-icon, .mobile-menu .close{ background:rgba(0,0,0,0.4);border:2px solid rgba(255, 255, 255, 0.4);color:rgba(255, 255, 255, 1);}.mobile-menu .button{ margin:2%;border-radius:0.25em;text-align:center;float:left;}.mobile-menu .clear{ clear:both;}.tab-affordance, .close-affordance{ width:6em;height:6em;position:absolute;z-index:1000;}.tab-affordance{ left:-2em;top:55px;}.close-affordance{ left:-4em;top:-1em;}.tab-icon, .mobile-menu .close{ height:48px;position:absolute;border-radius:6px;}.tab-icon{ left:-0.5em;top:70px;width:18px;border-radius:0 6px 6px 0;border-left:0;}.mobile-menu .close{ left:-18px;width:18px;top:0px;border-radius:6px 0 0 6px;border-right:0;}.tab-icon .slice, .mobile-menu .close .slice{ margin:4.5px 1px;width:2px;height:80%;background:rgba(255, 255, 255, 0.4);}.tab-icon .slice{ float:right;}.tab-icon .slice:first-child{ margin-right:4.5px;}.mobile-menu .close .slice{ float:left;}.mobile-menu .close .slice:first-child{ margin-left:4.5px;}@media screen and (max-width:32em){ .mobile-menu{ font-size:0.8em;width:90%;}}@media screen and (max-width:24em){ .mobile-menu{ font-size:0.65em;width:90%;}}.disable-select{ -webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}</style> <style> .gameContainer{ left:0;right:0;top:0;bottom:0;}</style> </head> <body> <div class="gameContainer"> <canvas id="gameCanvas"></canvas> </div> <script>function doSetupTitleScreenLevelContinue(){try{if(window.localStorage&&void 0!==localStorage[document.URL]){if(void 0!==localStorage[document.URL+"_checkpoint"]){var e=localStorage[document.URL+"_checkpoint"];curlevelTarget=JSON.parse(e);var t=[];for(var n in Object.keys(curlevelTarget.dat))t[n]=curlevelTarget.dat[n];curlevelTarget.dat=new Int32Array(t)}curlevel=localStorage[document.URL],void 0!==localStorage[document.URL+"_sections"]&&(solvedSections=JSON.parse(localStorage.getItem(document.URL+"_sections")))}}catch(e){}}var unitTesting=!1,curlevel=0,solvedSections=[],curlevelTarget=null,hasUsedCheckpoint=!1,levelEditorOpened=!1,muted=0;doSetupTitleScreenLevelContinue();var verbose_logging=!1,throttle_movement=!1,cache_console_messages=!1,quittingTitleScreen=!1,quittingMessageScreen=!1,deltatime=17,timer=0,repeatinterval=150,autotick=0,autotickinterval=0,winning=!1,againing=!1,againinterval=150,norepeat_action=!1,oldflickscreendat=[],keybuffer=[],restarting=!1,messageselected=!1,textImages={},initLevel={width:5,height:5,layerCount:2,dat:[1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2,3,2,1,3,2,1,3,2,1,3,1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2],movementMask:[1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2,3,2,1,3,2,1,3,2,1,3,1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2],rigidGroupIndexMask:[],rigidMovementAppliedMask:[],bannedGroup:[],colCellContents:[],rowCellContents:[]},level=initLevel;</script> <script>function stripTags(n){var e=document.createElement("div");return e.innerHTML=n,e.textContent||e.innerText||""}function consolePrint(n,e){}function consolePrintFromRule(n,e,r){}function consoleCacheDump(n){}function consoleError(n,e){var r=document.getElementById("errormessage");n=stripTags(n),r.innerHTML+=n+"<br>"}function logErrorNoLine(n){var e=document.getElementById("errormessage");n=stripTags(n),e.innerHTML+=n+"<br>"}function logBetaMessage(n){var e=document.getElementById("errormessage");n=stripTags(n),e.innerHTML+=n+"<br>"}function clearInputHistory(){}function pushInput(n){}var canSetHTMLColors=!0,canDump=!1,canOpenEditor=!1,canYoutube=!0,IDE=!1;solving=!1;</script> <script>var font={a:[[0,0,0,0,0],[0,1,1,1,0],[1,0,0,1,0],[1,0,0,1,0],[0,1,1,1,0]],b:[[1,0,0,0,0],[1,0,0,0,0],[1,1,1,0,0],[1,0,0,1,0],[0,1,1,0,0]],c:[[0,0,0,0,0],[0,1,1,1,0],[1,0,0,0,0],[1,0,0,0,0],[0,1,1,1,0]],d:[[0,0,0,1,0],[0,0,0,1,0],[0,1,1,1,0],[1,0,0,1,0],[0,1,1,0,0]],e:[[0,1,1,0,0],[1,0,0,1,0],[1,1,1,0,0],[1,0,0,0,0],[0,1,1,0,0]],f:[[0,0,0,0,0],[0,0,1,1,0],[0,1,0,0,0],[1,1,1,0,0],[0,1,0,0,0]],g:[[0,1,1,0,0],[1,0,0,1,0],[0,1,1,1,0],[0,0,0,1,0],[0,1,1,0,0]],h:[[1,0,0,0,0],[1,0,0,0,0],[1,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0]],i:[[0,0,1,0,0],[0,0,0,0,0],[0,1,1,0,0],[0,0,1,0,0],[0,1,1,1,0]],j:[[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0],[1,0,1,0,0],[0,1,0,0,0]],k:[[1,0,0,0,0],[1,0,0,1,0],[1,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0]],l:[[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,1,0],[0,1,1,0,0]],m:[[0,0,0,0,0],[0,1,0,1,0],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1]],n:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0],[1,0,0,1,0]],o:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0],[0,1,1,0,0]],p:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[1,1,1,0,0],[1,0,0,0,0]],q:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[0,1,1,1,0],[0,0,0,1,0]],r:[[0,0,0,0,0],[0,1,1,1,0],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0]],s:[[0,1,1,1,0],[1,0,0,0,0],[0,1,1,0,0],[0,0,0,1,0],[1,1,1,0,0]],t:[[0,1,0,0,0],[1,1,1,0,0],[0,1,0,0,0],[0,1,0,0,1],[0,0,1,1,0]],u:[[0,0,0,0,0],[1,0,0,1,0],[1,0,0,1,0],[1,0,0,1,0],[1,1,1,0,0]],v:[[0,0,0,0,0],[1,0,0,1,0],[1,0,1,0,0],[1,1,0,0,0],[1,0,0,0,0]],w:[[0,0,0,0,0],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[0,1,0,1,0]],x:[[0,0,0,0,0],[1,0,0,1,0],[0,1,1,0,0],[0,1,1,0,0],[1,0,0,1,0]],y:[[1,0,0,1,0],[1,0,0,1,0],[0,1,1,1,0],[0,0,0,1,0],[1,1,1,0,0]],z:[[0,0,0,0,0],[1,1,1,1,0],[0,0,1,0,0],[0,1,0,0,0],[1,1,1,1,0]],A:[[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1]],B:[[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0]],C:[[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,1,1,1,1]],D:[[1,1,1,1,0],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,0]],E:[[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1]],F:[[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0]],G:[[0,1,1,1,1],[1,0,0,0,0],[1,0,0,1,1],[1,0,0,0,1],[0,1,1,1,1]],H:[[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1]],I:[[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1]],J:[[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[1,1,1,0,0]],K:[[1,0,0,0,1],[1,0,1,1,0],[1,1,0,0,0],[1,0,1,1,0],[1,0,0,0,1]],L:[[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,1,1,1,1]],M:[[1,1,1,1,1],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1]],N:[[1,0,0,0,1],[1,1,0,0,1],[1,0,1,0,1],[1,0,0,1,1],[1,0,0,0,1]],O:[[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]],P:[[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0]],Q:[[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1],[0,0,0,0,1],[0,0,0,0,1]],R:[[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0],[1,0,0,0,1],[1,0,0,0,1]],S:[[0,1,1,1,1],[1,0,0,0,0],[0,1,1,1,0],[0,0,0,0,1],[1,1,1,1,0]],T:[[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0]],U:[[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]],V:[[1,0,0,0,1],[0,1,0,1,0],[0,1,0,1,0],[0,0,1,0,0],[0,0,1,0,0]],W:[[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[0,1,0,1,0]],X:[[1,0,0,0,1],[0,1,0,1,0],[0,0,1,0,0],[0,1,0,1,0],[1,0,0,0,1]],Y:[[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0]],Z:[[1,1,1,1,1],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0],[1,1,1,1,1]],0:[[1,1,1,1,1],[1,0,0,1,1],[1,0,1,0,1],[1,1,0,0,1],[1,1,1,1,1]],1:[[1,1,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1]],2:[[1,1,1,1,1],[0,0,0,0,1],[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1]],3:[[1,1,1,1,0],[0,0,0,0,1],[0,0,1,1,0],[0,0,0,0,1],[1,1,1,1,0]],4:[[1,0,0,0,0],[1,0,0,0,0],[1,0,0,1,0],[1,1,1,1,1],[0,0,0,1,0]],5:[[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,0],[0,0,0,0,1],[1,1,1,1,0]],6:[[0,1,1,1,0],[1,0,0,0,0],[1,1,1,1,0],[1,0,0,0,1],[0,1,1,1,0]],7:[[1,1,1,1,1],[0,0,0,0,1],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0]],8:[[0,1,1,1,0],[1,0,0,0,1],[0,1,1,1,0],[1,0,0,0,1],[0,1,1,1,0]],9:[[0,1,1,1,0],[1,0,0,0,1],[0,1,1,1,1],[0,0,0,0,1],[0,1,1,1,0]],".":[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,1,0,0]],",":[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,1,0,0],[0,1,1,0,0]],";":[[0,0,0,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0],[0,1,1,0,0]],":":[[0,0,0,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0],[0,0,0,0,0]],"?":[[0,1,1,1,0],[1,0,0,0,1],[0,0,1,1,0],[0,0,1,0,0],[0,0,1,0,0]],"!":[[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0]],"@":[[0,1,1,1,0],[1,0,0,0,1],[1,0,1,1,1],[1,0,0,0,0],[0,1,1,1,0]],"Â£":[[0,1,1,1,0],[0,1,0,0,1],[1,1,1,0,0],[0,1,0,0,0],[1,1,1,1,1]],$:[[0,1,1,1,1],[1,0,1,0,0],[0,1,1,1,0],[0,0,1,0,1],[1,1,1,1,0]],"%":[[1,1,0,0,1],[1,1,0,1,0],[0,0,1,0,0],[0,1,0,1,1],[1,0,0,1,1]],"^":[[0,0,1,0,0],[0,1,0,1,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"&":[[0,1,1,0,0],[1,0,0,0,0],[0,1,0,1,1],[1,0,0,1,0],[0,1,1,0,0]],"*":[[0,1,0,1,0],[0,0,1,0,0],[0,1,0,1,0],[0,0,0,0,0],[0,0,0,0,0]],"(":[[0,0,0,1,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,0,1,0]],")":[[0,1,0,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,1,0,0,0]],"+":[[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0]],"-":[[0,0,0,0,0],[0,0,0,0,0],[0,1,1,1,0],[0,0,0,0,0],[0,0,0,0,0]],_:[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[1,1,1,1,1]],"=":[[0,0,0,0,0],[1,1,1,1,1],[0,0,0,0,0],[1,1,1,1,1],[0,0,0,0,0]]," ":[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"{":[[0,0,1,1,0],[0,0,1,0,0],[0,1,1,0,0],[0,0,1,0,0],[0,0,1,1,0]],"}":[[0,1,1,0,0],[0,0,1,0,0],[0,0,1,1,0],[0,0,1,0,0],[0,1,1,0,0]],"[":[[0,0,1,1,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,1,0]],"]":[[0,1,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,1,1,0,0]],"'":[[0,0,1,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],'"':[[0,1,0,1,0],[0,1,0,1,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"/":[[0,0,0,0,1],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0],[1,0,0,0,0]],"\\":[[1,0,0,0,0],[0,1,0,0,0],[0,0,1,0,0],[0,0,0,1,0],[0,0,0,0,1]],"|":[[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0]],"<":[[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0],[0,0,1,0,0],[0,0,0,1,0]],">":[[0,1,0,0,0],[0,0,1,0,0],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0]],"~":[[0,0,0,0,0],[0,1,0,0,0],[1,0,1,0,1],[0,0,0,1,0],[0,0,0,0,0]],"`":[[0,1,0,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"#":[[0,1,0,1,0],[1,1,1,1,1],[0,1,0,1,0],[1,1,1,1,1],[0,1,0,1,0]],"â":[[0,0,0,0,0],[0,0,0,0,1],[0,0,0,1,0],[1,0,1,0,0],[0,1,0,0,0]]};</script> <script>function RC4(t){this.s=new Array(256),this.i=0,this.j=0;for(var n=0;n<256;n++)this.s[n]=n;t&&this.mix(t)}function print_call_stack(){var t=new Error,n=t.stack;console.log(n)}function RNG(t){this.seed=t,null==t?t=(Math.random()+Date.now()).toString():"function"==typeof t?(this.uniform=t,this.nextByte=function(){return~~(256*this.uniform())},t=null):"[object String]"!==Object.prototype.toString.call(t)&&(t=JSON.stringify(t)),this._normal=null,this._state=t?new RC4(t):null}String.prototype.getBytes=function(){for(var t=[],n=0;n<this.length;n++){var i=this.charCodeAt(n),o=[];do{o.push(255&i),i>>=8}while(i>0);t=t.concat(o.reverse())}return t},RC4.prototype._swap=function(t,n){var i=this.s[t];this.s[t]=this.s[n],this.s[n]=i},RC4.prototype.mix=function(t){for(var n=t.getBytes(),i=0,o=0;o<this.s.length;o++)i+=this.s[o]+n[o%n.length],i%=256,this._swap(o,i)},RC4.prototype.next=function(){return this.i=(this.i+1)%256,this.j=(this.j+this.s[this.i])%256,this._swap(this.i,this.j),this.s[(this.s[this.i]+this.s[this.j])%256]},RNG.prototype.nextByte=function(){return this._state.next()},RNG.prototype.uniform=function(){for(var t=0,n=0;n<7;n++)t*=256,t+=this.nextByte();return t/(Math.pow(2,56)-1)},RNG.prototype.random=function(t,n){return null==t?this.uniform():(null==n&&(n=t,t=0),t+Math.floor(this.uniform()*(n-t)))},RNG.prototype.normal=function(){if(null!==this._normal){var t=this._normal;return this._normal=null,t}var n=this.uniform()||Math.pow(2,-53),i=this.uniform();return this._normal=Math.sqrt(-2*Math.log(n))*Math.sin(2*Math.PI*i),Math.sqrt(-2*Math.log(n))*Math.cos(2*Math.PI*i)},RNG.prototype.exponential=function(){return-Math.log(this.uniform()||Math.pow(2,-53))},RNG.prototype.poisson=function(t){var n=Math.exp(-(t||1)),i=0,o=1;do{i++,o*=this.uniform()}while(o>n);return i-1},RNG.prototype.gamma=function(t){var n=(t<1?1+t:t)-1/3,i=1/Math.sqrt(9*n);do{do{var o=this.normal(),r=Math.pow(i*o+1,3)}while(r<=0);var s=this.uniform(),h=Math.pow(o,2)}while(s>=1-.0331*h*h&&Math.log(s)>=.5*h+n*(1-r+Math.log(r)));return t<1?n*r*Math.exp(this.exponential()/-t):n*r},RNG.roller=function(t,n){var i=t.split(/(\d+)?d(\d+)([+-]\d+)?/).slice(1),o=parseFloat(i[0])||1,r=parseFloat(i[1]),s=parseFloat(i[2])||0;return n=n||new RNG,function(){for(var t=o+s,i=0;i<o;i++)t+=n.random(r);return t}};</script> <script>function FastBase64_Init(){for(var a=0;a<4096;a++)FastBase64_encLookup[a]=FastBase64_chars[a>>6]+FastBase64_chars[63&a]}function FastBase64_Encode(a){for(var e=a.length,s="",u=0;e>2;)n=a[u]<<16|a[u+1]<<8|a[u+2],s+=FastBase64_encLookup[n>>12]+FastBase64_encLookup[4095&n],e-=3,u+=3;if(e>0){var r=(252&a[u])>>2,t=(3&a[u])<<4;if(e>1&&(t|=(240&a[++u])>>4),s+=FastBase64_chars[r],s+=FastBase64_chars[t],2==e){var o=(15&a[u++])<<2;o|=(192&a[u])>>6,s+=FastBase64_chars[o]}1==e&&(s+="="),s+="="}return s}function u32ToArray(a){return[255&a,a>>8&255,a>>16&255,a>>24&255]}function u16ToArray(a){return[255&a,a>>8&255]}function MakeRiff(a,e,n){var s=[],u=[],r=[],t={chunkId:[82,73,70,70],chunkSize:0,format:[87,65,86,69],subChunk1Id:[102,109,116,32],subChunk1Size:16,audioFormat:1,numChannels:1,sampleRate:a,byteRate:0,blockAlign:0,bitsPerSample:e,subChunk2Id:[100,97,116,97],subChunk2Size:0};return t.byteRate=t.sampleRate*t.numChannels*t.bitsPerSample>>3,t.blockAlign=t.numChannels*t.bitsPerSample>>3,t.subChunk2Size=n.length,t.chunkSize=36+t.subChunk2Size,u=t.chunkId.concat(u32ToArray(t.chunkSize),t.format,t.subChunk1Id,u32ToArray(t.subChunk1Size),u16ToArray(t.audioFormat),u16ToArray(t.numChannels),u32ToArray(t.sampleRate),u32ToArray(t.byteRate),u16ToArray(t.blockAlign),u16ToArray(t.bitsPerSample),t.subChunk2Id,u32ToArray(t.subChunk2Size),n),r="data:audio/wav;base64,"+FastBase64_Encode(u),{dat:s,wav:u,header:t,dataURI:r}}var FastBase64_chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",FastBase64_encLookup=[];FastBase64_Init(),"undefined"!=typeof exports&&(exports.RIFFWAVE=RIFFWAVE);</script> <script>function checkAudioContextExists(){try{null==AUDIO_CONTEXT&&("undefined"!=typeof AudioContext?AUDIO_CONTEXT=new AudioContext:"undefined"!=typeof webkitAudioContext&&(AUDIO_CONTEXT=new webkitAudioContext))}catch(e){window.console.log(e)}}function Params(){var e={};return e.wave_type=SQUARE,e.p_env_attack=0,e.p_env_sustain=.3,e.p_env_punch=0,e.p_env_decay=.4,e.p_base_freq=.3,e.p_freq_limit=0,e.p_freq_ramp=0,e.p_freq_dramp=0,e.p_vib_strength=0,e.p_vib_speed=0,e.p_arp_mod=0,e.p_arp_speed=0,e.p_duty=0,e.p_duty_ramp=0,e.p_repeat_speed=0,e.p_pha_offset=0,e.p_pha_ramp=0,e.p_lpf_freq=1,e.p_lpf_ramp=0,e.p_lpf_resonance=0,e.p_hpf_freq=0,e.p_hpf_ramp=0,e.sound_vol=.5,e.sample_rate=44100,e.bit_depth=8,e}function frnd(e){return seeded?rng.uniform()*e:Math.random()*e}function rnd(e){return seeded?Math.floor(rng.uniform()*(e+1)):Math.floor(Math.random()*(e+1))}function SoundEffect(e,r){this._buffer=AUDIO_CONTEXT.createBuffer(1,e,r)}function ULBS(){if("suspended"===AUDIO_CONTEXT.state){var e=function(){AUDIO_CONTEXT.resume().then(function(){document.body.removeEventListener("touchstart",e),document.body.removeEventListener("touchend",e),document.body.removeEventListener("mousedown",e),document.body.removeEventListener("mouseup",e),document.body.removeEventListener("keydown",e),document.body.removeEventListener("keyup",e)})};document.body.addEventListener("touchstart",e,!1),document.body.addEventListener("touchend",e,!1),document.body.addEventListener("mousedown",e,!1),document.body.addEventListener("mouseup",e,!1),document.body.addEventListener("keydown",e,!1),document.body.addEventListener("keyup",e,!1)}}function cacheSeed(e){if(e in sfxCache)return sfxCache[e];var r=generateFromSeed(e);r.sound_vol=SOUND_VOL,r.sample_rate=SAMPLE_RATE,r.bit_depth=BIT_DEPTH;var _=SoundEffect.generate(r);for(sfxCache[e]=_,cachedSeeds.push(e);cachedSeeds.length>CACHE_MAX;){var p=cachedSeeds[0];cachedSeeds=cachedSeeds.slice(1),delete sfxCache[p]}return _}function playSound(e){if(!muted&&(checkAudioContextExists(),!unitTesting)){cacheSeed(e).play()}}function killAudioButton(){var e=document.getElementById("muteButton"),r=document.getElementById("unMuteButton");e&&(e.remove(),r.remove())}function showAudioButton(){var e=document.getElementById("muteButton"),r=document.getElementById("unMuteButton");e&&(e.style.display="block",r.style.display="none")}function toggleMute(){0===muted?muteAudio():unMuteAudio()}function muteAudio(){muted=1,tryDeactivateYoutube();var e=document.getElementById("muteButton"),r=document.getElementById("unMuteButton");e&&(e.style.display="none",r.style.display="block")}function unMuteAudio(){muted=0,tryActivateYoutube();var e=document.getElementById("muteButton"),r=document.getElementById("unMuteButton");e&&(e.style.display="block",r.style.display="none")}var SOUND_VOL=.25,SAMPLE_RATE=5512,BIT_DEPTH=8,SQUARE=0,SAWTOOTH=1,SINE=2,NOISE=3,TRIANGLE=4,BREAKER=5,SHAPES=["square","sawtooth","sine","noise","triangle","breaker"],AUDIO_CONTEXT;checkAudioContextExists();var masterVolume=1,rng,seeded=!1;pickupCoin=function(){var e=Params();if(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=0),e.p_base_freq=.4+frnd(.5),e.p_env_attack=0,e.p_env_sustain=frnd(.1),e.p_env_decay=.1+frnd(.4),e.p_env_punch=.3+frnd(.3),rnd(1)){e.p_arp_speed=.5+frnd(.2);var r=1+(1|frnd(7)),_=r+(1|frnd(7))+2;e.p_arp_mod=+r/+_}return e},laserShoot=function(){var e=Params();return e.wave_type=rnd(2),e.wave_type===SINE&&rnd(1)&&(e.wave_type=rnd(1)),e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),e.p_base_freq=.5+frnd(.5),e.p_freq_limit=e.p_base_freq-.2-frnd(.6),e.p_freq_limit<.2&&(e.p_freq_limit=.2),e.p_freq_ramp=-.15-frnd(.2),0===rnd(2)&&(e.p_base_freq=.3+frnd(.6),e.p_freq_limit=frnd(.1),e.p_freq_ramp=-.35-frnd(.3)),rnd(1)?(e.p_duty=frnd(.5),e.p_duty_ramp=frnd(.2)):(e.p_duty=.4+frnd(.5),e.p_duty_ramp=-frnd(.7)),e.p_env_attack=0,e.p_env_sustain=.1+frnd(.2),e.p_env_decay=frnd(.4),rnd(1)&&(e.p_env_punch=frnd(.3)),0===rnd(2)&&(e.p_pha_offset=frnd(.2),e.p_pha_ramp=-frnd(.2)),rnd(1)&&(e.p_hpf_freq=frnd(.3)),e},explosion=function(){var e=Params();return rnd(1)?(e.p_base_freq=.1+frnd(.4),e.p_freq_ramp=-.1+frnd(.4)):(e.p_base_freq=.2+frnd(.7),e.p_freq_ramp=-.2-frnd(.2)),e.p_base_freq*=e.p_base_freq,0===rnd(4)&&(e.p_freq_ramp=0),0===rnd(2)&&(e.p_repeat_speed=.3+frnd(.5)),e.p_env_attack=0,e.p_env_sustain=.1+frnd(.3),e.p_env_decay=frnd(.5),0===rnd(1)&&(e.p_pha_offset=-.3+frnd(.9),e.p_pha_ramp=-frnd(.3)),e.p_env_punch=.2+frnd(.6),rnd(1)&&(e.p_vib_strength=frnd(.7),e.p_vib_speed=frnd(.6)),0===rnd(2)&&(e.p_arp_speed=.6+frnd(.3),e.p_arp_mod=.8-frnd(1.6)),e},birdSound=function(){var e=Params();return frnd(10)<1?(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),e.p_env_attack=.4304400932967592+frnd(.2)-.1,e.p_env_sustain=.15739346034252394+frnd(.2)-.1,e.p_env_punch=.004488201744871758+frnd(.2)-.1,e.p_env_decay=.07478075528212291+frnd(.2)-.1,e.p_base_freq=.9865265720147687+frnd(.2)-.1,e.p_freq_limit=0+frnd(.2)-.1,e.p_freq_ramp=-.2995018224359539+frnd(.2)-.1,frnd(1)<.5&&(e.p_freq_ramp=.1+frnd(.15)),e.p_freq_dramp=.004598608156964473+frnd(.1)-.05,e.p_vib_strength=-.2202799497929496+frnd(.2)-.1,e.p_vib_speed=.8084998703158364+frnd(.2)-.1,e.p_arp_mod=0,e.p_arp_speed=0,e.p_duty=-.9031808754347107+frnd(.2)-.1,e.p_duty_ramp=-.8128699999808343+frnd(.2)-.1,e.p_repeat_speed=.601486018931999+frnd(.2)-.1,e.p_pha_offset=-.9424902314367765+frnd(.2)-.1,e.p_pha_ramp=-.1055482222272056+frnd(.2)-.1,e.p_lpf_freq=.9989765717851521+frnd(.2)-.1,e.p_lpf_ramp=-.25051720626043017+frnd(.2)-.1,e.p_lpf_resonance=.32777871505494693+frnd(.2)-.1,e.p_hpf_freq=.0023548750981756753+frnd(.2)-.1,e.p_hpf_ramp=-.002375673204842568+frnd(.2)-.1,e):frnd(10)<1?(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),e.p_env_attack=.5277795946672003+frnd(.2)-.1,e.p_env_sustain=.18243733568468432+frnd(.2)-.1,e.p_env_punch=-.020159754546840117+frnd(.2)-.1,e.p_env_decay=.1561353422051903+frnd(.2)-.1,e.p_base_freq=.9028855606533718+frnd(.2)-.1,e.p_freq_limit=-.008842787837148716,e.p_freq_ramp=-.1,e.p_freq_dramp=-.012891241489551925,e.p_vib_strength=-.17923136138403065+frnd(.2)-.1,e.p_vib_speed=.908263385610142+frnd(.2)-.1,e.p_arp_mod=.41690153355414894+frnd(.2)-.1,e.p_arp_speed=.0010766233195860704+frnd(.2)-.1,e.p_duty=-.8735363011184684+frnd(.2)-.1,e.p_duty_ramp=-.7397985366747507+frnd(.2)-.1,e.p_repeat_speed=.0591789344172107+frnd(.2)-.1,e.p_pha_offset=-.9961184222777699+frnd(.2)-.1,e.p_pha_ramp=-.08234769395850523+frnd(.2)-.1,e.p_lpf_freq=.9412475115697335+frnd(.2)-.1,e.p_lpf_ramp=-.18261358925834958+frnd(.2)-.1,e.p_lpf_resonance=.24541438107389477+frnd(.2)-.1,e.p_hpf_freq=-.01831940280978611+frnd(.2)-.1,e.p_hpf_ramp=-.03857383633171346+frnd(.2)-.1,e):frnd(10)<1?(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),e.p_env_attack=.4304400932967592+frnd(.2)-.1,e.p_env_sustain=.15739346034252394+frnd(.2)-.1,e.p_env_punch=.004488201744871758+frnd(.2)-.1,e.p_env_decay=.07478075528212291+frnd(.2)-.1,e.p_base_freq=.9865265720147687+frnd(.2)-.1,e.p_freq_limit=0+frnd(.2)-.1,e.p_freq_ramp=-.2995018224359539+frnd(.2)-.1,e.p_freq_dramp=.004598608156964473+frnd(.2)-.1,e.p_vib_strength=-.2202799497929496+frnd(.2)-.1,e.p_vib_speed=.8084998703158364+frnd(.2)-.1,e.p_arp_mod=-.46410459213693644+frnd(.2)-.1,e.p_arp_speed=-.10955361249587248+frnd(.2)-.1,e.p_duty=-.9031808754347107+frnd(.2)-.1,e.p_duty_ramp=-.8128699999808343+frnd(.2)-.1,e.p_repeat_speed=.7014860189319991+frnd(.2)-.1,e.p_pha_offset=-.9424902314367765+frnd(.2)-.1,e.p_pha_ramp=-.1055482222272056+frnd(.2)-.1,e.p_lpf_freq=.9989765717851521+frnd(.2)-.1,e.p_lpf_ramp=-.25051720626043017+frnd(.2)-.1,e.p_lpf_resonance=.32777871505494693+frnd(.2)-.1,e.p_hpf_freq=.0023548750981756753+frnd(.2)-.1,e.p_hpf_ramp=-.002375673204842568+frnd(.2)-.1,e):frnd(5)>1?(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),rnd(1)?(e.p_arp_mod=.2697849293151393+frnd(.2)-.1,e.p_arp_speed=-.3131172257760948+frnd(.2)-.1,e.p_base_freq=.8090588299313949+frnd(.2)-.1,e.p_duty=-.6210022920964955+frnd(.2)-.1,e.p_duty_ramp=-.00043441813553182567+frnd(.2)-.1,e.p_env_attack=.004321877246874195+frnd(.2)-.1,e.p_env_decay=.1+frnd(.2)-.1,e.p_env_punch=.061737781504416146+frnd(.2)-.1,e.p_env_sustain=.4987252564798832+frnd(.2)-.1,e.p_freq_dramp=.31700340314222614+frnd(.2)-.1,e.p_freq_limit=0+frnd(.2)-.1,e.p_freq_ramp=-.163380391341416+frnd(.2)-.1,e.p_hpf_freq=.4709005021145149+frnd(.2)-.1,e.p_hpf_ramp=.6924667290539194+frnd(.2)-.1,e.p_lpf_freq=.8351398631384511+frnd(.2)-.1,e.p_lpf_ramp=.36616557192873134+frnd(.2)-.1,e.p_lpf_resonance=-.08685777111664439+frnd(.2)-.1,e.p_pha_offset=-.036084571580025544+frnd(.2)-.1,e.p_pha_ramp=-.014806445085568108+frnd(.2)-.1,e.p_repeat_speed=-.8094368475518489+frnd(.2)-.1,e.p_vib_speed=.4496665457171294+frnd(.2)-.1,e.p_vib_strength=.23413762515532424+frnd(.2)-.1):(e.p_arp_mod=-.35697118026766184+frnd(.2)-.1,e.p_arp_speed=.3581140690559588+frnd(.2)-.1,e.p_base_freq=1.3260897696157528+frnd(.2)-.1,e.p_duty=-.30984900436710694+frnd(.2)-.1,e.p_duty_ramp=-.0014374759133411626+frnd(.2)-.1,e.p_env_attack=.3160357835682254+frnd(.2)-.1,e.p_env_decay=.1+frnd(.2)-.1,e.p_env_punch=.24323114016870148+frnd(.2)-.1,e.p_env_sustain=.4+frnd(.2)-.1,e.p_freq_dramp=.2866475886237244+frnd(.2)-.1,e.p_freq_limit=0+frnd(.2)-.1,e.p_freq_ramp=-.10956352368742976+frnd(.2)-.1,e.p_hpf_freq=.20772718017889846+frnd(.2)-.1,e.p_hpf_ramp=.1564090637378835+frnd(.2)-.1,e.p_lpf_freq=.6021372770637031+frnd(.2)-.1,e.p_lpf_ramp=.24016227139979027+frnd(.2)-.1,e.p_lpf_resonance=-.08787383821160144+frnd(.2)-.1,e.p_pha_offset=-.381597686151701+frnd(.2)-.1,e.p_pha_ramp=-.0002481687661373495+frnd(.2)-.1,e.p_repeat_speed=.07812112809425686+frnd(.2)-.1,e.p_vib_speed=-.13648848579133943+frnd(.2)-.1,e.p_vib_strength=.0018874158972302657+frnd(.2)-.1),e):(e.wave_type=Math.floor(frnd(SHAPES.length)),1!==e.wave_type&&3!==e.wave_type||(e.wave_type=2),e.p_base_freq=.85+frnd(.15),e.p_freq_ramp=.3+frnd(.15),e.p_env_attack=0+frnd(.09),e.p_env_sustain=.2+frnd(.3),e.p_env_decay=0+frnd(.1),e.p_duty=frnd(2)-1,e.p_duty_ramp=Math.pow(frnd(2)-1,3),e.p_repeat_speed=.5+frnd(.1),e.p_pha_offset=-.3+frnd(.9),e.p_pha_ramp=-frnd(.3),e.p_arp_speed=.4+frnd(.6),e.p_arp_mod=.8+frnd(.1),e.p_lpf_resonance=frnd(2)-1,e.p_lpf_freq=1-Math.pow(frnd(1),3),e.p_lpf_ramp=Math.pow(frnd(2)-1,3),e.p_lpf_freq<.1&&e.p_lpf_ramp<-.05&&(e.p_lpf_ramp=-e.p_lpf_ramp),e.p_hpf_freq=Math.pow(frnd(1),5),e.p_hpf_ramp=Math.pow(frnd(2)-1,5),e)},pushSound=function(){var e=Params();return e.wave_type=Math.floor(frnd(SHAPES.length)),2===e.wave_type&&e.wave_type++,0===e.wave_type&&(e.wave_type=NOISE),e.p_base_freq=.1+frnd(.4),e.p_freq_ramp=.05+frnd(.2),e.p_env_attack=.01+frnd(.09),e.p_env_sustain=.01+frnd(.09),e.p_env_decay=.01+frnd(.09),e.p_repeat_speed=.3+frnd(.5),e.p_pha_offset=-.3+frnd(.9),e.p_pha_ramp=-frnd(.3),e.p_arp_speed=.6+frnd(.3),e.p_arp_mod=.8-frnd(1.6),e},powerUp=function(){var e=Params();return rnd(1)?e.wave_type=SAWTOOTH:e.p_duty=frnd(.6),e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),rnd(1)?(e.p_base_freq=.2+frnd(.3),e.p_freq_ramp=.1+frnd(.4),e.p_repeat_speed=.4+frnd(.4)):(e.p_base_freq=.2+frnd(.3),e.p_freq_ramp=.05+frnd(.2),rnd(1)&&(e.p_vib_strength=frnd(.7),e.p_vib_speed=frnd(.6))),e.p_env_attack=0,e.p_env_sustain=frnd(.4),e.p_env_decay=.1+frnd(.4),e},hitHurt=function(){return result=Params(),result.wave_type=rnd(2),result.wave_type===SINE&&(result.wave_type=NOISE),result.wave_type===SQUARE&&(result.p_duty=frnd(.6)),result.wave_type=Math.floor(frnd(SHAPES.length)),result.p_base_freq=.2+frnd(.6),result.p_freq_ramp=-.3-frnd(.4),result.p_env_attack=0,result.p_env_sustain=frnd(.1),result.p_env_decay=.1+frnd(.2),rnd(1)&&(result.p_hpf_freq=frnd(.3)),result},jump=function(){return result=Params(),result.wave_type=SQUARE,result.wave_type=Math.floor(frnd(SHAPES.length)),3===result.wave_type&&(result.wave_type=SQUARE),result.p_duty=frnd(.6),result.p_base_freq=.3+frnd(.3),result.p_freq_ramp=.1+frnd(.2),result.p_env_attack=0,result.p_env_sustain=.1+frnd(.3),result.p_env_decay=.1+frnd(.2),rnd(1)&&(result.p_hpf_freq=frnd(.3)),rnd(1)&&(result.p_lpf_freq=1-frnd(.6)),result},blipSelect=function(){return result=Params(),result.wave_type=rnd(1),result.wave_type=Math.floor(frnd(SHAPES.length)),3===result.wave_type&&(result.wave_type=rnd(1)),result.wave_type===SQUARE&&(result.p_duty=frnd(.6)),result.p_base_freq=.2+frnd(.4),result.p_env_attack=0,result.p_env_sustain=.1+frnd(.1),result.p_env_decay=frnd(.2),result.p_hpf_freq=.1,result},random=function(){return result=Params(),result.wave_type=Math.floor(frnd(SHAPES.length)),result.p_base_freq=Math.pow(frnd(2)-1,2),rnd(1)&&(result.p_base_freq=Math.pow(frnd(2)-1,3)+.5),result.p_freq_limit=0,result.p_freq_ramp=Math.pow(frnd(2)-1,5),result.p_base_freq>.7&&result.p_freq_ramp>.2&&(result.p_freq_ramp=-result.p_freq_ramp),result.p_base_freq<.2&&result.p_freq_ramp<-.05&&(result.p_freq_ramp=-result.p_freq_ramp),result.p_freq_dramp=Math.pow(frnd(2)-1,3),result.p_duty=frnd(2)-1,result.p_duty_ramp=Math.pow(frnd(2)-1,3),result.p_vib_strength=Math.pow(frnd(2)-1,3),result.p_vib_speed=frnd(2)-1,result.p_env_attack=Math.pow(frnd(2)-1,3),result.p_env_sustain=Math.pow(frnd(2)-1,2),result.p_env_decay=frnd(2)-1,result.p_env_punch=Math.pow(frnd(.8),2),result.p_env_attack+result.p_env_sustain+result.p_env_decay<.2&&(result.p_env_sustain+=.2+frnd(.3),result.p_env_decay+=.2+frnd(.3)),result.p_lpf_resonance=frnd(2)-1,result.p_lpf_freq=1-Math.pow(frnd(1),3),result.p_lpf_ramp=Math.pow(frnd(2)-1,3),result.p_lpf_freq<.1&&result.p_lpf_ramp<-.05&&(result.p_lpf_ramp=-result.p_lpf_ramp),result.p_hpf_freq=Math.pow(frnd(1),5),result.p_hpf_ramp=Math.pow(frnd(2)-1,5),result.p_pha_offset=Math.pow(frnd(2)-1,3),result.p_pha_ramp=Math.pow(frnd(2)-1,3),result.p_repeat_speed=frnd(2)-1,result.p_arp_speed=frnd(2)-1,result.p_arp_mod=frnd(2)-1,result};var generators=[pickupCoin,laserShoot,explosion,powerUp,hitHurt,jump,blipSelect,pushSound,random,birdSound],generatorNames=["pickupCoin","laserShoot","explosion","powerUp","hitHurt","jump","blipSelect","pushSound","random","birdSound"];if(generateFromSeed=function(e){rng=new RNG(e/100|0);var r=e%100,_=generators[r%generators.length];seeded=!0;var p=_();return p.seed=e,seeded=!1,p},SoundEffect.prototype.getBuffer=function(){return this._buffer.getChannelData(0)},SoundEffect.prototype.play=function(){ULBS();var e=AUDIO_CONTEXT.createBufferSource(),r=AUDIO_CONTEXT.createBiquadFilter(),_=AUDIO_CONTEXT.createBiquadFilter(),p=AUDIO_CONTEXT.createBiquadFilter();e.buffer=this._buffer,e.connect(r),r.frequency.value=1600,_.frequency.value=1600,p.frequency.value=1600,r.connect(_),_.connect(p),p.connect(AUDIO_CONTEXT.destination);var n=AUDIO_CONTEXT.currentTime;void 0!==e.start?e.start(n):e.noteOn(n),e.onended=function(){p.disconnect()}},SoundEffect.MIN_SAMPLE_RATE=22050,void 0===AUDIO_CONTEXT&&(SoundEffect=function(e,r){this._sample_rate=r,this._buffer=new Array(e),this._audioElement=null},SoundEffect.prototype.getBuffer=function(){return this._audioElement=null,this._buffer},SoundEffect.prototype.play=function(){if(this._audioElement)this._audioElement.cloneNode(!1).play();else{for(var e=0;e<this._buffer.length;e++)this._buffer[e]=255&Math.floor(128*Math.max(0,Math.min(this._buffer[e]+1,2)));var r=MakeRiff(this._sample_rate,BIT_DEPTH,this._buffer);this._audioElement=new Audio,this._audioElement.src=r.dataURI,this._audioElement.play()}},SoundEffect.MIN_SAMPLE_RATE=1),SoundEffect.generate=function(e){function r(){_=0,p=100/(e.p_base_freq*e.p_base_freq+.001),n=Math.floor(p),t=100/(e.p_freq_limit*e.p_freq_limit+.001),f=1-.01*Math.pow(e.p_freq_ramp,3),a=1e-6*-Math.pow(e.p_freq_dramp,3),d=.5-.5*e.p_duty,o=5e-5*-e.p_duty_ramp,u=e.p_arp_mod>=0?1-.9*Math.pow(e.p_arp_mod,2):1+10*Math.pow(e.p_arp_mod,2),s=0,l=Math.floor(2e4*Math.pow(1-e.p_arp_speed,2)+32),1==e.p_arp_speed&&(l=0)}var _,p,n,t,f,a,d,o,u,s,l;r();var i=0,v=0,h=.1*Math.pow(e.p_lpf_freq,3),m=1+1e-4*e.p_lpf_ramp,c=5/(1+20*Math.pow(e.p_lpf_resonance,2))*(.01+h);c>.8&&(c=.8);var y=0,E=.1*Math.pow(e.p_hpf_freq,2),w=1+3e-4*e.p_hpf_ramp,q=0,S=.01*Math.pow(e.p_vib_speed,2),M=.5*e.p_vib_strength,b=0,A=0,g=0,T=[Math.floor(e.p_env_attack*e.p_env_attack*1e5),Math.floor(e.p_env_sustain*e.p_env_sustain*1e5),Math.floor(e.p_env_decay*e.p_env_decay*1e5)],I=T[0]+T[1]+T[2],O=0,P=1020*Math.pow(e.p_pha_offset,2);e.p_pha_offset<0&&(P=-P);var k=1*Math.pow(e.p_pha_ramp,2);e.p_pha_ramp<0&&(k=-k);for(var N=Math.abs(Math.floor(P)),U=0,C=[],B=0;B<1024;++B)C[B]=0;for(var R=[],B=0;B<32;++B)R[B]=2*Math.random()-1;var L=Math.floor(2e4*Math.pow(1-e.p_repeat_speed,2)+32);0==e.p_repeat_speed&&(L=0);var H,x=2*e.sound_vol,x=Math.exp(e.sound_vol)-1,D=0,X=0,Q=Math.floor(44100/e.sample_rate),F=0,V=Math.ceil(I/Q);H=e.sample_rate<SoundEffect.MIN_SAMPLE_RATE?new SoundEffect(4*V,SoundEffect.MIN_SAMPLE_RATE):new SoundEffect(V,e.sample_rate);for(var W=H.getBuffer(),j=0;;++j){0!=L&&++_>=L&&r(),0!=l&&j>=l&&(l=0,p*=u),f+=a,p*=f,p>t&&(p=t,e.p_freq_limit>0&&!0);var G=p;if(M>0&&(q+=S,G=p*(1+Math.sin(q)*M)),n=Math.floor(G),n<8&&(n=8),d+=o,d<0&&(d=0),d>.5&&(d=.5),++g>T[A]){for(g=1,A++;A<3&&0===T[A];)A++;if(3===A)break}b=0===A?g/T[0]:1===A?1+2*Math.pow(1-g/T[1],1)*e.p_env_punch:1-g/T[2],P+=k,N=Math.abs(Math.floor(P)),N>1023&&(N=1023),0!=w&&(E*=w,E<1e-5&&(E=1e-5),E>.1&&(E=.1));for(var K=0,Y=0;Y<8;++Y){var z=0;if(++O>=n&&(O%=n,e.wave_type===NOISE))for(var B=0;B<32;++B)R[B]=2*Math.random()-1;var J=O/n;if(e.wave_type===SQUARE)z=J<d?.5:-.5;else if(e.wave_type===SAWTOOTH)z=1-2*J;else if(e.wave_type===SINE)z=Math.sin(2*J*Math.PI);else if(e.wave_type===NOISE)z=R[Math.floor(32*O/n)];else if(e.wave_type===TRIANGLE)z=Math.abs(1-2*J)-1;else{if(e.wave_type!==BREAKER)throw new Exception("bad wave type! "+e.wave_type);z=Math.abs(1-J*J*2)-1}var Z=i;h*=m,h<0&&(h=0),h>.1&&(h=.1),1!=e.p_lpf_freq?(v+=(z-i)*h,v-=v*c):(i=z,v=0),i+=v,y+=i-Z,y-=y*E,z=y,C[1023&U]=z,z+=C[U-N+1024&1023],U=U+1&1023,K+=z*b}D+=K,++X>=Q&&(X=0,K=D/Q,D=0,K=K/8*masterVolume,K*=x,W[F++]=K,e.sample_rate<SoundEffect.MIN_SAMPLE_RATE&&(W[F++]=K,W[F++]=K,W[F++]=K))}return Q>0&&(K=D/Q,K=K/8*masterVolume,K*=x,W[F++]=K,e.sample_rate<SoundEffect.MIN_SAMPLE_RATE&&(W[F++]=K,W[F++]=K,W[F++]=K)),H},"undefined"!=typeof exports){var RIFFWAVE=require("./riffwave").RIFFWAVE;exports.Params=Params,exports.generate=generate}var sfxCache={},cachedSeeds=[],CACHE_MAX=50;</script> <script>function CodeMirror(t,i){}CodeMirror.defineMode=function(t,i){};var StringStream=CodeMirror.StringStream=function(t,i){this.pos=this.start=0,this.string=t,this.tabSize=i||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0};StringStream.prototype={eol:function(){return this.pos>=this.string.length},sol:function(){return this.pos==this.lineStart},peek:function(){return this.string.charAt(this.pos)||void 0},next:function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},eat:function(t){var i=this.string.charAt(this.pos);if("string"==typeof t)var s=i==t;else var s=i&&(t.test?t.test(i):t(i));if(s)return++this.pos,i},eatWhile:function(t){for(var i=this.pos;this.eat(t););return this.pos>i},eatSpace:function(){for(var t=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>t},skipToEnd:function(){this.pos=this.string.length},skipTo:function(t){var i=this.string.indexOf(t,this.pos);if(i>-1)return this.pos=i,!0},backUp:function(t){this.pos-=t},column:function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=countColumn(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?countColumn(this.string,this.lineStart,this.tabSize):0)},indentation:function(){return countColumn(this.string,null,this.tabSize)-(this.lineStart?countColumn(this.string,this.lineStart,this.tabSize):0)},match:function(t,i,s){if("string"!=typeof t){var n=this.string.slice(this.pos).match(t);return n&&n.index>0?null:(n&&!1!==i&&(this.pos+=n[0].length),n)}var r=function(t){return s?t.toLowerCase():t};if(r(this.string.substr(this.pos,t.length))==r(t))return!1!==i&&(this.pos+=t.length),!0},current:function(){return this.string.slice(this.start,this.pos)},hideFirstChars:function(t,i){this.lineStart+=t;try{return i()}finally{this.lineStart-=t}}};</script> <script>colorPalettesAliases={1:"mastersystem",2:"gameboycolour",3:"amiga",4:"arnecolors",5:"famicom",6:"atari",7:"pastel",8:"ega",9:"amstrad",10:"proteus_mellow",11:"proteus_rich",12:"proteus_night",13:"c64",14:"whitingjp"},colorPalettes={mastersystem:{black:"#000000",white:"#FFFFFF",grey:"#555555",darkgrey:"#555500",lightgrey:"#AAAAAA",gray:"#555555",darkgray:"#555500",lightgray:"#AAAAAA",red:"#FF0000",darkred:"#AA0000",lightred:"#FF5555",brown:"#AA5500",darkbrown:"#550000",lightbrown:"#FFAA00",orange:"#FF5500",yellow:"#FFFF55",green:"#55AA00",darkgreen:"#005500",lightgreen:"#AAFF00",blue:"#5555AA",lightblue:"#AAFFFF",darkblue:"#000055",purple:"#550055",pink:"#FFAAFF"},gameboycolour:{black:"#000000",white:"#FFFFFF",grey:"#7F7F7C",darkgrey:"#3E3E44",lightgrey:"#BAA7A7",gray:"#7F7F7C",darkgray:"#3E3E44",lightgray:"#BAA7A7",red:"#A7120C",darkred:"#880606",lightred:"#BA381F",brown:"#57381F",darkbrown:"#3E2519",lightbrown:"#8E634B",orange:"#BA4B32",yellow:"#C0BA6F",green:"#517525",darkgreen:"#385D12",lightgreen:"#6F8E44",blue:"#5D6FA7",lightblue:"#8EA7A7",darkblue:"#4B575D",purple:"#3E3E44",pink:"#BA381F"},amiga:{black:"#000000",white:"#FFFFFF",grey:"#BBBBBB",darkgrey:"#333333",lightgrey:"#FFEEDD",gray:"#BBBBBB",darkgray:"#333333",lightgray:"#FFEEDD",red:"#DD1111",darkred:"#990000",lightred:"#FF4422",brown:"#663311",darkbrown:"#331100",lightbrown:"#AA6644",orange:"#FF6644",yellow:"#FFDD66",green:"#448811",darkgreen:"#335500",lightgreen:"#88BB77",blue:"#8899DD",lightblue:"#BBDDEE",darkblue:"#666688",purple:"#665555",pink:"#997788"},arnecolors:{black:"#000000",white:"#FFFFFF",grey:"#9d9d9d",darkgrey:"#697175",lightgrey:"#cccccc",gray:"#9d9d9d",darkgray:"#697175",lightgray:"#cccccc",red:"#be2633",darkred:"#732930",lightred:"#e06f8b",brown:"#a46422",darkbrown:"#493c2b",lightbrown:"#eeb62f",orange:"#eb8931",yellow:"#f7e26b",green:"#44891a",darkgreen:"#2f484e",lightgreen:"#a3ce27",blue:"#1d57f7",lightblue:"#B2DCEF",darkblue:"#1B2632",purple:"#342a97",pink:"#de65e2"},famicom:{black:"#000000",white:"#ffffff",grey:"#7c7c7c",darkgrey:"#080808",lightgrey:"#bcbcbc",gray:"#7c7c7c",darkgray:"#080808",lightgray:"#bcbcbc",red:"#f83800",darkred:"#881400",lightred:"#f87858",brown:"#AC7C00",darkbrown:"#503000",lightbrown:"#FCE0A8",orange:"#FCA044",yellow:"#F8B800",green:"#00B800",darkgreen:"#005800",lightgreen:"#B8F8B8",blue:"#0058F8",lightblue:"#3CBCFC",darkblue:"#0000BC",purple:"#6644FC",pink:"#F878F8"},atari:{black:"#000000",white:"#FFFFFF",grey:"#909090",darkgrey:"#404040",lightgrey:"#b0b0b0",gray:"#909090",darkgray:"#404040",lightgray:"#b0b0b0",red:"#A03C50",darkred:"#700014",lightred:"#DC849C",brown:"#805020",darkbrown:"#703400",lightbrown:"#CB9870",orange:"#CCAC70",yellow:"#ECD09C",green:"#58B06C",darkgreen:"#006414",lightgreen:"#70C484",blue:"#1C3C88",lightblue:"#6888C8",darkblue:"#000088",purple:"#3C0080",pink:"#B484DC"},pastel:{black:"#000000",white:"#FFFFFF",grey:"#3e3e3e",darkgrey:"#313131",lightgrey:"#9cbcbc",gray:"#3e3e3e",darkgray:"#313131",lightgray:"#9cbcbc",red:"#f56ca2",darkred:"#a63577",lightred:"#ffa9cf",brown:"#b58c53",darkbrown:"#787562",lightbrown:"#B58C53",orange:"#EB792D",yellow:"#FFe15F",green:"#00FF4F",darkgreen:"#2b732c",lightgreen:"#97c04f",blue:"#0f88d3",lightblue:"#00fffe",darkblue:"#293a7b",purple:"#ff6554",pink:"#eb792d"},ega:{black:"#000000",white:"#ffffff",grey:"#555555",darkgrey:"#555555",lightgrey:"#aaaaaa",gray:"#555555",darkgray:"#555555",lightgray:"#aaaaaa",red:"#ff5555",darkred:"#aa0000",lightred:"#ff55ff",brown:"#aa5500",darkbrown:"#aa5500",lightbrown:"#ffff55",orange:"#ff5555",yellow:"#ffff55",green:"#00aa00",darkgreen:"#00aaaa",lightgreen:"#55ff55",blue:"#5555ff",lightblue:"#55ffff",darkblue:"#0000aa",purple:"#aa00aa",pink:"#ff55ff"},proteus_mellow:{black:"#3d2d2e",white:"#ddf1fc",grey:"#9fb2d4",darkgrey:"#7b8272",lightgrey:"#a4bfda",gray:"#9fb2d4",darkgray:"#7b8272",lightgray:"#a4bfda",red:"#9d5443",darkred:"#8c5b4a",lightred:"#94614c",brown:"#89a78d",darkbrown:"#829e88",lightbrown:"#aaae97",orange:"#d1ba86",yellow:"#d6cda2",green:"#75ac8d",darkgreen:"#8fa67f",lightgreen:"#8eb682",blue:"#88a3ce",lightblue:"#a5adb0",darkblue:"#5c6b8c",purple:"#d39fac",pink:"#c8ac9e"},proteus_night:{black:"#010912",white:"#fdeeec",grey:"#051d40",darkgrey:"#091842",lightgrey:"#062151",gray:"#051d40",darkgray:"#091842",lightgray:"#062151",red:"#ad4576",darkred:"#934765",lightred:"#ab6290",brown:"#61646b",darkbrown:"#3d2d2d",lightbrown:"#8393a0",orange:"#0a2227",yellow:"#0a2541",green:"#75ac8d",darkgreen:"#0a2434",lightgreen:"#061f2e",blue:"#0b2c79",lightblue:"#809ccb",darkblue:"#08153b",purple:"#666a87",pink:"#754b4d"},proteus_rich:{black:"#6f686f",white:"#d1b1e2",grey:"#b9aac1",darkgrey:"#8e8b84",lightgrey:"#c7b5cd",gray:"#b9aac1",darkgray:"#8e8b84",lightgray:"#c7b5cd",red:"#a11f4f",darkred:"#934765",lightred:"#c998ad",brown:"#89867d",darkbrown:"#797f75",lightbrown:"#ab9997",orange:"#ce8c5c",yellow:"#f0d959",green:"#75bc54",darkgreen:"#599d79",lightgreen:"#90cf5c",blue:"#8fd0ec",lightblue:"#bcdce7",darkblue:"#0b2c70",purple:"#9b377f",pink:"#cd88e5"},amstrad:{black:"#000000",white:"#ffffff",grey:"#7f7f7f",darkgrey:"#636363",lightgrey:"#afafaf",gray:"#7f7f7f",darkgray:"#636363",lightgray:"#afafaf",red:"#ff0000",darkred:"#7f0000",lightred:"#ff7f7f",brown:"#ff7f00",darkbrown:"#7f7f00",lightbrown:"#ffff00",orange:"#ff007f",yellow:"#ffff7f",green:"#01ff00",darkgreen:"#007f00",lightgreen:"#7fff7f",blue:"#0000ff",lightblue:"#7f7fff",darkblue:"#00007f",purple:"#7f007f",pink:"#ff7fff"},c64:{black:"#000000",white:"#ffffff",grey:"#6C6C6C",darkgrey:"#444444",lightgrey:"#959595",gray:"#6C6C6C",darkgray:"#444444",lightgray:"#959595",red:"#68372B",darkred:"#3f1e17",lightred:"#9A6759",brown:"#433900",darkbrown:"#221c02",lightbrown:"#6d5c0d",orange:"#6F4F25",yellow:"#B8C76F",green:"#588D43",darkgreen:"#345129",lightgreen:"#9AD284",blue:"#6C5EB5",lightblue:"#70A4B2",darkblue:"#352879",purple:"#6F3D86",pink:"#b044ac"},whitingjp:{black:"#202527",white:"#eff8fd",grey:"#7b7680",darkgrey:"#3c3b44",lightgrey:"#bed0d7",gray:"#7b7680",darkgray:"#3c3b44",lightgray:"#bed0d7",red:"#bd194b",darkred:"#6b1334",lightred:"#ef2358",brown:"#b52e1c",darkbrown:"#681c12",lightbrown:"#e87b45",orange:"#ff8c10",yellow:"#fbd524",green:"#36bc3c",darkgreen:"#317610",lightgreen:"#8ce062",blue:"#3f62c6",lightblue:"#57bbe0",darkblue:"#2c2fa0",purple:"#7037d9",pink:"#ec2b8f"}};var reg_color_names=/(black|white|darkgray|lightgray|gray|grey|darkgrey|lightgrey|red|darkred|lightred|brown|darkbrown|lightbrown|orange|yellow|green|darkgreen|lightgreen|blue|lightblue|darkblue|purple|pink|transparent)\s*/,reg_color=/(black|white|gray|darkgray|lightgray|grey|darkgrey|lightgrey|red|darkred|lightred|brown|darkbrown|lightbrown|orange|yellow|green|darkgreen|lightgreen|blue|lightblue|darkblue|purple|pink|transparent|#(?:[0-9a-f]{2}){3,4}|#(?:[0-9a-f]{3}))\s*/;</script> <script>function createSprite(e,t,i,l){void 0===i&&(i=[state.bgcolor,state.fgcolor]);var h=makeSpriteCanvas(e),o=h.getContext("2d");o.clearRect(0,0,cellwidth,cellheight);var a=t[0].length,r=t.length,c=~~(cellwidth/(a+(0|l))),s=~~(cellheight/(r+(0|l))),n=s;"scanline"in state.metadata&&(n=Math.ceil(s/2)),o.fillStyle=state.fgcolor;for(var d=0;d<a;d++)for(var g=0;g<r;g++){var f=t[d][g];if(f>=0){var m=d*c|0,w=g*s|0;o.fillStyle=i[f],o.fillRect(w,m,c,n)}}return h}function drawTextWithCustomFont(e,t,i,l){t.fillStyle=state.fgcolor,t.textBaseline="middle",t.textAlign="center";var h=1;void 0!==state.metadata.font_size&&(h=parseFloat(state.metadata.font_size)),t.font=cellheight*h+"px PuzzleCustomFont",t.fillText(e,i,l)}function regenText(e,t){textImages={};for(var i in font)font.hasOwnProperty(i)&&(textImages[i]=createSprite("char"+i,font[i],void 0,1))}function regenSpriteImages(){if(textMode)return void regenText();if(levelEditorOpened&&(textImages.s=createSprite("chars",font.s,void 0)),0!==state.levels.length){spriteimages=[];for(var e=0;e<sprites.length;e++)void 0!=sprites[e]&&(spriteimages[e]=createSprite(e.toString(),sprites[e].dat,sprites[e].colors));canOpenEditor&&generateGlyphImages()}}function makeSpriteCanvas(e){var t;return e in canvasdict?t=canvasdict[e]:(t=document.createElement("canvas"),canvasdict[e]=t),t.width=cellwidth,t.height=cellheight,t}function generateGlyphImages(){if(0!==cellwidth&&0!==cellheight){glyphImagesCorrespondance=[],glyphImages=[];for(var e in state.glyphDict)if(1==e.length&&state.glyphDict.hasOwnProperty(e)){var t=state.glyphDict[e],i=makeSpriteCanvas("C"+e),l=i.getContext("2d");glyphImagesCorrespondance.push(e);for(var h=0;h<t.length;h++){var o=t[h];-1!==o&&l.drawImage(spriteimages[o],0,0)}glyphImages.push(i)}glyphHighlight=makeSpriteCanvas("highlight");var l=glyphHighlight.getContext("2d");l.fillStyle="#FFFFFF",l.fillRect(0,0,cellwidth,1),l.fillRect(0,0,1,cellheight),l.fillRect(0,cellheight-1,cellwidth,1),l.fillRect(cellwidth-1,0,1,cellheight),glyphPrintButton=textImages.s,glyphHighlightResize=makeSpriteCanvas("highlightresize");var l=glyphHighlightResize.getContext("2d");l.fillStyle="#FFFFFF";var a=cellwidth/2-1|0,r=cellwidth-a-1-a,c=cellheight/2-1|0,s=cellheight-c-1-a;l.fillRect(a,0,r,cellheight),l.fillRect(0,c,cellwidth,s),glyphMouseOver=makeSpriteCanvas();var l=glyphMouseOver.getContext("2d");l.fillStyle="yellow",l.fillRect(0,0,cellwidth,2),l.fillRect(0,0,2,cellheight),l.fillRect(0,cellheight-2,cellwidth,2),l.fillRect(cellwidth-2,0,2,cellheight)}}function glyphCount(){var e=0;for(var t in state.glyphDict)1==t.length&&state.glyphDict.hasOwnProperty(t)&&e++;return e}function initSmoothCamera(){if(void 0!==state&&void 0!==state.metadata.smoothscreen){screenwidth=state.metadata.smoothscreen.screenSize.width,screenheight=state.metadata.smoothscreen.screenSize.height;var e=state.metadata.smoothscreen.boundarySize,t=state.metadata.smoothscreen.flick,i=getPlayerPositions();if(i.length>0){var l={x:i[0]/level.height|0,y:i[0]%level.height|0};cameraPositionTarget={x:t?getFlickCameraPosition(l.x,level.width,screenwidth,e.width):getCameraPosition(l.x,level.width,screenwidth),y:t?getFlickCameraPosition(l.y,level.height,screenheight,e.height):getCameraPosition(l.y,level.height,screenheight)},cameraPosition.x=cameraPositionTarget.x,cameraPosition.y=cameraPositionTarget.y}}}function getCameraPosition(e,t,i){return Math.min(Math.max(e,Math.floor(i/2)),t-Math.ceil(i/2))}function getFlickCameraPosition(e,t,i,l){var h=Math.floor(i/2)-Math.floor(l/2),o=e-h,a=Math.floor(o/l),r=Math.floor((t-Math.ceil(i/2)-Math.floor(l/2)-h)/l);return Math.min(Math.max(a,0),r)*l+Math.floor(i/2)}function updateCameraPositionTarget(){var e=state.metadata.smoothscreen,t=getPlayerPositions();if(e&&0!==t.length){var i={x:t[0]/level.height|0,y:t[0]%level.height|0};["x","y"].forEach(function(t){var l="x"===t?screenwidth:screenheight,h="x"===t?"width":"height",o=level[h],a=e.boundarySize[h],r=i[t]-cameraPositionTarget[t],c=Math.sign(r),s=c>0?Math.ceil(a/2):-(Math.floor(a/2)+1);Math.abs(r)-Math.abs(s)>=0&&(cameraPositionTarget[t]=e.flick?getFlickCameraPosition(i[t],o,l,a):getCameraPosition(i[t]-s+c,o,l))})}}function redraw(){if(0!==cellwidth&&0!==cellheight)if(void 0===spriteimages&&regenSpriteImages(),textMode)if(ctx.fillStyle=state.bgcolor,ctx.fillRect(0,0,canvas.width,canvas.height),void 0!==state.metadata.custom_font&&loadedCustomFont)for(var e=0;e<titleHeight;e++){var t=titleImage[e];drawTextWithCustomFont(t,ctx,xoffset+titleWidth*cellwidth/2,yoffset+e*cellheight+cellheight/2)}else for(var e=0;e<titleWidth;e++)for(var i=0;i<titleHeight;i++){var l=titleImage[i].charAt(e);if(l in textImages){var h=textImages[l];ctx.drawImage(h,xoffset+e*cellwidth,yoffset+i*cellheight)}}else{ctx.fillStyle=state.bgcolor,ctx.fillRect(0,0,canvas.width,canvas.height);var o=0,a=screenwidth,r=0,c=screenheight,s={x:0,y:0};if(levelEditorOpened){var n=glyphCount();editorRowCount=Math.ceil(n/(screenwidth-1)),a-=2,c-=2+editorRowCount}else if(flickscreen){var d=getPlayerPositions();if(d.length>0){var g=d[0],f=g/level.height|0,m=g%level.height|0,w=f/screenwidth|0,v=m/screenheight|0;o=w*screenwidth,r=v*screenheight,a=Math.min(o+screenwidth,level.width),c=Math.min(r+screenheight,level.height),oldflickscreendat=[o,r,a,c]}else oldflickscreendat.length>0&&(o=oldflickscreendat[0],r=oldflickscreendat[1],a=oldflickscreendat[2],c=oldflickscreendat[3])}else if(zoomscreen){var d=getPlayerPositions();if(d.length>0){var g=d[0],f=g/level.height|0,m=g%level.height|0;o=Math.max(Math.min(f-(screenwidth/2|0),level.width-screenwidth),0),r=Math.max(Math.min(m-(screenheight/2|0),level.height-screenheight),0),a=Math.min(o+screenwidth,level.width),c=Math.min(r+screenheight,level.height),oldflickscreendat=[o,r,a,c]}else oldflickscreendat.length>0&&(o=oldflickscreendat[0],r=oldflickscreendat[1],a=oldflickscreendat[2],c=oldflickscreendat[3])}else smoothscreen&&(null!==cameraPositionTarget?(["x","y"].forEach(function(e){var t=cameraPositionTarget[e]-cameraPosition[e];if(0!==t){if(Math.abs(t)<.5/cellwidth)return void(cameraPosition[e]=cameraPositionTarget[e]);cameraPosition[e]+=t*state.metadata.smoothscreen.cameraSpeed,s[e]=cameraPosition[e]%1}}),o=Math.max(Math.min(Math.floor(cameraPosition.x)-Math.floor(screenwidth/2),level.width-screenwidth),0),r=Math.max(Math.min(Math.floor(cameraPosition.y)-Math.floor(screenheight/2),level.height-screenheight),0),a=Math.min(o+screenwidth,level.width),c=Math.min(r+screenheight,level.height),oldflickscreendat=[o,r,a,c]):oldflickscreendat.length>0&&(o=oldflickscreendat[0],r=oldflickscreendat[1],a=oldflickscreendat[2],c=oldflickscreendat[3]),ctx.save(),ctx.beginPath(),ctx.moveTo(xoffset,yoffset),ctx.lineTo(xoffset+(a-o)*cellwidth,yoffset),ctx.lineTo(xoffset+(a-o)*cellwidth,yoffset+(c-r)*cellwidth),ctx.lineTo(xoffset,yoffset+(c-r)*cellwidth),ctx.clip());screenOffsetX=o,screenOffsetY=r;for(var x=smoothscreen?1:0,e=Math.max(o-x,0);e<Math.min(a+x,level.width);e++)for(var i=Math.max(r-x,0);i<Math.min(c+x,level.height);i++)for(var y=i+e*level.height,u=level.getCellInto(y,_o12),p=0;p<state.objectCount;p++)if(0!=u.get(p)){var h=spriteimages[p];ctx.drawImage(h,Math.floor(xoffset+(e-o-s.x)*cellwidth),Math.floor(yoffset+(i-r-s.y)*cellheight))}smoothscreen&&(state.metadata.smoothscreen.debug&&drawSmoothScreenDebug(ctx),ctx.restore()),levelEditorOpened&&drawEditorIcons()}}function drawSmoothScreenDebug(e){e.save();var t=state.metadata.smoothscreen,i=t.boundarySize,l=getPlayerPositions();if(l.length>0){var h={x:l[0]/level.height|0,y:l[0]%level.height|0},o=h.x-cameraPosition.x,a=h.y-cameraPosition.y;e.fillStyle="#00ff00",e.beginPath(),e.arc(xoffset+(Math.floor(screenwidth/2)+o+.5)*cellwidth,yoffset+(Math.floor(screenheight/2)+a+.5)*cellheight,cellwidth/4,0,2*Math.PI),e.fill()}var r=cameraPositionTarget.x-cameraPosition.x,c=cameraPositionTarget.y-cameraPosition.y;e.fillStyle="#0000ff",e.beginPath(),e.arc(xoffset+(Math.floor(screenwidth/2)+r)*cellwidth,yoffset+(Math.floor(screenheight/2)+c)*cellheight,cellwidth/8,0,2*Math.PI),e.fill(),e.strokeStyle="#0000ff",e.lineWidth=cellwidth/16,e.strokeRect(xoffset+(Math.floor(screenwidth/2)+r-Math.floor(i.width/2))*cellwidth,yoffset+(Math.floor(screenheight/2)+c-Math.floor(i.height/2))*cellheight,i.width*cellwidth,i.height*cellheight),e.fillStyle="#ff0000",e.beginPath(),e.arc(xoffset+Math.floor(screenwidth/2)*cellwidth,yoffset+Math.floor(screenheight/2)*cellheight,cellwidth/4,0,2*Math.PI),e.fill(),e.strokeStyle="#ff0000",e.lineWidth=cellwidth/8,e.strokeRect(xoffset+(Math.floor(screenwidth/2)-Math.floor(i.width/2))*cellwidth,yoffset+(Math.floor(screenheight/2)-Math.floor(i.height/2))*cellheight,i.width*cellwidth,i.height*cellheight),e.restore()}function drawEditorIcons(){var e=(glyphImages.length,glyphImages.length),t=e-0;ctx.drawImage(glyphPrintButton,xoffset-cellwidth,yoffset-cellheight*(1+editorRowCount)),mouseCoordY===-1-editorRowCount&&-1===mouseCoordX&&ctx.drawImage(glyphMouseOver,xoffset-cellwidth,yoffset-cellheight*(1+editorRowCount));for(var i=editorRowCount-(-mouseCoordY-2)-1,l=mouseCoordX+(screenwidth-1)*i,h=0;h<t;h++){var o=0+h,a=glyphImages[o],r=h%(screenwidth-1),i=h/(screenwidth-1)|0;ctx.drawImage(a,xoffset+r*cellwidth,yoffset+i*cellheight-cellheight*(1+editorRowCount)),mouseCoordX>=0&&mouseCoordX<screenwidth-1&&l===h&&ctx.drawImage(glyphMouseOver,xoffset+r*cellwidth,yoffset+i*cellheight-cellheight*(1+editorRowCount)),h===glyphSelectedIndex&&ctx.drawImage(glyphHighlight,xoffset+r*cellwidth,yoffset+i*cellheight-cellheight*(1+editorRowCount))}mouseCoordX>=-1&&mouseCoordY>=-1&&mouseCoordX<screenwidth-1&&mouseCoordY<screenheight-1-editorRowCount&&(-1==mouseCoordX||-1==mouseCoordY||mouseCoordX==screenwidth-2||mouseCoordY===screenheight-2-editorRowCount?ctx.drawImage(glyphHighlightResize,xoffset+mouseCoordX*cellwidth,yoffset+mouseCoordY*cellheight):ctx.drawImage(glyphHighlight,xoffset+mouseCoordX*cellwidth,yoffset+mouseCoordY*cellheight))}function canvasResize(){if(canvas.width=canvas.parentNode.clientWidth,canvas.height=canvas.parentNode.clientHeight,screenwidth=level.width,screenheight=level.height,void 0!==state)if(flickscreen=void 0!==state.metadata.flickscreen,zoomscreen=void 0!==state.metadata.zoomscreen,smoothscreen=void 0!==state.metadata.smoothscreen,levelEditorOpened){screenwidth+=2;var e=glyphCount();editorRowCount=Math.ceil(e/(screenwidth-1)),screenheight+=2+editorRowCount}else flickscreen?(screenwidth=state.metadata.flickscreen[0],screenheight=state.metadata.flickscreen[1]):zoomscreen?(screenwidth=state.metadata.zoomscreen[0],screenheight=state.metadata.zoomscreen[1]):smoothscreen&&(screenwidth=state.metadata.smoothscreen.screenSize.width,screenheight=state.metadata.smoothscreen.screenSize.height);textMode&&(screenwidth=titleWidth,screenheight=titleHeight),cellwidth=canvas.width/screenwidth,cellheight=canvas.height/screenheight;var t=sprites[1].dat.length,i=sprites[1].dat.length;textMode&&(t=6,i=6),cellwidth=t*~~(cellwidth/t),cellheight=i*~~(cellheight/i),0!=cellwidth&&0!=cellheight||textMode||(cellwidth=t,cellheight=i,console.log("Resized below 1")),xoffset=0,yoffset=0,cellwidth>cellheight||textMode&&void 0!==state.metadata.custom_font&&loadedCustomFont?(cellwidth=cellheight,xoffset=(canvas.width-cellwidth*screenwidth)/2,yoffset=(canvas.height-cellheight*screenheight)/2):(cellheight=cellwidth,yoffset=(canvas.height-cellheight*screenheight)/2,xoffset=(canvas.width-cellwidth*screenwidth)/2),magnification=cellwidth/t*5|0,levelEditorOpened&&!textMode&&(xoffset+=cellwidth,yoffset+=cellheight*(1+editorRowCount)),cellwidth|=0,cellheight|=0,xoffset|=0,yoffset|=0,(oldcellwidth!=cellwidth||oldcellheight!=cellheight||oldtextmode!=textMode||oldfgcolor!=state.fgcolor||forceRegenImages)&&(forceRegenImages=!1,regenSpriteImages()),oldcellheight=cellheight,oldcellwidth=cellwidth,oldtextmode=textMode,oldfgcolor=state.fgcolor,redraw()}var spriteimages,glyphImagesCorrespondance,glyphImages,glyphHighlight,glyphHighlightResize,glyphPrintButton,glyphMouseOver,glyphSelectedIndex=0,editorRowCount=1,canvasdict={},canvas,ctx,x,y,cellwidth,cellheight,magnification,xoffset,yoffset;window.addEventListener("resize",canvasResize,!1),canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d"),x=0,y=0;var cameraPositionTarget=null,cameraPosition={x:0,y:0},lastDownTarget,oldcellwidth=0,oldcellheight=0,oldtextmode=-1,oldfgcolor=-1,forceRegenImages=!1;</script> <script>function unloadGame(){state=introstate,level=new Level(0,5,5,2,null,null),level.objects=new Int32Array(0),generateTitleScreen(),canvasResize(),redraw(),titleSelected=!0}function isContinueOptionSelected(){return void 0===state.metadata.continue_is_level_select&&0==titleSelection}function isNewGameOptionSelected(){return titleSelection==titleSelectOptions-1}function isLevelSelectOptionSelected(){return void 0!==state.metadata.level_select&&(void 0!==state.metadata.continue_is_level_select?0==titleSelection:1==titleSelection)}function generateTitleScreen(){if(tryLoadCustomFont(),titleMode=curlevel>0||null!==curlevelTarget?1:0,0===state.levels.length)return void(titleImage=intro_template);var e="PuzzleScript Game";if(void 0!==state.metadata.title&&(e=state.metadata.title),0===titleMode)titleSelectOptions=1,titleImage=deepClone(titleSelected?titletemplate_firstgo_selected:titletemplate_firstgo);else{var t=[0];titleSelectOptions=2,void 0!==state.metadata.level_select&&void 0===state.metadata.continue_is_level_select&&(titleSelectOptions++,t.push(1)),void 0!==state.metadata.settings&&(titleSelectOptions++,t.push(2)),t.push(3),titleImage=deepClone(titletemplate_empty);for(var a=0;a<titleSelectOptions;a++){var l=0;titleSelection==a&&(l=titleSelected?2:1);var n=0;2==titleSelectOptions&&1==a&&(n=1),titleImage[5+a+n]=deepClone(title_options[t[a]][l])}}var o="noaction"in state.metadata,i="noundo"in state.metadata,r="norestart"in state.metadata;titleImage[10]=".arrow keys to move...............",titleImage[11]=o?".X to select......................":" X to action......................",titleImage[12]=i&&r?"..................................":i?".R to restart.....................":r?".Z to undo........................":".Z to undo, R to restart..........",("mouse_left"in state.metadata||"mouse_drag"in state.metadata||"mouse_up"in state.metadata)&&(titleImage[10]="..................................",titleImage[11]=".MOUSE to interact................",titleImage[12]=".MMB to undo, R to restart........");for(var a=0;a<titleImage.length;a++)titleImage[a]=titleImage[a].replace(/\./g," ");for(var s=titleImage[0].length,c=wordwrap(e,titleImage[0].length),a=0;a<c.length;a++){var v=c[a],d=v.length,u=(s-d)/2|0,m=titleImage[1+a];titleImage[1+a]=m.slice(0,u)+v+m.slice(u+v.length)}if(void 0!==state.metadata.author)for(var g="by "+state.metadata.author,h=wordwrap(g,titleImage[0].length),a=0;a<h.length;a++){var f=h[a]+" ";f.length>s&&(f=f.slice(0,s));var m=titleImage[3+a];titleImage[3+a]=m.slice(0,s-f.length)+f}}function gotoLevelSelectScreen(){if(levelSelectScrollPos=0,titleSelected=!1,timer=0,quittingTitleScreen=!1,quittingMessageScreen=!1,messageselected=!1,titleMode=2,titleScreen=!0,textMode=!0,againing=!1,messagetext="",0==titleSelection)for(var e=0;e<state.sections.length;e++)if(state.sections[e].firstLevel>curlevel){titleSelection=Math.max(0,e-1);break}state.metadata=deepClone(state.default_metadata),twiddleMetadataExtras(),generateLevelSelectScreen(),redraw()}function generateLevelSelectScreen(){titleImage=["ESC: Back             Level Select","                                  "],amountOfLevelsOnScreen=9,titleSelectOptions=state.sections.length,titleSelection<levelSelectScrollPos?levelSelectScrollPos=titleSelection:titleSelection>=levelSelectScrollPos+amountOfLevelsOnScreen&&(levelSelectScrollPos=titleSelection-amountOfLevelsOnScreen+1);var e=titleSelection-levelSelectScrollPos;0==e&&(levelSelectScrollPos=Math.max(0,levelSelectScrollPos-1)),e==amountOfLevelsOnScreen-1&&(levelSelectScrollPos=Math.min(state.sections.length-amountOfLevelsOnScreen,levelSelectScrollPos+1)),0!=levelSelectScrollPos?titleImage.push("            [ PREV ]              "):titleImage.push("                                  ");var t=-1;if(void 0!==state.metadata.level_select_lock){for(var a=0,l=0;l<state.sections.length;l++)solvedSections.indexOf(state.sections[l].name)>=0?t=l:a++;void 0===state.metadata.level_select_unlocked_ahead?t+=1:t+=Number(state.metadata.level_select_unlocked_ahead)}for(var l=levelSelectScrollPos;l<levelSelectScrollPos+amountOfLevelsOnScreen&&!(l<0||l>=state.sections.length);l++){var n=state.sections[l],o=solvedSections.indexOf(n.name)>=0,i=l==titleSelection,r=t>=0&&l>t,s=n.name.substring(0,24);if(r){i&&titleSelected&&(titleSelected=!1,quittingTitleScreen=!1);var c=s.length;s="";for(var v=0;v<c;v++)s+="*"}var d="â";void 0!==state.metadata.level_select_solve_symbol&&(d=state.metadata.level_select_solve_symbol);var u=(o?d:" ")+" ";u+=(i?"#":" ")+" "+s;for(var v=s.length;v<25;v++)i&&titleSelected&&v!=s.length?u+="#":u+=" ";u+=(i?"#":" ")+"  ",titleImage.push(u)}levelSelectScrollPos!=titleSelectOptions-amountOfLevelsOnScreen&&titleSelectOptions-amountOfLevelsOnScreen>0?titleImage.push("            [ NEXT ]              "):titleImage.push("                                  ");for(var l=titleImage.length;l<13;l++)titleImage.push("                                  ")}function gotoSelectedLevel(){againing=!1,messagetext="",curlevel=state.sections[titleSelection].firstLevel,loadLevelFromStateOrTarget(),updateLocalStorage(),resetFlickDat(),canvasResize(),clearInputHistory()}function deepClone(e){if(!e)return e;var t,a=[Number,String,Boolean];if(a.forEach(function(a){e instanceof a&&(t=a(e))}),void 0===t)if("[object Array]"===Object.prototype.toString.call(e))t=[],e.forEach(function(e,a,l){t[a]=deepClone(e)});else if("object"==typeof e)if(e.nodeType&&"function"==typeof e.cloneNode)var t=e.cloneNode(!0);else if(e.prototype)t=e;else if(e instanceof Date)t=new Date(e);else{t={};for(var l in e)t[l]=deepClone(e[l])}else t=e;return t}function wordwrap(e,t){t=t||75;if(!e)return e;var a=".{1,"+t+"}(\\s|$)|.{"+t+"}|.+$";return e.match(RegExp(a,"g"))}function drawMessageScreen(){tryLoadCustomFont(),titleMode=0,textMode=!0,titleImage=deepClone("mouse_left"in state.metadata||"mouse_drag"in state.metadata||"mouse_up"in state.metadata?messagecontainer_template_mouse:messagecontainer_template);for(var e=0;e<titleImage.length;e++)titleImage[e]=titleImage[e].replace(/\./g," ");var t=titleImage[9],a=titleImage[10];titleImage[10]=t;var l,n=titleImage[0].length;if(""===messagetext){l=state.levels[curlevel].message.trim()}else l=messagetext;splitMessage=wordwrap(l,titleImage[0].length);var o=5-(splitMessage.length/2|0);o<0&&(o=0);for(var i=Math.min(splitMessage.length,12),e=0;e<i;e++){var r=splitMessage[e],s=o+e,c=r.length,v=(n-c)/2|0,d=titleImage[s];titleImage[s]=d.slice(0,v)+r+d.slice(v+r.length)}var u=10;i>=10&&(u=i<12?i+1:12),quittingMessageScreen?titleImage[u]=t:titleImage[u]=a,canvasResize()}function loadLevelFromLevelDat(e,t,a){if(null==a&&(a=(Math.random()+Date.now()).toString()),loadedLevelSeed=a,RandomGen=new RNG(loadedLevelSeed),forceRegenImages=!0,titleScreen=!1,titleMode=curlevel>0||null!==curlevelTarget?1:0,titleSelection=0,titleSelected=!1,e.metadata=deepClone(e.default_metadata),againing=!1,void 0===t)return consolePrint("Trying to access a level that doesn't exist.",!0),void goToTitleScreen();void 0===t.message?(titleMode=0,textMode=!1,level=t.clone(),RebuildLevelArrays(),void 0!==e&&(void 0!==e.metadata.flickscreen?oldflickscreendat=[0,0,Math.min(e.metadata.flickscreen[0],level.width),Math.min(e.metadata.flickscreen[1],level.height)]:void 0!==e.metadata.zoomscreen?oldflickscreendat=[0,0,Math.min(e.metadata.zoomscreen[0],level.width),Math.min(e.metadata.zoomscreen[1],level.height)]:void 0!==e.metadata.smoothscreen&&(oldflickscreendat=[0,0,Math.min(e.metadata.smoothscreen.screenSize.width,level.width),Math.min(e.metadata.smoothscreen.screenSize.height,level.height)])),initSmoothCamera(),backups=[],restartTarget=backupLevel(),keybuffer=[],"run_rules_on_level_start"in e.metadata&&processInput(-1,!0)):(tryPlayShowMessageSound(),drawMessageScreen(),canvasResize()),clearInputHistory()}function loadLevelFromStateTarget(e,t,a,l){var n=a;curlevel=t,curlevelTarget=a,void 0===n.message&&tryPlayStartLevelSound(),loadLevelFromLevelDat(e,e.levels[t],l),restoreLevel(a,!0),restartTarget=a}function loadLevelFromState(e,t,a){var l=e.levels[t];curlevel=t,curlevelTarget=null,void 0!==l&&void 0===l.message&&tryPlayStartLevelSound(),loadLevelFromLevelDat(e,l,a)}function tryLoadCustomFont(){if(null!=state&&null!=state.metadata&&void 0!=state.metadata.custom_font&&!loadedCustomFont){new FontFace("PuzzleCustomFont","url("+state.metadata.custom_font+")").load().then(function(e){document.fonts.add(e),loadedCustomFont=!0,canvasResize(),redraw()}).catch(function(e){alert("Unable to load font!")})}}function tryPlaySimpleSound(e){if(void 0!==state.sfx_Events[e]){var t=state.sfx_Events[e];playSound(t)}}function tryPlayTitleSound(){tryPlaySimpleSound("titlescreen")}function tryPlayStartGameSound(){tryPlaySimpleSound("startgame")}function tryPlayEndGameSound(){tryPlaySimpleSound("endgame")}function tryPlayCancelSound(){tryPlaySimpleSound("cancel")}function tryPlayStartLevelSound(){tryPlaySimpleSound("startlevel")}function tryPlayEndLevelSound(){tryPlaySimpleSound("endlevel")}function tryPlayUndoSound(){tryPlaySimpleSound("undo")}function tryPlayRestartSound(){tryPlaySimpleSound("restart")}function tryPlayShowMessageSound(){tryPlaySimpleSound("showmessage")}function tryPlayCloseMessageSound(){tryPlaySimpleSound("closemessage")}function backupLevel(){var e={dat:new Int32Array(level.objects),width:level.width,height:level.height,oldflickscreendat:oldflickscreendat.concat([]),cameraPositionTarget:Object.assign({},cameraPositionTarget)};if(void 0!==state.metadata.runtime_metadata_twiddling){var t=deepClone(state.metadata);delete t.custom_font,e.metadata=t}return e}function level4Serialization(){return{dat:Array.from(level.objects),width:level.width,height:level.height,oldflickscreendat:oldflickscreendat.concat([]),cameraPositionTarget:Object.assign({},cameraPositionTarget)}}function tryDeactivateYoutube(){var e=document.getElementById("youtubeFrame");e&&document.body.removeChild(e)}function tryActivateYoutube(){if(!document.getElementById("youtubeFrame")&&canYoutube&&"youtube"in state.metadata){var e=state.metadata.youtube,t="https://www.youtube.com/embed/"+e+"?autoplay=1&loop=1&playlist="+e;ifrm=document.createElement("IFRAME"),ifrm.setAttribute("src",t),ifrm.setAttribute("id","youtubeFrame"),ifrm.style.visibility="hidden",ifrm.style.width="500px",ifrm.style.height="500px",ifrm.style.position="absolute",ifrm.style.top="-1000px",ifrm.style.left="-1000px",document.body.appendChild(ifrm)}}function setGameState(e,t,a){oldflickscreendat=[],timer=0,autotick=0,winning=!1,againing=!1,messageselected=!1,STRIDE_MOV=e.STRIDE_MOV,STRIDE_OBJ=e.STRIDE_OBJ,sfxCreateMask=new BitVec(STRIDE_OBJ),sfxDestroyMask=new BitVec(STRIDE_OBJ),void 0===t&&(t=["restart"]),(0===state.levels.length||0===e.levels.length)&&t.length>0&&"rebuild"===t[0]&&(t=["restart"]),void 0===a&&(a=null),RandomGen=new RNG(a),state=e,"rebuild"!==t[0]&&(backups=[]),sprites=[];for(var l in state.objects)if(state.objects.hasOwnProperty(l)){var n=state.objects[l],o={colors:n.colors,dat:n.spritematrix};sprites[n.id]=o}switch(void 0!==state.metadata.realtime_interval?(autotick=0,autotickinterval=1e3*state.metadata.realtime_interval):(autotick=0,autotickinterval=0),void 0!==state.metadata.key_repeat_interval?repeatinterval=1e3*state.metadata.key_repeat_interval:repeatinterval=150,void 0!==state.metadata.again_interval?againinterval=1e3*state.metadata.again_interval:againinterval=150,throttle_movement&&0===autotickinterval&&logWarning("throttle_movement is designed for use in conjunction with realtime_interval. Using it in other situations makes games gross and unresponsive, broadly speaking.  Please don't."),norepeat_action=void 0!==state.metadata.norepeat_action,t[0]){case"restart":if(1==restarting){logWarning('A "restart" command is being triggered in the "run_rules_on_level_start" section of level creation, which would cause an infinite loop if it was actually triggered, but it\'s being ignored, so it\'s not.');break}winning=!1,timer=0,titleScreen=!0,tryPlayTitleSound(),textMode=!0,titleSelection=0,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,(curlevel>0||null!==curlevelTarget)&&(titleMode=1),generateTitleScreen();break;case"rebuild":break;case"loadFirstNonMessageLevel":for(var i=0;i<state.levels.length;i++)if(!state.levels[i].hasOwnProperty("message")){var r=i;curlevel=i,winning=!1,timer=0,titleScreen=!1,textMode=!1,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,loadLevelFromState(state,r,a);break}break;case"loadLevel":var r=t[1];curlevel=i,winning=!1,timer=0,titleScreen=!1,textMode=!1,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,loadLevelFromState(state,r,a);break;case"levelline":for(var s=t[1],i=state.levels.length-1;i>=0;i--){if(state.levels[i].lineNumber<=s+1){curlevel=i,winning=!1,timer=0,titleScreen=!1,textMode=!1,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,loadLevelFromState(state,i);break}}}"rebuild"!==t[0]&&clearInputHistory(),canvasResize(),0==state.sounds.length&&null==state.metadata.youtube?killAudioButton():showAudioButton()}function RebuildLevelArrays(){level.movements=new Int32Array(level.n_tiles*STRIDE_MOV),level.rigidMovementAppliedMask=[],level.rigidGroupIndexMask=[],level.rowCellContents=[],level.colCellContents=[],level.mapCellContents=new BitVec(STRIDE_OBJ),_movementVecs=[new BitVec(STRIDE_MOV),new BitVec(STRIDE_MOV),new BitVec(STRIDE_MOV)],_o1=new BitVec(STRIDE_OBJ),_o2=new BitVec(STRIDE_OBJ),_o2_5=new BitVec(STRIDE_OBJ),_o3=new BitVec(STRIDE_OBJ),_o4=new BitVec(STRIDE_OBJ),_o5=new BitVec(STRIDE_OBJ),_o6=new BitVec(STRIDE_OBJ),_o7=new BitVec(STRIDE_OBJ),_o8=new BitVec(STRIDE_OBJ),_o9=new BitVec(STRIDE_OBJ),_o10=new BitVec(STRIDE_OBJ),_o11=new BitVec(STRIDE_OBJ),_o12=new BitVec(STRIDE_OBJ),_m1=new BitVec(STRIDE_MOV),_m2=new BitVec(STRIDE_MOV),_m3=new BitVec(STRIDE_MOV);for(var e=0;e<level.height;e++)level.rowCellContents[e]=new BitVec(STRIDE_OBJ);for(var e=0;e<level.width;e++)level.colCellContents[e]=new BitVec(STRIDE_OBJ);for(var e=0;e<level.n_tiles;e++)level.rigidMovementAppliedMask[e]=new BitVec(STRIDE_MOV),level.rigidGroupIndexMask[e]=new BitVec(STRIDE_MOV)}function restoreLevel(e,t){if(oldflickscreendat=e.oldflickscreendat.concat([]),level.objects=new Int32Array(e.dat),level.width!==e.width||level.height!==e.height)level.width=e.width,level.height=e.height,level.n_tiles=e.width*e.height,RebuildLevelArrays();else{for(var a=0;a<level.n_tiles;a++)level.movements[a]=0,level.rigidMovementAppliedMask[a]=0,level.rigidGroupIndexMask[a]=0;for(var a=0;a<level.height;a++){level.rowCellContents[a].setZero()}for(var a=0;a<level.width;a++){level.colCellContents[a].setZero()}}e.cameraPositionTarget&&(cameraPositionTarget=Object.assign({},e.cameraPositionTarget),t&&(cameraPosition=Object.assign({},cameraPositionTarget))),void 0!==state.metadata.runtime_metadata_twiddling&&(state.metadata=deepClone(e.metadata),twiddleMetadataExtras()),againing=!1,level.commandQueue=[],level.commandQueueSourceRules=[]}function DoRestart(e){!0!==restarting&&(!0!==e&&"norestart"in state.metadata||(restarting=!0,!1===e&&backups.push(backupLevel()),verbose_logging&&consolePrint("--- restarting ---",!0),restoreLevel(restartTarget,!0),tryPlayRestartSound(),"run_rules_on_level_start"in state.metadata&&processInput(-1,!0),twiddleMetadataExtras(),level.commandQueue=[],level.commandQueueSourceRules=[],restarting=!1))}function backupDiffers(){if(0==backups.length)return!0;for(var e=backups[backups.length-1],t=0;t<level.objects.length;t++)if(level.objects[t]!==e.dat[t])return!0;return!1}function DoUndo(e,t){if(levelEditorOpened||!("noundo"in state.metadata)||!0===e){if(verbose_logging&&consolePrint("--- undoing ---",!0),t)for(;0==backupDiffers();)backups.pop();if(backups.length>0){restoreLevel(backups[backups.length-1]),backups=backups.splice(0,backups.length-1),e||tryPlayUndoSound()}}}function getPlayerPositions(){var e=[],t=state.playerMask;for(i=0;i<level.n_tiles;i++)level.getCellInto(i,_o11),t.anyBitsInCommon(_o11)&&e.push(i);return e}function getLayersOfMask(e){for(var t=[],a=0;a<state.objectCount;a++)if(e.get(a)){var l=state.idDict[a],n=state.objects[l];t.push(n.layer)}return t}function moveEntitiesAtIndex(e,t,a){var l=level.getCell(e);l.iand(t);for(var n=getLayersOfMask(l),o=level.getMovements(e),i=0;i<n.length;i++)o.ishiftor(a,5*n[i]);level.setMovements(e,o)}function startMovement(e){for(var t=getPlayerPositions(),a=0;a<t.length;a++){moveEntitiesAtIndex(t[a],state.playerMask,e)}return t}function repositionEntitiesOnLayer(e,t,a){var l=dirMasksDelta[a],n=l[0],o=l[1],i=e/level.height|0,r=e%level.height,s=level.width-1,c=level.height-1;if(0===i&&n<0||i===s&&n>0||0===r&&o<0||r===c&&o>0)return!1;var v=e+l[1]+l[0]*level.height,d=state.layerMasks[t],u=level.getCellInto(v,_o7),m=level.getCellInto(e,_o8);if(d.anyBitsInCommon(u)&&16!=a)return!1;for(var g=0;g<state.sfx_MovementMasks.length;g++){var h=state.sfx_MovementMasks[g];if(h.objectMask.anyBitsInCommon(m)){var f=level.getMovements(e),p=h.directionMask;f.anyBitsInCommon(p)&&-1===seedsToPlay_CanMove.indexOf(h.seed)&&seedsToPlay_CanMove.push(h.seed)}}var S=m.clone();m.iclear(d),S.iand(d),u.ior(S),level.setCell(e,m),level.setCell(v,u);var _=v/level.height|0,y=v%level.height;return level.colCellContents[_].ior(S),level.rowCellContents[y].ior(S),level.mapCellContents.ior(S),!0}function repositionEntitiesAtCell(e){var t=level.getMovements(e);if(t.iszero())return!1;for(var a=!1,l=0;l<level.layerCount;l++){var n=t.getshiftor(31,5*l);if(0!==n){repositionEntitiesOnLayer(e,l,n)&&(t.ishiftclear(n,5*l),a=!0)}}return level.setMovements(e,t),a}function Level(e,t,a,l,n,o){this.lineNumber=e,this.width=t,this.height=a,this.n_tiles=t*a,this.objects=n,this.section=o,this.layerCount=l,this.commandQueue=[],this.commandQueueSourceRules=[]}function BitVec(e){return this.data=new Int32Array(e),this}function Rule(e){this.direction=e[0],this.patterns=e[1],this.hasReplacements=e[2],this.lineNumber=e[3],this.isEllipsis=e[4],this.groupNumber=e[5],this.isRigid=e[6],this.commands=e[7],this.isRandom=e[8],this.cellRowMasks=e[9],this.isGlobal=e[10],this.cellRowMatches=[];for(var t=0;t<this.patterns.length;t++)this.cellRowMatches.push(this.generateCellRowMatchesFunction(this.patterns[t],this.isEllipsis[t]))}function CellPattern(e){this.objectsPresent=e[0],this.objectsMissing=e[1],this.anyObjectsPresent=e[2],this.movementsPresent=e[3],this.movementsMissing=e[4],this.matches=this.generateMatchFunction(),this.replacement=e[5]}function CellReplacement(e){this.objectsClear=e[0],this.objectsSet=e[1],this.movementsClear=e[2],this.movementsSet=e[3],this.movementsLayerMask=e[4],this.randomEntityMask=e[5],this.randomDirMask=e[6]}function DoesCellRowMatchWildCard(e,t,a,l,n){void 0===n&&(n=0);var o=t[0];if(o.matches(a))for(var i=dirMasksDelta[e],r=i[0]*level.height,s=i[1],c=a,v=1;v<t.length;v+=1){c=c+s+r;var o=t[v];if(o===ellipsisPattern){for(var d=n;d<l;d++){var u=c;u=(u+(s+r)*d+level.n_tiles)%level.n_tiles;for(var m=v+1;m<t.length&&(o=t[m],o.matches(u));m++)u=u+s+r;if(m>=t.length)return!0}break}if(!o.matches(c))break}return!1}function DoesCellRowMatch(e,t,a,l){var n=t[0];if(n.matches(a)){for(var o=dirMasksDelta[e],i=o[0]*level.height,r=o[1],s=t.length,c=a,v=1;v<s&&(c=c+r+i,n=t[v],n===ellipsisPattern&&(c+=(r+i)*l),n.matches(c));v++);if(v>=t.length)return!0}return!1}function matchCellRow(e,t,a,l,n){var o=[];if(!l.bitsSetInArray(level.mapCellContents.data))return o;var i,r,s,c;if(n||void 0===state.metadata.local_radius)i=0,r=level.width,s=0,c=level.height;else{var v=parseInt(state.metadata.local_radius);i=Math.max(0,(playerPositions[0]/level.height|0)-v),r=Math.min(level.width,(playerPositions[0]/level.height|0)+v+1),s=Math.max(0,playerPositions[0]%level.height-v),c=Math.min(level.height,playerPositions[0]%level.height+v+1)}var d=a.length;switch(e){case 1:s+=d-1;break;case 2:c-=d-1;break;case 4:i+=d-1;break;case 8:r-=d-1;break;default:window.console.log("EEEP "+e)}if(e>2){for(var u=s;u<c;u++)if(l.bitsSetInArray(level.rowCellContents[u].data))for(var m=i;m<r;m++){var g=m*level.height+u;t(a,g)&&o.push(g)}}else for(var m=i;m<r;m++)if(l.bitsSetInArray(level.colCellContents[m].data))for(var u=s;u<c;u++){var g=m*level.height+u;t(a,g)&&o.push(g)}return o}function matchCellRowWildCard(e,t,a,l){var n=[];if(!l.bitsSetInArray(level.mapCellContents.data))return n;var o=0,i=level.width,r=0,s=level.height,c=a.length-1;switch(e){case 1:r+=c-1;break;case 2:s-=c-1;break;case 4:o+=c-1;break;case 8:i-=c-1;break;default:window.console.log("EEEP2 "+e)}if(e>2){for(var v=r;v<s;v++)if(l.bitsSetInArray(level.rowCellContents[v].data))for(var d=o;d<i;d++){var u,m=d*level.height+v;4===e?u=d-c+2:8===e?u=level.width-(d+c)+1:window.console.log("EEEP2 "+e),n.push.apply(n,t(a,m,u,0))}}else for(var d=o;d<i;d++)if(l.bitsSetInArray(level.colCellContents[d].data))for(var v=r;v<s;v++){var u,m=d*level.height+v;2===e?u=level.height-(v+c)+1:1===e?u=v-c+2:window.console.log("EEEP2 "+e),n.push.apply(n,t(a,m,u,0))}return n}function generateTuples(e){for(var t=[[]],a=0;a<e.length;a++){for(var l=e[a],n=[],o=0;o<l.length;o++)for(var i=l[o],r=0;r<t.length;r++){var s=t[r],c=s.concat([i]);n.push(c)}t=n}return t}function commitPreservationState(e){var t={ruleGroupIndex:e,objects:new Int32Array(level.objects),movements:new Int32Array(level.movements),rigidGroupIndexMask:level.rigidGroupIndexMask.concat([]),rigidMovementAppliedMask:level.rigidMovementAppliedMask.concat([]),bannedGroup:level.bannedGroup.concat([]),commandQueue:level.commandQueue.concat([]),commandQueueSourceRules:level.commandQueueSourceRules.concat([])};return rigidBackups[e]=t,t}function restorePreservationState(e){level.objects=new Int32Array(e.objects),level.movements=new Int32Array(e.movements),level.rigidGroupIndexMask=e.rigidGroupIndexMask.concat([]),level.rigidMovementAppliedMask=e.rigidMovementAppliedMask.concat([]),level.commandQueue=e.commandQueue.concat([]),level.commandQueueSourceRules=e.commandQueueSourceRules.concat([]),sfxCreateMask.setZero(),sfxDestroyMask.setZero(),consolePrint("Rigid movement application failed, rolling back")}function twiddleMetadataExtras(){void 0!==state.metadata.realtime_interval?(autotick=0,autotickinterval=1e3*state.metadata.realtime_interval):(autotick=0,autotickinterval=0),void 0!==state.metadata.again_interval?againinterval=1e3*state.metadata.again_interval:againinterval=150,void 0!==state.metadata.key_repeat_interval?repeatinterval=1e3*state.metadata.key_repeat_interval:repeatinterval=150,"background_color"in state.metadata?state.bgcolor=colorToHex(colorPalette,state.metadata.background_color):state.bgcolor="#000000","text_color"in state.metadata?state.fgcolor=colorToHex(colorPalette,state.metadata.text_color):state.fgcolor="#FFFFFF"}function showTempMessage(){keybuffer=[],textMode=!0,titleScreen=!1,quittingMessageScreen=!1,messageselected=!1,tryPlayShowMessageSound(),drawMessageScreen(),canvasResize()}function applyRandomRuleGroup(e){for(var t=[],a=0;a<e.length;a++){var l=e[a],n=l.findMatches();if(n.length>0)for(var o=generateTuples(n),i=0;i<o.length;i++){var r=o[i];t.push([a,r])}}if(0===t.length)return!1;var s=t[Math.floor(RandomGen.uniform()*t.length)],a=s[0],l=e[a],c=dirMasksDelta[l.direction],r=s[1],v=l.applyAt(c,r,!1);return l.queueCommands(),v}function applyRuleGroup(e){if(e[0].isRandom)return applyRandomRuleGroup(e);for(var t=!1,a=!0,l=0;a;){if(++l>200){logErrorCacheable("Got caught looping lots in a rule group :O",e[0].lineNumber,!0);break}a=!1;for(var n=0;n<e.length;n++){a=e[n].tryApply()||a}a&&(t=!0)}return t}function applyRules(e,t,a,l){playerPositions=getPlayerPositions();for(var n=a>0,o=0,i=a;i<e.length;){if(l&&l[i]);else{var r=e[i];n=applyRuleGroup(r)||n}if(n&&void 0!==t[i]){if(i=t[i],n=!1,++o>200){var r=e[i];logErrorCacheable("got caught in an endless startloop...endloop vortex, escaping!",r[0].lineNumber,!0);break}}else if(++i===e.length&&n&&void 0!==t[i]&&(i=t[i],n=!1,++o>200)){var r=e[i];logErrorCacheable("got caught in an endless startloop...endloop vortex, escaping!",r[0].lineNumber,!0);break}}}function resolveMovements(e){for(var t=!0;t;){t=!1;for(var a=0;a<level.n_tiles;a++)t=repositionEntitiesAtCell(a)||t}for(var l=!1,a=0;a<level.n_tiles;a++){var n=level.getCellInto(a,_o6),o=level.getMovements(a);if(!o.iszero()){var i=level.rigidMovementAppliedMask[a];if(0!==i&&(o.iand(i),!o.iszero()))for(var r=0;r<level.layerCount;r++){var s=o.getshiftor(31,5*r);if(0!==s){var c=level.rigidGroupIndexMask[a],v=c.getshiftor(31,5*r);v--;var d=state.rigidGroupIndex_to_GroupIndex[v];level.bannedGroup[d]=!0,l=!0;break}}for(var r=0;r<state.sfx_MovementFailureMasks.length;r++){var u=state.sfx_MovementFailureMasks[r];if(u.objectMask.anyBitsInCommon(n)){var m=u.directionMask;o.anyBitsInCommon(m)&&-1===seedsToPlay_CantMove.indexOf(u.seed)&&seedsToPlay_CantMove.push(u.seed)}}}for(var r=0;r<STRIDE_MOV;r++)level.movements[r+a*STRIDE_MOV]=0;level.rigidGroupIndexMask[a]=0,level.rigidMovementAppliedMask[a]=0}return l}function calculateRowColMasks(){for(var e=0;e<level.mapCellContents.length;e++)level.mapCellContents[e]=0;for(var e=0;e<level.width;e++){level.colCellContents[e].setZero()}for(var e=0;e<level.height;e++){level.rowCellContents[e].setZero()}for(var e=0;e<level.width;e++)for(var t=0;t<level.height;t++){var a=t+e*level.height,l=level.getCellInto(a,_o9);level.mapCellContents.ior(l),level.rowCellContents[t].ior(l),level.colCellContents[e].ior(l)}}function processInput(e,t,a,l){if(againing=!1,verbose_logging&&(-1===e?consolePrint("Turn starts with no input."):(consolePrint("======================="),consolePrint("Turn starts with input of "+["up","left","down","right","action","mouse"][e]+"."))),void 0==l&&(l=backupLevel()),playerPositions=getPlayerPositions(),playerPositionsAtTurnStart=getPlayerPositions(),e<=5){if(e>=0&&e<=4){switch(e){case 0:e=parseInt("00001",2);break;case 1:e=parseInt("00100",2);break;case 2:e=parseInt("00010",2);break;case 3:e=parseInt("01000",2);break;case 4:e=parseInt("10000",2)}playerPositions=startMovement(e)}var n=0;level.bannedGroup=[],rigidBackups=[],level.commandQueue=[],level.commandQueueSourceRules=[];var o=0,i=!1,r=commitPreservationState();sfxCreateMask.setZero(),sfxDestroyMask.setZero(),seedsToPlay_CanMove=[],seedsToPlay_CantMove=[],calculateRowColMasks();do{i=!1,n++,verbose_logging&&consolePrint("applying rules"),applyRules(state.rules,state.loopPoint,o,level.bannedGroup);resolveMovements()?(i=!0,restorePreservationState(r),o=0):(verbose_logging&&consolePrint("applying late rules"),applyRules(state.lateRules,state.lateLoopPoint,0),o=0)}while(n<250&&i);if(n>=250)return consolePrint("looped through 250 times, gave up. Too many loops!"),applyRules(state.lateRules,state.lateLoopPoint,0),o=0,backups.push(l),DoUndo(!0,!1),!1;if(playerPositionsAtTurnStart.length>0&&void 0!==state.metadata.require_player_movement&&e>=0){for(var s=!1,n=0;n<playerPositionsAtTurnStart.length;n++){var c=playerPositionsAtTurnStart[n],v=level.getCell(c);if(state.playerMask.bitsClearInArray(v.data)){s=!0;break}}if(!1===s)return verbose_logging&&(consolePrint("require_player_movement set, but no player movement detected, so cancelling turn."),consoleCacheDump()),backups.push(l),DoUndo(!0,!1),!1}if(level.commandQueue.indexOf("undo")>=0)return verbose_logging&&(consoleCacheDump(),consolePrint("UNDO command executed, undoing turn.",!0)),messagetext="",DoUndo(!0,!1),!0;if(level.commandQueue.indexOf("cancel")>=0){if(verbose_logging){consoleCacheDump();var d=level.commandQueueSourceRules[level.commandQueue.indexOf("cancel")];consolePrintFromRule("CANCEL command executed, cancelling turn.",d,!0)}return backups.push(l),messagetext="",DoUndo(!0,!1),tryPlayCancelSound(),!1}if(level.commandQueue.indexOf("restart")>=0){if(verbose_logging){var d=level.commandQueueSourceRules[level.commandQueue.indexOf("restart")];consolePrintFromRule("RESTART command executed, reverting to restart state.",d),consoleCacheDump()}return backups.push(l),messagetext="",DoRestart(!0),!0}if(level.commandQueue.indexOf("quit")>=0){if(verbose_logging){var d=level.commandQueueSourceRules[level.commandQueue.indexOf("restart")];consolePrintFromRule("QUIT command executed, exiting level.",d),consoleCacheDump()}return void 0!==state.metadata.level_select?gotoLevelSelectScreen():goToTitleScreen(),messagetext="",canvasResize(),!0}if(a&&level.commandQueue.indexOf("win")>=0)return!0;var u=!0;if(!winning&&level.commandQueue.indexOf("nosave")>=0){if(verbose_logging){var d=level.commandQueueSourceRules[level.commandQueue.indexOf("nosave")];consolePrintFromRule("NOSAVE command executed, not storing current state to undo queue.",d)}u=!1}for(var m=!1,n=0;n<level.objects.length;n++)if(level.objects[n]!==l.dat[n]){if(a)return verbose_logging&&consoleCacheDump(),backups.push(l),DoUndo(!0,!1),!0;-1!==e&&u&&backups.push(l),m=!0,updateCameraPositionTarget();break}if(a)return verbose_logging&&consoleCacheDump(),!1;for(var n=0;n<seedsToPlay_CantMove.length;n++)playSound(seedsToPlay_CantMove[n]);for(var n=0;n<seedsToPlay_CanMove.length;n++)playSound(seedsToPlay_CanMove[n]);for(var n=0;n<state.sfx_CreationMasks.length;n++){var g=state.sfx_CreationMasks[n];sfxCreateMask.anyBitsInCommon(g.objectMask)&&playSound(g.seed)}for(var n=0;n<state.sfx_DestructionMasks.length;n++){var g=state.sfx_DestructionMasks[n];sfxDestroyMask.anyBitsInCommon(g.objectMask)&&playSound(g.seed)}for(var n=0;n<level.commandQueue.length;n++){var h=level.commandQueue[n];"f"===h.charAt(1)&&tryPlaySimpleSound(h),!1===unitTesting?"message"===h&&showTempMessage():messagetext=""}if(!1===textMode&&(verbose_logging&&consolePrint("Checking win condition."),void 0===t&&(t=!1),checkWin(t)),!winning){if(level.commandQueue.indexOf("checkpoint")>=0){if(verbose_logging){var d=level.commandQueueSourceRules[level.commandQueue.indexOf("checkpoint")];consolePrintFromRule("CHECKPOINT command executed, saving current state to the restart state.",d)}restartTarget=level4Serialization(),hasUsedCheckpoint=!0;var f=JSON.stringify(restartTarget);localStorage[document.URL+"_checkpoint"]=f,localStorage[document.URL]=curlevel}if(level.commandQueue.indexOf("again")>=0&&m){var d=level.commandQueueSourceRules[level.commandQueue.indexOf("again")],p=verbose_logging,S=messagetext;verbose_logging=!1,processInput(-1,!0,!0)?(verbose_logging=p,verbose_logging&&consolePrintFromRule("AGAIN command executed, with changes detected - will execute another turn.",d),againing=!0,timer=0):(verbose_logging=p,verbose_logging&&consolePrintFromRule("AGAIN command not executed, it wouldn't make any changes.",d)),verbose_logging=p,messagetext=S}}level.commandQueue=[],level.commandQueueSourceRules=[]}return verbose_logging&&consoleCacheDump(),winning&&(againing=!1),m}function checkWin(e){if(levelEditorOpened&&(e=!0),level.commandQueue.indexOf("win")>=0)return consolePrint("Win Condition Satisfied"),void(e||DoWin());var t=!1;if(state.winconditions.length>0){for(var a=!0,l=0;l<state.winconditions.length;l++){var n=state.winconditions[l],o=n[1],i=n[2],r=!0;switch(n[0]){case-1:for(var s=0;s<level.n_tiles;s++){var c=level.getCellInto(s,_o10);if(!o.bitsClearInArray(c.data)&&!i.bitsClearInArray(c.data)){r=!1;break}}break;case 0:for(var v=!1,s=0;s<level.n_tiles;s++){var c=level.getCellInto(s,_o10);if(!o.bitsClearInArray(c.data)&&!i.bitsClearInArray(c.data)){v=!0;break}}!1===v&&(r=!1);break;case 1:for(var s=0;s<level.n_tiles;s++){var c=level.getCellInto(s,_o10);if(!o.bitsClearInArray(c.data)&&i.bitsClearInArray(c.data)){r=!1;break}}}!1===r&&(a=!1)}t=a}t&&(consolePrint("Win Condition Satisfied"),e||DoWin())}function DoWin(){if(!winning){if(againing=!1,tryPlayEndLevelSound(),unitTesting)return void nextLevel();winning=!0,timer=0}}function nextLevel(){if(againing=!1,messagetext="",state&&state.levels&&curlevel>state.levels.length&&(curlevel=state.levels.length-1),titleScreen&&titleMode<=1)isContinueOptionSelected()?loadLevelFromStateOrTarget():isNewGameOptionSelected()?(curlevel=0,curlevelTarget=null,
void 0===state.metadata.level_select&&clearLocalStorage(),loadLevelFromStateOrTarget()):isLevelSelectOptionSelected()&&(titleSelection=0,gotoLevelSelectScreen());else if(hasUsedCheckpoint&&(curlevelTarget=null,hasUsedCheckpoint=!1),curlevel<state.levels.length-1){var e=!1,t=state.levels[Number(curlevel)].section,a=state.levels[Number(curlevel)+1].section;a!=t&&(setSectionSolved(state.levels[Number(curlevel)].section),solvedSections.length==state.sections.length&&void 0!=state.winSection?curlevel=state.winSection.firstLevel-1:"__WIN__"==a&&(gotoLevelSelectScreen(),e=!0)),e||(curlevel++,textMode=!1,titleScreen=!1,quittingMessageScreen=!1,messageselected=!1,loadLevelFromStateOrTarget())}else solvedSections.length==state.sections.length?(void 0===state.metadata.level_select?(clearLocalStorage(),curlevel=0,curlevelTarget=null,goToTitleScreen()):gotoLevelSelectScreen(),tryPlayEndGameSound()):(null!=state.levels[Number(curlevel)].section&&setSectionSolved(state.levels[Number(curlevel)].section),gotoLevelSelectScreen());updateLocalStorage(),resetFlickDat(),canvasResize(),clearInputHistory()}function loadLevelFromStateOrTarget(){null!==curlevelTarget?loadLevelFromStateTarget(state,curlevel,curlevelTarget):loadLevelFromState(state,curlevel)}function goToTitleScreen(){againing=!1,messagetext="",titleScreen=!0,textMode=!0,doSetupTitleScreenLevelContinue(),state.metadata=deepClone(state.default_metadata),twiddleMetadataExtras(),generateTitleScreen()}function resetFlickDat(){void 0!==state&&void 0!==state.metadata.flickscreen&&(oldflickscreendat=[0,0,Math.min(state.metadata.flickscreen[0],level.width),Math.min(state.metadata.flickscreen[1],level.height)])}function updateLocalStorage(){try{if(window.localStorage)if(localStorage[document.URL]=curlevel,null!==curlevelTarget){restartTarget=level4Serialization();var e=JSON.stringify(restartTarget);localStorage[document.URL+"_checkpoint"]=e}else localStorage.removeItem(document.URL+"_checkpoint")}catch(e){}}function setSectionSolved(e){if(null!=e&&void 0!=e&&"__WIN__"!=e.name&&!(solvedSections.indexOf(e)>=0))try{window.localStorage&&(solvedSections.push(e),localStorage.setItem(document.URL+"_sections",JSON.stringify(solvedSections)))}catch(e){}}function clearLocalStorage(){curlevel=0,curlevelTarget=null,solvedSections=[];try{window.localStorage&&(localStorage.removeItem(document.URL),localStorage.removeItem(document.URL+"_checkpoint"),localStorage.removeItem(document.URL+"_sections"))}catch(e){}}var RandomGen=new RNG,intro_template=["..................................","..................................","..................................","......Puzzle Script Terminal......","..............v 1.6...............","..................................","..................................","..................................",".........insert cartridge.........","..................................","..................................","..................................",".................................."],messagecontainer_template=["..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..........X to continue...........","..................................",".................................."],messagecontainer_template_mouse=["..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","........Click to continue.........","..................................",".................................."],titletemplate_firstgo=["..................................","..................................","..................................","..................................","..................................","..................................","..........#.start game.#..........","..................................","..................................","..................................","..................................","..................................",".................................."],titletemplate_firstgo_selected=["..................................","..................................","..................................","..................................","..................................","..................................","###########.start game.###########","..................................","..................................","..................................","..................................","..................................",".................................."],titletemplate_empty=["..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................",".................................."],title_options=[[".............continue.............","...........#.continue.#...........","############.continue.############"],["...........level select...........",".........#.level select.#.........","##########.level select.##########"],[".............settings.............","...........#.settings.#...........","############.settings.############"],[".............new game.............","...........#.new game.#...........","############.new game.############"]],titleImage=[],titleWidth=titletemplate_empty[0].length,titleHeight=titletemplate_empty.length,textMode=!0,titleScreen=!0,titleMode=0,titleSelection=0,titleSelectOptions=2,titleSelected=!1,levelSelectScrollPos=0,introstate={title:"EMPTY GAME",attribution:"increpare",objectCount:2,metadata:[],levels:[],bgcolor:"#000000",fgcolor:"#FFFFFF"},state=introstate,splitMessage=[],loadedLevelSeed=0,sprites=[{color:"#423563",dat:[[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]]},{color:"#252342",dat:[[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],[0,1,1,1,0],[0,1,0,1,0]]}];loadedCustomFont=!1,tryLoadCustomFont(),generateTitleScreen(),titleMode>0&&(titleSelection=0),canvasResize();var backups=[],restartTarget,messagetext="",zoomscreen=!1,flickscreen=!1,smoothscreen=!1,screenwidth=0,screenheight=0,dirMasksDelta={1:[0,-1],2:[0,1],4:[-1,0],8:[1,0],15:[0,0],16:[0,0],3:[0,0]},dirMaskName={1:"up",2:"down",4:"left",8:"right",15:"?",16:"action",3:"no"},seedsToPlay_CanMove=[],seedsToPlay_CantMove=[];Level.prototype.clone=function(){var e=new Level(this.lineNumber,this.width,this.height,this.layerCount,null,this.section);return e.objects=new Int32Array(this.objects),e},Level.prototype.getCell=function(e){return new BitVec(this.objects.subarray(e*STRIDE_OBJ,e*STRIDE_OBJ+STRIDE_OBJ))},Level.prototype.getCellInto=function(e,t){for(var a=0;a<STRIDE_OBJ;a++)t.data[a]=this.objects[e*STRIDE_OBJ+a];return t},Level.prototype.setCell=function(e,t){for(var a=0;a<t.data.length;++a)this.objects[e*STRIDE_OBJ+a]=t.data[a]};var _movementVecs,_movementVecIndex=0;Level.prototype.getMovements=function(e){var t=_movementVecs[_movementVecIndex];_movementVecIndex=(_movementVecIndex+1)%_movementVecs.length;for(var a=0;a<STRIDE_MOV;a++)t.data[a]=this.movements[e*STRIDE_MOV+a];return t},Level.prototype.setMovements=function(e,t){for(var a=0;a<t.data.length;++a)this.movements[e*STRIDE_MOV+a]=t.data[a]};var ellipsisPattern=["ellipsis"];BitVec.prototype.cloneInto=function(e){for(var t=0;t<this.data.length;++t)e.data[t]=this.data[t];return e},BitVec.prototype.clone=function(){return new BitVec(this.data)},BitVec.prototype.iand=function(e){for(var t=0;t<this.data.length;++t)this.data[t]&=e.data[t]},BitVec.prototype.ior=function(e){for(var t=0;t<this.data.length;++t)this.data[t]|=e.data[t]},BitVec.prototype.iclear=function(e){for(var t=0;t<this.data.length;++t)this.data[t]&=~e.data[t]},BitVec.prototype.ibitset=function(e){this.data[e>>5]|=1<<(31&e)},BitVec.prototype.ibitclear=function(e){this.data[e>>5]&=~(1<<(31&e))},BitVec.prototype.get=function(e){return 0!=(this.data[e>>5]&1<<(31&e))},BitVec.prototype.getshiftor=function(e,t){var a=31&t,l=this.data[t>>5]>>>a;return a&&(l|=this.data[1+(t>>5)]<<32-a),l&e},BitVec.prototype.ishiftor=function(e,t){var a=31&t,l=e<<a;if(this.data[t>>5]|=l,a){var n=e>>32-a;this.data[1+(t>>5)]|=n}},BitVec.prototype.ishiftclear=function(e,t){var a=31&t,l=e<<a;if(this.data[t>>5]&=~l,a){var n=e>>32-(31&t);this.data[1+(t>>5)]&=~n}},BitVec.prototype.equals=function(e){if(this.data.length!==e.data.length)return!1;for(var t=0;t<this.data.length;++t)if(this.data[t]!==e.data[t])return!1;return!0},BitVec.prototype.setZero=function(){for(var e=0;e<this.data.length;++e)this.data[e]=0},BitVec.prototype.iszero=function(){for(var e=0;e<this.data.length;++e)if(this.data[e])return!1;return!0},BitVec.prototype.bitsSetInArray=function(e){for(var t=0;t<this.data.length;++t)if((this.data[t]&e[t])!==this.data[t])return!1;return!0},BitVec.prototype.bitsClearInArray=function(e){for(var t=0;t<this.data.length;++t)if(this.data[t]&e[t])return!1;return!0},BitVec.prototype.anyBitsInCommon=function(e){return!this.bitsClearInArray(e.data)},Rule.prototype.generateCellRowMatchesFunction=function(e,t){if(0==t){for(var a=dirMasksDelta[this.direction],l=a[0],n=a[1],o=e.length,i="var d = "+n+"+"+l+"*level.height;\n",r=1===STRIDE_OBJ?"":"*"+STRIDE_OBJ,s=0;s<STRIDE_OBJ;++s)i+="var cellObjects"+s+" = level.objects[i"+r+(s?"+"+s:"")+"];\n";r=1===STRIDE_MOV?"":"*"+STRIDE_MOV;for(var s=0;s<STRIDE_MOV;++s)i+="var cellMovements"+s+" = level.movements[i"+r+(s?"+"+s:"")+"];\n";i+="return "+e[0].generateMatchString("0_");for(var c=1;c<o;c++)i+="&&cellRow["+c+"].matches((i+"+c+"*d))";return i+=";",i in matchCache?matchCache[i]:matchCache[i]=new Function("cellRow","i",i)}var a=dirMasksDelta[this.direction],l=a[0],n=a[1],o=e.length,i="var d = "+n+"+"+l+"*level.height;\n";i+="var result = [];\n",i+="if(cellRow[0].matches(i)";for(var c=1;e[c]!==ellipsisPattern;c++)i+="&&cellRow["+c+"].matches((i+"+c+"*d))";for(c++,i+=") {\n",i+="\tfor (var k=kmin;k<kmax;k++) {\n",i+="\t\tif(cellRow["+c+"].matches((i+d*(k+"+(c-1)+")))",c++;c<o;c++)i+="&&cellRow["+c+"].matches((i+d*(k+"+(c-1)+")))";return i+="){\n",i+="\t\t\tresult.push([i,k]);\n",i+="\t\t}\n",i+="\t}\n",i+="}\n",i+="return result;",i in matchCache?matchCache[i]:matchCache[i]=new Function("cellRow","i","kmax","kmin",i)},Rule.prototype.toJSON=function(){return[this.direction,this.patterns,this.hasReplacements,this.lineNumber,this.isEllipsis,this.groupNumber,this.isRigid,this.commands,this.isRandom,this.cellRowMasks,this.isGlobal]};var STRIDE_OBJ=1,STRIDE_MOV=1,matchCache={};CellPattern.prototype.generateMatchString=function(){for(var e="(true",t=0;t<Math.max(STRIDE_OBJ,STRIDE_MOV);++t){var a="cellObjects"+t,l="cellMovements"+t,n=this.objectsPresent.data[t],o=this.objectsMissing.data[t],i=this.movementsPresent.data[t],r=this.movementsMissing.data[t];n&&(e+=n&n-1?"\t\t&& (("+a+"&"+n+")==="+n+")\n":"\t\t&& ("+a+"&"+n+")\n"),o&&(e+="\t\t&& !("+a+"&"+o+")\n"),i&&(e+=i&i-1?"\t\t&& (("+l+"&"+i+")==="+i+")\n":"\t\t&& ("+l+"&"+i+")\n"),r&&(e+="\t\t&& !("+l+"&"+r+")\n")}for(var s=0;s<this.anyObjectsPresent.length;s++){e+="\t\t&& (0";for(var t=0;t<STRIDE_OBJ;++t){var c=this.anyObjectsPresent[s].data[t];c&&(e+="|(cellObjects"+t+"&"+c+")")}e+=")"}return e+="\t)"},CellPattern.prototype.generateMatchFunction=function(){for(var e,t="",a=1===STRIDE_OBJ?"":"*"+STRIDE_OBJ,e=0;e<STRIDE_OBJ;++e)t+="\tvar cellObjects"+e+" = level.objects[i"+a+(e?"+"+e:"")+"];\n";a=1===STRIDE_MOV?"":"*"+STRIDE_MOV;for(var e=0;e<STRIDE_MOV;++e)t+="\tvar cellMovements"+e+" = level.movements[i"+a+(e?"+"+e:"")+"];\n";return t+="return "+this.generateMatchString()+";",t in matchCache?matchCache[t]:matchCache[t]=new Function("i",t)},CellPattern.prototype.toJSON=function(){return[this.movementMask,this.cellMask,this.nonExistenceMask,this.moveNonExistenceMask,this.moveStationaryMask,this.randomDirOrEntityMask,this.movementsToRemove]};var _o1,_o2,_o2_5,_o3,_o4,_o5,_o6,_o7,_o8,_o9,_o10,_o11,_o12,_m1,_m2,_m3;CellPattern.prototype.replace=function(e,t){var a=this.replacement;if(null===a)return!1;var l=a.randomEntityMask,n=a.randomDirMask,o=a.objectsSet.cloneInto(_o1),i=a.objectsClear.cloneInto(_o2),r=a.movementsSet.cloneInto(_m1),s=a.movementsClear.cloneInto(_m2);if(s.ior(a.movementsLayerMask),!l.iszero()){for(var c=[],v=0;v<32*STRIDE_OBJ;v++)l.get(v)&&c.push(v);var d=c[Math.floor(RandomGen.uniform()*c.length)],u=state.idDict[d],m=state.objects[u];o.ibitset(d),i.ior(state.layerMasks[m.layer]),s.ishiftor(31,5*m.layer)}if(!n.iszero())for(var g=0;g<level.layerCount;g++)if(n.get(5*g)){var h=Math.floor(4*RandomGen.uniform());r.ibitset(h+5*g)}var f=level.getCellInto(t,_o2_5),p=level.getMovements(t),S=f.cloneInto(_o3),_=p.cloneInto(_m3);f.iclear(i),f.ior(o),p.iclear(s),p.ior(r);var y=!1,M=0,b=0;if(e.isRigid){var k=state.groupNumber_to_RigidGroupIndex[e.groupNumber];k++;for(var C=new BitVec(STRIDE_MOV),I=0;I<level.layerCount;I++)C.ishiftor(k,5*I);C.iand(a.movementsLayerMask),M=level.rigidGroupIndexMask[t]||new BitVec(STRIDE_MOV),b=level.rigidMovementAppliedMask[t]||new BitVec(STRIDE_MOV),C.bitsSetInArray(M.data)||a.movementsLayerMask.bitsSetInArray(b.data)||(M.ior(C),b.ior(a.movementsLayerMask),y=!0)}var w=!1;if(!S.equals(f)||!_.equals(p)||y){w=!0,y&&(level.rigidGroupIndexMask[t]=M,level.rigidMovementAppliedMask[t]=b);var R=f.cloneInto(_o4);R.iclear(S),sfxCreateMask.ior(R);var T=S.cloneInto(_o5);T.iclear(f),sfxDestroyMask.ior(T),level.setCell(t,f),level.setMovements(t,p);var P=t/level.height|0,O=t%level.height;level.colCellContents[P].ior(f),level.rowCellContents[O].ior(f),level.mapCellContents.ior(f)}return w};var rigidBackups=[];Rule.prototype.findMatches=function(){for(var e=[],t=this.cellRowMasks,a=0;a<this.patterns.length;a++){var l=this.patterns[a],n=this.cellRowMatches[a];if(this.isEllipsis[a])var o=matchCellRowWildCard(this.direction,n,l,t[a]);else var o=matchCellRow(this.direction,n,l,t[a],this.isGlobal);if(0===o.length)return[];e.push(o)}return e},Rule.prototype.directional=function(){for(var e=0;e<state.rules.length;e++)for(var t=state.rules[e],a=0,l=0;l<t.length;l++)if(this.lineNumber===t[l].lineNumber&&a++,a>1)return!0;return!1},Rule.prototype.applyAt=function(e,t,a){var l=this;if(a){for(var n=!0,o=0;o<l.patterns.length;o++)if(l.isEllipsis[o]){if(!1===DoesCellRowMatchWildCard(l.direction,l.patterns[o],t[o][0],t[o][1]+1,t[o][1])){n=!1;break}}else if(!1===DoesCellRowMatch(l.direction,l.patterns[o],t[o])){n=!1;break}if(!1===n)return!1}for(var i=!1,r=e[0]*level.height,s=e[1],o=0;o<l.patterns.length;o++)for(var c=l.patterns[o],v=l.isEllipsis[o]?t[o][0]:t[o],d=0;d<c.length;d++){var u=c[d];if(u!==ellipsisPattern)i=u.replace(l,v)||i,v=v+s+r;else{var m=t[o][1];v+=(s+r)*m}}if(verbose_logging&&i){var g=dirMaskName[l.direction];l.directional()||(g="");var h='<font color="green">Rule <a onclick="jumpToLine('+l.lineNumber+');"  href="javascript:void(0);">'+l.lineNumber+"</a> "+g+" applied.</font>";consolePrint(h)}return i},Rule.prototype.tryApply=function(){var e=dirMasksDelta[this.direction],t=this.findMatches();if(0===t.length)return!1;var a=!1;if(this.hasReplacements)for(var l=generateTuples(t),n=0;n<l.length;n++){var o=l[n],i=n>0,r=this.applyAt(e,o,i);a=r||a}return t.length>0&&this.queueCommands(),a},Rule.prototype.queueCommands=function(){for(var e=this.commands,t=0;t<e.length;t++){var a=e[t];if(!(level.commandQueue.indexOf(a[0])>=0)){if(level.commandQueue.push(a[0]),level.commandQueueSourceRules.push(this),verbose_logging){var l=this.lineNumber,n=(dirMaskName[this.direction],'<font color="green">Rule <a onclick="jumpToLine('+l.toString()+');"  href="javascript:void(0);">'+l.toString()+"</a> triggers command "+a[0]+".</font>");consolePrint(n,!0)}if("message"===a[0]&&(messagetext=a[1]),void 0!==state.metadata.runtime_metadata_twiddling&&twiddleable_params.includes(a[0])&&(value=a[1],"wipe"==value?(delete state.metadata[a[0]],value=null):"default"==value&&(value=deepClone(state.default_metadata[a[0]])),null!=value&&(state.metadata[a[0]]=value),"zoomscreen"!==a[0]&&"flickscreen"!==a[0]||(twiddleMetaData(state,!0),canvasResize()),"smoothscreen"===a[0]&&(void 0!==value?(twiddleMetaData(state,!0),initSmoothCamera()):smoothscreen=!1,canvasResize()),twiddleMetadataExtras(),void 0!==state.metadata.runtime_metadata_twiddling_debug)){var o="Metadata twiddled: Flag "+a[0]+" set to "+value;value!=a[1]&&(o+=" ("+a[1]+")"),consolePrintFromRule(o,this,!0)}}}};var sfxCreateMask=null,sfxDestroyMask=null,playerPositions,playerPositionsAtTurnStart;</script> <script>function logErrorCacheable(e,n,r){if(compiling||r){if(void 0===n)return logErrorNoLine(e);var t='<a onclick="jumpToLine('+n.toString()+');"  href="javascript:void(0);"><span class="errorTextLineNumber"> line '+n.toString()+'</span></a> : <span class="errorText">'+e+"</span>";errorStrings.indexOf(t)>=0&&!r||(consolePrint(t),errorStrings.push(t),errorCount++)}}function logError(e,n,r){if(compiling||r){if(void 0===n)return logErrorNoLine(e,r);var t='<a onclick="jumpToLine('+n.toString()+');"  href="javascript:void(0);"><span class="errorTextLineNumber"> line '+n.toString()+'</span></a> : <span class="errorText">'+e+"</span>";errorStrings.indexOf(t)>=0&&!r||(consolePrint(t,!0),errorStrings.push(t),errorCount++)}}function logWarning(e,n,r){if(compiling||r){if(void 0===n)return logErrorNoLine(e);var t='<a onclick="jumpToLine('+n.toString()+');"  href="javascript:void(0);"><span class="errorTextLineNumber"> line '+n.toString()+'</span></a> : <span class="warningText">'+e+"</span>";errorStrings.indexOf(t)>=0&&!r||(consolePrint(t,!0),errorStrings.push(t))}}function logErrorNoLine(e,n){if(compiling||n){var r='<span class="errorText">'+e+"</span>";errorStrings.indexOf(r)>=0&&!n||(consolePrint(r,!0),errorStrings.push(r)),errorCount++}}function logBetaMessage(e,n){if(compiling||n){var r='<span class="betaText">'+e+"</span>";errorStrings.indexOf(r)>=0&&!n||(consoleError(r),errorStrings.push(r))}}function blankLineHandle(e){"levels"===e.section?e.levels[e.levels.length-1].length>0&&e.levels.push([]):"objects"===e.section&&(e.objects_section=0)}var compiling=!1,errorStrings=[],errorCount=0,twiddleable_params=["background_color","text_color","key_repeat_interval","realtime_interval","again_interval","flickscreen","zoomscreen","smoothscreen","noundo","norestart"];"function"!=typeof Object.assign&&function(){Object.assign=function(e){"use strict";if(void 0===e||null===e)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(e),r=1;r<arguments.length;r++){var t=arguments[r];if(void 0!==t&&null!==t)for(var o in t)t.hasOwnProperty(o)&&(n[o]=t[o])}return n}}();var codeMirrorFn=function(){"use strict";function e(e,n){if(void 0!==e.objects[n])return logError('Object "'+n+'" defined multiple times.',e.lineNumber),"ERROR";for(var r=0;r<e.legend_synonyms.length;r++){var t=e.legend_synonyms[r];t[0]==n&&logError('Name "'+n+'" already in use.',e.lineNumber)}for(var r=0;r<e.legend_aggregates.length;r++){var t=e.legend_aggregates[r];t[0]==n&&logError('Name "'+n+'" already in use.',e.lineNumber)}for(var r=0;r<e.legend_properties.length;r++){var t=e.legend_properties[r];t[0]==n&&logError('Name "'+n+'" already in use.',e.lineNumber)}}var n=["objects","legend","sounds","collisionlayers","rules","winconditions","levels"],r=["sfx0","sfx1","sfx2","sfx3","sfx4","sfx5","sfx6","sfx7","sfx8","sfx9","sfx10","cancel","checkpoint","restart","win","message","again","undo","nosave","quit","zoomscreen","flickscreen","smoothscreen","again_interval","realtime_interval","key_repeat_interval","noundo","norestart","background_color","text_color"],t=/[\w]+\s*/,o=/\d+\b/,s=/(objects|collisionlayers|legend|sounds|rules|winconditions|levels)(?![\w])\s*/i,i=/[\=]+/,a=/[^\(]+/,l=/[ \,]*/,c=/(move|action|create|destroy|cantmove|undo|restart|titlescreen|startgame|cancel|endgame|startlevel|endlevel|showmessage|closemessage|sfx0|sfx1|sfx2|sfx3|sfx4|sfx5|sfx6|sfx7|sfx8|sfx9|sfx10)\s+/i,u=/^(action|up|down|left|right|\^|v|\<|\>|moving|stationary|parallel|perpendicular|horizontal|orthogonal|vertical|no|randomdir|random)$/i,g=/^(startloop|endloop)$/i,d=/^(up|down|left|right|horizontal|vertical|orthogonal|late|rigid)$/i,m=/\s*(up|down|left|right|horizontal|vertical|orthogonal)\s*/i,f=/^(all|any|no|some)$/i,h=["checkpoint","objects","collisionlayers","legend","sounds","rules","...","winconditions","levels","|","[","]","up","down","left","right","late","rigid","^","v",">","<","no","randomdir","random","horizontal","vertical","any","all","no","some","moving","stationary","parallel","perpendicular","action","nosave","message","global","zoomscreen","flickscreen","smoothscreen","noundo","norestart","background_color","text_color"],p=["title","author","homepage","background_color","text_color","key_repeat_interval","realtime_interval","again_interval","flickscreen","zoomscreen","smoothscreen","color_palette","youtube","sprite_size","level_select_unlocked_ahead","level_select_solve_symbol","custom_font","mouse_left","mouse_drag","mouse_right","mouse_rdrag","mouse_up","mouse_rup","local_radius","font_size"],v=["run_rules_on_level_start","norepeat_action","require_player_movement","debug","verbose_logging","throttle_movement","noundo","noaction","norestart","scanline","case_sensitive","level_select","continue_is_level_select","level_select_lock","settings","runtime_metadata_twiddling","runtime_metadata_twiddling_debug","smoothscreen_debug"];return{copyState:function(e){var n={};for(var r in e.objects)if(e.objects.hasOwnProperty(r)){var t=e.objects[r];n[r]={colors:t.colors.concat([]),lineNumber:t.lineNumber,spritematrix:t.spritematrix.concat([])}}for(var o=[],r=0;r<e.collisionLayers.length;r++)o.push(e.collisionLayers[r].concat([]));for(var s=[],i=[],a=[],l=[],c=[],u=[],r=0;r<e.legend_synonyms.length;r++)s.push(e.legend_synonyms[r].concat([]));for(var r=0;r<e.legend_aggregates.length;r++)i.push(e.legend_aggregates[r].concat([]));for(var r=0;r<e.legend_properties.length;r++)a.push(e.legend_properties[r].concat([]));for(var r=0;r<e.sounds.length;r++)l.push(e.sounds[r].concat([]));for(var r=0;r<e.levels.length;r++)c.push(e.levels[r].concat([]));for(var r=0;r<e.winconditions.length;r++)u.push(e.winconditions[r].concat([]));var g=Object.assign({},e.original_case_names);return{lineNumber:e.lineNumber,objects:n,collisionLayers:o,commentLevel:e.commentLevel,section:e.section,visitedSections:e.visitedSections.concat([]),objects_candname:e.objects_candname,objects_section:e.objects_section,objects_spritematrix:e.objects_spritematrix.concat([]),tokenIndex:e.tokenIndex,currentSection:e.currentSection,legend_synonyms:s,legend_aggregates:i,legend_properties:a,sounds:l,rules:e.rules.concat([]),names:e.names.concat([]),winconditions:u,original_case_names:g,abbrevNames:e.abbrevNames.concat([]),metadata:e.metadata.concat([]),sprite_size:e.sprite_size,case_sensitive:e.case_sensitive,levels:c,STRIDE_OBJ:e.STRIDE_OBJ,STRIDE_MOV:e.STRIDE_MOV}},blankLine:function(e){"levels"===e.section&&e.levels[e.levels.length-1].length>0&&e.levels.push([])},token:function(b,_){function x(e){function n(e){return e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}var r;r=_.case_sensitive?new RegExp("\\b"+n(e)+"\\b"):new RegExp("\\b"+n(e)+"\\b","i");var t=E.match(r);null!=t&&(_.original_case_names[e]=t[0])}var E=b.string,y=b.sol();y&&(_.case_sensitive||(b.string=b.string.toLowerCase()),_.tokenIndex=0),b.eatWhile(/[ \t]/);var N=b.peek();if("("===N&&-4!==_.tokenIndex)b.next(),_.commentLevel++;else if(")"===N&&(b.next(),_.commentLevel>0&&0===--_.commentLevel))return"comment";if(_.commentLevel>0){for(;;){if(b.eatWhile(/[^\(\)]+/),b.eol())break;if(N=b.peek(),"("===N?_.commentLevel++:")"===N&&_.commentLevel--,b.next(),0===_.commentLevel)break}return"comment"}if(b.eatWhile(/[ \t]/),y&&b.eol())return blankLineHandle(_);if(y&&b.match(i,!0))return"EQUALSBIT";if(b.match(s,!0)){_.section=b.string.slice(0,b.pos).trim().toLowerCase(),_.visitedSections.indexOf(_.section)>=0&&logError('cannot duplicate sections (you tried to duplicate "'+_.section+'").',_.lineNumber),_.visitedSections.push(_.section);var R=n.indexOf(_.section);if(0==R?(_.objects_section=0,_.visitedSections.length>1&&logError('section "'+_.section+'" must be the first section',_.lineNumber)):-1==_.visitedSections.indexOf(n[R-1])&&(-1===R?logError('no such section as "'+_.section+'".',_.lineNumber):logError('section "'+_.section+'" is out of order, must follow  "'+n[R-1]+'".',_.lineNumber)),"sounds"===_.section){for(var O in _.objects)_.objects.hasOwnProperty(O)&&_.names.push(O);for(var k=0;k<_.legend_synonyms.length;k++){var O=_.legend_synonyms[k][0];_.names.push(O)}for(var k=0;k<_.legend_aggregates.length;k++){var O=_.legend_aggregates[k][0];_.names.push(O)}for(var k=0;k<_.legend_properties.length;k++){var O=_.legend_properties[k][0];_.names.push(O)}}else if("levels"===_.section){for(var O in _.objects)_.objects.hasOwnProperty(O)&&1==O.length&&_.abbrevNames.push(O);for(var k=0;k<_.legend_synonyms.length;k++)1==_.legend_synonyms[k][0].length&&_.abbrevNames.push(_.legend_synonyms[k][0]);for(var k=0;k<_.legend_aggregates.length;k++)1==_.legend_aggregates[k][0].length&&_.abbrevNames.push(_.legend_aggregates[k][0])}return"HEADER"}if(void 0===_.section&&logError('must start with section "OBJECTS"',_.lineNumber),b.eol())return null;switch(_.section){case"objects":var j=function(){var e=y?b.match(t,!0):b.match(/[^\s\()]+\s*/,!0);if(null==e)return b.match(a,!0),b.pos>0&&logWarning('Unknown junk in object section (possibly: the main names for objects have to be words containing only the letters a-z0.9 - if you want to call them something like ",", do it in the legend section).',_.lineNumber),"ERROR";var n=e[0].trim();if(void 0!==_.objects[n])return logError('Object "'+n+'" defined multiple times.',_.lineNumber),"ERROR";for(var r=0;r<_.legend_synonyms.length;r++){_.legend_synonyms[r][0]==n&&logError('Name "'+n+'" already in use.',_.lineNumber)}if(h.indexOf(n)>=0&&logWarning('You named an object "'+n+"\", but this is a keyword. Don't do that!",_.lineNumber),y)_.objects_candname=n,x(n),_.objects[_.objects_candname]={lineNumber:_.lineNumber,colors:[],spritematrix:[],cloneSprite:""};else{if("copy:"==n.substring(0,5)&&n.length>5){var o=n.substring(5);return""!=_.objects[_.objects_candname].cloneSprite?(logError("You already assigned a sprite parent for "+o+", you can't have more than one!",_.lineNumber),"ERROR"):o==_.objects_candname?(logError("You attempted to set the sprite parent for "+o+" to "+o+"! Please don't, and keep the recursion in check.",_.lineNumber),"ERROR"):(_.objects[_.objects_candname].cloneSprite=o,"SPRITEPARENT")}x(n);var s=[n,_.objects_candname];s.lineNumber=_.lineNumber,_.legend_synonyms.push(s)}if(_.case_sensitive&&("player"==n.toLowerCase()&&"player"!=n||"background"==n.toLowerCase()&&"background"!=n)){var s=[n.toLowerCase(),_.objects_candname];s.lineNumber=_.lineNumber,_.legend_synonyms.push(s)}return _.objects_section=1,"NAME"};switch(y&&2==_.objects_section&&(_.objects_section=3),y&&1==_.objects_section&&(_.objects_section=2),_.objects_section){case 0:case 1:return _.objects_spritematrix=[],j();case 2:b.string=b.string.toLowerCase(),_.tokenIndex=0;var L=b.match(reg_color,!0);if(null==L){var I=b.match(t,!0)||b.match(a,!0);return logError("Was looking for color for object "+_.objects_candname+', got "'+I+'" instead.',_.lineNumber),null}void 0===_.objects[_.objects_candname].colors?_.objects[_.objects_candname].colors=[L[0].trim()]:_.objects[_.objects_candname].colors.push(L[0].trim());var w=L[0].trim().toLowerCase();return w in colorPalettes.arnecolors?"COLOR COLOR-"+w.toUpperCase():"transparent"===w?"COLOR FADECOLOR":"MULTICOLOR"+L[0];case 3:var N=b.eat(/[.\d]/),C=_.objects_spritematrix;if(void 0===N)return 0===C.length?j():(logError("Unknown junk in spritematrix for object "+_.objects_candname+".",_.lineNumber),b.match(a,!0),null);y&&C.push("");var S=_.objects[_.objects_candname];if(C[C.length-1]+=N,C[C.length-1].length>_.sprite_size)return logError("Sprites must be "+_.sprite_size+" wide and "+_.sprite_size+" high.",_.lineNumber),b.match(a,!0),null;if(S.spritematrix=_.objects_spritematrix,C.length===_.sprite_size&&C[C.length-1].length==_.sprite_size&&(_.objects_section=0),"."!==N){var O=parseInt(N);return O>=S.colors.length?(logError("Trying to access color number "+O+" from the color palette of sprite "+_.objects_candname+", but there are only "+S.colors.length+" defined in it.",_.lineNumber),"ERROR"):isNaN(O)?(logError('Invalid character "'+N+'" in sprite for '+_.objects_candname,_.lineNumber),"ERROR"):"COLOR BOLDCOLOR COLOR-"+S.colors[O].toUpperCase()}return"COLOR FADECOLOR";default:window.console.logError("EEK shouldn't get here.")}break;case"sounds":if(y){var T=!0,A=a.exec(b.string)[0].split(/\s/).filter(function(e){return""!==e});A.push(_.lineNumber),_.sounds.push(A)}if(null!==(B=b.match(c,!0)))return"SOUNDVERB";if(null!==(B=b.match(m,!0)))return"DIRECTION";if(null!==(B=b.match(o,!0)))return _.tokenIndex++,"SOUND";if(null!==(B=b.match(/[^\[\|\]\s]*/,!0))){var D=B[0].trim();if(_.names.indexOf(D)>=0)return"NAME"}return B=b.match(a,!0),logError('unexpected sound token "'+B+'".',_.lineNumber),b.match(a,!0),"ERROR";case"collisionlayers":y&&(_.collisionLayers.push([]),_.tokenIndex=0);var M=b.match(t,!0);if(null===M){var z=b.pos;return b.match(l,!0),b.pos==z&&(logError("error detected - unexpected character "+b.peek(),_.lineNumber),b.next()),null}var B=M[0].trim(),W=function(e){if(_.case_sensitive||(e=e.toLowerCase()),e in _.objects)return[e];for(var n=0;n<_.legend_synonyms.length;n++){var r=_.legend_synonyms[n];if(r[0]===e)return W(r[1])}for(var n=0;n<_.legend_aggregates.length;n++){var r=_.legend_aggregates[n];if(r[0]===e)return logError('"'+e+'" is an aggregate (defined using "and"), and cannot be added to a single layer because its constituent objects must be able to coexist.',_.lineNumber),[]}for(var n=0;n<_.legend_properties.length;n++){var r=_.legend_properties[n];if(r[0]===e){return[].concat.apply([],r.slice(1).map(W))}}return logError('Cannot add "'+B+'" to a collision layer; it has not been declared.',_.lineNumber),[]};"background"===B.toLowerCase()?(_.collisionLayers.length>0&&_.collisionLayers[_.collisionLayers.length-1].length>0&&logError("Background must be in a layer by itself.",_.lineNumber),_.tokenIndex=1):0!==_.tokenIndex&&logError("Background must be in a layer by itself.",_.lineNumber);var P=W(B);if(0===_.collisionLayers.length)return logError("no layers found.",_.lineNumber),"ERROR";for(var G=[],k=0;k<P.length;k++)for(var B=P[k],U=0;U<=_.collisionLayers.length-1;U++){var V=_.collisionLayers[U];V.indexOf(B)>=0&&U!=_.collisionLayers.length-1&&G.push(U)}if(G.length>0){for(var Y='Object "'+B+'" included in multiple collision layers ( layers ',k=0;k<G.length;k++)Y+=G[k]+", ";Y+=_.collisionLayers.length-1,logWarning(Y+"). You should fix this!",_.lineNumber)}return _.collisionLayers[_.collisionLayers.length-1]=_.collisionLayers[_.collisionLayers.length-1].concat(P),P.length>0?"NAME":"ERROR";case"legend":if(y){var $=b.string.replace("="," = ");$=a.exec($)[0];var A=$.split(/\s/).filter(function(e){return""!==e}),T=!0;if(A.length>0){var B=A[0];_.case_sensitive||(B=B.toLowerCase()),h.indexOf(B)>=0&&logWarning('You named an object "'+B+"\", but this is a keyword. Don't do that!",_.lineNumber),A.indexOf(B,2)>=2&&(logError("You can't define object "+B+" in terms of itself!",_.lineNumber),T=!1),e(_,B)}if(T)if(A.length<3)T=!1;else if("="!==A[1])T=!1;else if(3===A.length){var F=[A[0],A[2]];_.case_sensitive||(F[1]=F[1].toLowerCase()),F.lineNumber=_.lineNumber,x(A[0]),_.legend_synonyms.push(F)}else if(A.length%2==0)T=!1;else{var K=A[3].toLowerCase();if("and"===K){for(var W=(function(e){if(_.case_sensitive||(e=e.toLowerCase()),e in _.objects)return[e];for(var n=0;n<_.legend_synonyms.length;n++){var r=_.legend_synonyms[n];if(r[0]===e)return W(r[1])}for(var n=0;n<_.legend_aggregates.length;n++){var r=_.legend_aggregates[n];if(r[0]===e)return[].concat.apply([],r.slice(1).map(W))}for(var n=0;n<_.legend_properties.length;n++){var r=_.legend_properties[n];if(r[0]===e)return logError("Cannot define an aggregate (using 'and') in terms of properties (something that uses 'or').",_.lineNumber),T=!1,[e]}return[e]}),k=5;k<A.length;k+=2)if("and"!==A[k].toLowerCase()){T=!1;break}if(T){for(var q=[A[0]].concat(W(A[2])).concat(W(A[4])),k=6;k<A.length;k+=2)q=q.concat(W(A[k]));q.lineNumber=_.lineNumber,x(q[0]),_.legend_aggregates.push(q)}}else if("or"===K){for(var W=(function(e){if(_.case_sensitive||(e=e.toLowerCase()),e in _.objects)return[e];for(var n=0;n<_.legend_synonyms.length;n++){var r=_.legend_synonyms[n];if(r[0]===e)return W(r[1])}for(var n=0;n<_.legend_aggregates.length;n++){var r=_.legend_aggregates[n];r[0]===e&&(logError("Cannot define a property (using 'or') in terms of aggregates (something that uses 'and').",_.lineNumber),T=!1)}for(var n=0;n<_.legend_properties.length;n++){var r=_.legend_properties[n];if(r[0]===e)return[].concat.apply([],r.slice(1).map(W))}return[e]}),k=5;k<A.length;k+=2)if("or"!==A[k].toLowerCase()){T=!1;break}if(T){for(var q=[A[0]].concat(W(A[2])).concat(W(A[4])),k=6;k<A.length;k+=2)_.case_sensitive?q.push(A[k]):q.push(A[k].toLowerCase());q.lineNumber=_.lineNumber,x(q[0]),_.legend_properties.push(q)}}else T=!1}else;if(!1===T)return logError("incorrect format of legend - should be one of A = B, A = B or C ( or D ...), A = B and C (and D ...)",_.lineNumber),b.match(a,!0),"ERROR";_.tokenIndex=0}if(0===_.tokenIndex)return b.match(/[^=]*/,!0),_.tokenIndex++,"NAME";if(1===_.tokenIndex)return b.next(),b.match(/\s*/,!0),_.tokenIndex++,"ASSSIGNMENT";var M=b.match(t,!0);if(null===M)return logError("Something bad's happening in the LEGEND",_.lineNumber),b.match(a,!0),"ERROR";var B=M[0].trim();if(_.tokenIndex%2==0){return!1===function(e){if(_.case_sensitive||(e=e.toLowerCase()),e in _.objects)return!0;for(var n=0;n<_.legend_aggregates.length;n++){var r=_.legend_aggregates[n];if(r[0]===e)return!0}for(var n=0;n<_.legend_properties.length;n++){var r=_.legend_properties[n];if(r[0]===e)return!0}for(var n=0;n<_.legend_synonyms.length;n++){var r=_.legend_synonyms[n];if(r[0]===e)return!0}return!1}(B)?(logError('Cannot reference "'+B+'" in the LEGEND section; it has not been defined yet.',_.lineNumber),_.tokenIndex++,"ERROR"):(_.tokenIndex++,"NAME")}return _.tokenIndex++,"LOGICWORD";case"rules":if(y){var H=a.exec(b.string)[0];_.rules.push([H,_.lineNumber,E]),_.tokenIndex=0}if(-4===_.tokenIndex)return b.skipToEnd(),"MESSAGE";if(b.match(/\s*\-\>\s*/,!0))return"ARROW";if("["===N||"|"===N||"]"===N||"+"===N)return"+"!==N&&(_.tokenIndex=1),b.next(),b.match(/\s*/,!0),"BRACKET";var D=b.match(/[^\[\|\]\s]*/,!0)[0].trim();return 0===_.tokenIndex&&g.exec(D)?"BRACKET":0===_.tokenIndex&&d.exec(D)?(b.match(/\s*/,!0),"DIRECTION"):1===_.tokenIndex&&u.exec(D)?(b.match(/\s*/,!0),"DIRECTION"):_.names.indexOf(D)>=0?y?(logError("Identifiers cannot appear outside of square brackets in rules, only directions can.",_.lineNumber),"ERROR"):(b.match(/\s*/,!0),"NAME"):(D=D.toLowerCase(),"..."===D?"DIRECTION":"rigid"===D?"DIRECTION":"random"===D?"DIRECTION":"global"===D?"DIRECTION":r.indexOf(D)>=0?(("message"===D||twiddleable_params.includes(D))&&(_.tokenIndex=-4),"COMMAND"):(logError('Name "'+D+'", referred to in a rule, does not exist.',_.lineNumber),"ERROR"));case"winconditions":if(y){var J=a.exec(b.string),Q=J[0].split(/\s/),X=Q.filter(function(e){return""!==e});X.push(_.lineNumber),_.winconditions.push(X),_.tokenIndex=-1}_.tokenIndex++;var Z=b.match(/\s*\w+\s*/);if(null===Z)return logError("incorrect format of win condition.",_.lineNumber),b.match(a,!0),"ERROR";var ee=Z[0].trim();if(0===_.tokenIndex)return f.exec(ee)?"LOGICWORD":"ERROR";if(2===_.tokenIndex)return"on"!=ee.toLowerCase()?"ERROR":"LOGICWORD";if(1===_.tokenIndex||3===_.tokenIndex)return-1===_.names.indexOf(ee)?(logError('Error in win condition: "'+ee+'" is not a valid object name.',_.lineNumber),"ERROR"):"NAME";break;case"levels":if(y){if(b.match(/\s*message\s*/i,!0)){_.tokenIndex=1;var ne=["\n",E.slice(b.pos).trim(),_.lineNumber,_.currentSection];return 0==_.levels[_.levels.length-1].length?_.levels.splice(_.levels.length-1,0,ne):_.levels.push(ne),"MESSAGE_VERB"}if(b.match(/\s*section\s*/i,!0))return _.tokenIndex=3,_.currentSection=E.slice(b.pos).trim(),"SECTION_VERB";var re=b.match(a,!1)[0].trim();_.tokenIndex=2;var te=_.levels[_.levels.length-1];"\n"==te[0]?_.levels.push([_.lineNumber,_.currentSection,re]):(0==te.length&&(te.push(_.lineNumber),te.push(_.currentSection)),te.push(re),te.length>2&&re.length!=te[2].length&&logWarning("Maps must be rectangular, yo (In a level, the length of each row must be the same).",_.lineNumber))}else{if(1==_.tokenIndex)return b.skipToEnd(),"MESSAGE";if(3==_.tokenIndex)return b.skipToEnd(),-1==_.metadata.indexOf("level_select")?(logError("Can't use sections without level_select parameter in preamble",_.lineNumber),"ERROR"):"SECTION"}if(2===_.tokenIndex&&!b.eol()){var N=b.peek();return b.next(),_.abbrevNames.indexOf(N)>=0?"LEVEL":(logError('Key "'+N+'" not found. Do you need to add it to the legend, or define a new object?',_.lineNumber),"ERROR")}break;default:if(y&&(_.tokenIndex=0),0!=_.tokenIndex)return b.match(a,!0),"METADATATEXT";var Z=b.match(/\s*\w+\s*/);if(null!==Z){var oe=Z[0].trim();if(y){if(p.indexOf(oe)>=0){"youtube"!==oe&&"author"!==oe&&"title"!==oe&&"custom_font"!==oe||(b.string=E);var se=b.match(a,!1);return null!=se?"sprite_size"==oe?_.sprite_size=parseInt(se[0].trim(),10):(_.metadata.push(oe),_.metadata.push(se[0].trim())):logError('MetaData "'+oe+'" needs a value.',_.lineNumber),_.tokenIndex=1,"METADATA"}return v.indexOf(oe)>=0?("case_sensitive"==oe&&(_.case_sensitive=!0),_.metadata.push(oe),_.metadata.push("true"),_.tokenIndex=-1,"METADATA"):(logError("Unrecognised stuff in the prelude.",_.lineNumber),"ERROR")}return-1==_.tokenIndex?(logError('MetaData "'+oe+'" has no parameters.',_.lineNumber),"ERROR"):"METADATA"}}return b.eol()?null:b.eol()?void 0:(b.next(),null)},startState:function(){return{objects:{},lineNumber:0,commentLevel:0,section:"",visitedSections:[],objects_candname:"",objects_section:0,objects_spritematrix:[],collisionLayers:[],tokenIndex:0,currentSection:null,legend_synonyms:[],legend_aggregates:[],legend_properties:[],sounds:[],rules:[],names:[],winconditions:[],metadata:[],sprite_size:5,case_sensitive:!1,original_case_names:{},abbrevNames:[],levels:[[]],subsection:""}}}};window.CodeMirror.defineMode("puzzle",codeMirrorFn);</script> <script>'use strict'; 
 
function isColor(str) { 
 str = str.trim(); 
 if (str in colorPalettes.arnecolors) 
  return true; 
 if (/^#([0-9A-F]{2}){3,4}$/i.test(str)) 
  return true; 
 if (/^#([0-9A-F]{3})$/i.test(str)) 
  return true; 
 if (str === "transparent") 
  return true; 
 return false; 
} 
 
function colorToHex(palette,str) { 
 str = str.trim(); 
 if (str in palette) { 
  return palette[str]; 
 } 
 
 return str; 
} 
 
 
function generateSpriteMatrix(dat) { 
 
 var result = []; 
 for (var i = 0; i < dat.length; i++) { 
  var row = []; 
  for (var j = 0; j < dat.length; j++) { 
   var ch = dat[i].charAt(j); 
   if (ch == '.') { 
    row.push(-1); 
   } else { 
    row.push(ch); 
   } 
  } 
  result.push(row); 
 } 
 return result; 
} 
 
var debugMode; 
var colorPalette; 
 
function generateExtraMembers(state) { 
 
 if (state.collisionLayers.length===0) { 
  logError("No collision layers defined.  All objects need to be in collision layers."); 
 } 
 
 //annotate objects with layers 
 //assign ids at the same time 
 state.idDict = {}; 
 var idcount=0; 
 for (var layerIndex = 0; layerIndex < state.collisionLayers.length; layerIndex++) { 
  for (var j = 0; j < state.collisionLayers[layerIndex].length; j++) 
  { 
   var n = state.collisionLayers[layerIndex][j]; 
   if (n in  state.objects)  { 
    var o = state.objects[n]; 
    o.layer = layerIndex; 
    o.id=idcount; 
    state.idDict[idcount]=n; 
    idcount++; 
   } 
  } 
 } 
 
 //set object count 
 state.objectCount = idcount; 
 
 //calculate blank mask template 
 var layerCount = state.collisionLayers.length; 
 var blankMask = []; 
 for (var i = 0; i < layerCount; i++) { 
  blankMask.push(-1); 
 } 
 
 // how many words do our bitvecs need to hold? 
 STRIDE_OBJ = Math.ceil(state.objectCount/32)|0; 
 STRIDE_MOV = Math.ceil(layerCount/5)|0; 
 state.STRIDE_OBJ=STRIDE_OBJ; 
 state.STRIDE_MOV=STRIDE_MOV; 
  
 //get colorpalette name 
 debugMode=false; 
 verbose_logging=false; 
 throttle_movement=false; 
 colorPalette=colorPalettes.arnecolors; 
 for (var i=0;i<state.metadata.length;i+=2){ 
  var key = state.metadata[i]; 
  var val = state.metadata[i+1]; 
  if (key==='color_palette') { 
   if (val in colorPalettesAliases) { 
    val = colorPalettesAliases[val]; 
   } 
   if (colorPalettes[val]===undefined) { 
    logError('Palette "'+val+'" not found, defaulting to arnecolors.',0); 
   }else { 
    colorPalette=colorPalettes[val]; 
   } 
  } else if (key==='debug') { 
   debugMode=true; 
   cache_console_messages=true; 
  } else if (key ==='verbose_logging') { 
   verbose_logging=true; 
   cache_console_messages=true; 
  } else if (key==='throttle_movement') { 
   throttle_movement=true; 
  } 
 } 
 
 //convert colors to hex 
 for (var n in state.objects) { 
       if (state.objects.hasOwnProperty(n)) { 
   //convert color to hex 
        var o = state.objects[n]; 
        if (o.colors.length>10) { 
         logError("a sprite cannot have more than 10 colors.  Why you would want more than 10 is beyond me.",o.lineNumber+1); 
        } 
        for (var i=0;i<o.colors.length;i++) { 
         var c = o.colors[i]; 
    if (isColor(c)) { 
     c = colorToHex(colorPalette,c); 
     o.colors[i] = c; 
    } else { 
     logError('Invalid color specified for object "' + n + '", namely "' + o.colors[i] + '".', o.lineNumber + 1); 
     o.colors[i] = '#ff00ff'; // magenta error color 
    } 
   } 
  } 
 } 
 
 //generate sprite matrix 
 for (var n in state.objects) { 
       if (state.objects.hasOwnProperty(n)) { 
        var o = state.objects[n]; 
        if (o.colors.length==0) { 
         logError('color not specified for object "' + n +'".',o.lineNumber); 
         o.colors=["#ff00ff"]; 
     } 
    if (o.cloneSprite !== "") { 
    //console.log("To clone: "+o.cloneSprite); 
    if (state.objects.hasOwnProperty(o.cloneSprite)) { 
      
     if (state.objects[o.cloneSprite].cloneSprite === "") { 
      o.spritematrix = deepClone(state.objects[o.cloneSprite].spritematrix); 
      //console.log(o.spritematrix); 
     } else { 
      logError("The sprite that "+n+" attempted to clone ("+o.cloneSprite+") clones a sprite itself ("+state.objects[o.cloneSprite].cloneSprite + "), so it can't clone the sprite! You'll need to set up the cloning differently.",o.lineNumber); 
     } 
    } else { 
     logError(n +" attempted to clone the sprite matrix of "+o.cloneSprite+", but that object doesn't exist?!",o.lineNumber); 
    } 
    }  
     /*else /*if (o.colors[o.colors.length-1][0] !== "#") { 
      var objectToClone = o.colors[o.colors.length-1]; 
      if (state.objects.hasOwnProperty(objectToClone)) { 
     o.spritematrix = objectToClone.spritematrix; 
     o.spritematrix = generateSpriteMatrix(o.spritematrix); 
     logWarning("Cloned "+objectToClone, o.lineNumber); 
     continue; 
    } else { 
     logError("Attempted to clone the sprite matrix of "+objectToClone+", but that object doesn't exist?!") 
    } 
   }*/ 
   else if (o.spritematrix.length===0) { 
    o.spritematrix = new Array(state.sprite_size); 
    var zeros = new Array(state.sprite_size); 
    for(var i = 0; i < state.sprite_size; i++) { 
     zeros[i] = 0; 
    } 
    for(var i = 0; i < state.sprite_size; i++) { 
     o.spritematrix[i] = zeros; 
    } 
   } else { 
    if ( o.spritematrix.length!==state.sprite_size) { 
     logWarning("Sprite graphics must be " + state.sprite_size + " wide and " + state.sprite_size + " high exactly.",o.lineNumber); 
    } else { 
     for(var i = 0; i < state.sprite_size; i++) { 
      if(o.spritematrix[i].length!==state.sprite_size) { 
       logWarning("Sprite graphics must be " + state.sprite_size + " wide and " + state.sprite_size + " high exactly.",o.lineNumber); 
       break; 
      } 
     } 
    } 
    o.spritematrix = generateSpriteMatrix(o.spritematrix); 
   } 
  } 
 } 
 
 
 //calculate glyph dictionary 
 var glyphDict = {}; 
 for (var n in state.objects) { 
       if (state.objects.hasOwnProperty(n)) { 
        var o = state.objects[n]; 
   var mask = blankMask.concat([]); 
   mask[o.layer] = o.id; 
   glyphDict[n] = mask; 
  } 
 } 
  var added=true; 
    while (added) { 
        added=false; 
         
        //then, synonyms 
        for (var i = 0; i < state.legend_synonyms.length; i++) { 
            var dat = state.legend_synonyms[i]; 
            var key = dat[0]; 
            var val = dat[1]; 
            if ((!(key in glyphDict)||(glyphDict[key]===undefined))&&(glyphDict[val]!==undefined)) { 
                added=true; 
                glyphDict[key] = glyphDict[val]; 
            } 
        } 
     
        //then, aggregates 
        for (var i = 0; i < state.legend_aggregates.length; i++) { 
            var dat = state.legend_aggregates[i]; 
            var key=dat[0]; 
            var vals=dat.slice(1); 
            var allVallsFound=true; 
            for (var j=0;j<vals.length;j++) { 
             var v = vals[j]; 
             if (glyphDict[v]===undefined) { 
              allVallsFound=false; 
              break; 
             } 
            } 
            if ((!(key in glyphDict)||(glyphDict[key]===undefined))&&allVallsFound) {             
                var mask = blankMask.concat([]); 
         
                for (var j = 1; j < dat.length; j++) { 
                    var n = dat[j]; 
                    var o = state.objects[n]; 
                    if (o == undefined) { 
                        logError('Object not found with name '+ n, state.lineNumber); 
                    } 
                    if (mask[o.layer] == -1) { 
                        mask[o.layer] = o.id; 
                    } else { 
                     if (o.layer===undefined) { 
                      logError('Object "' + n.toUpperCase() + '" has been defined, but not assigned to a layer.',dat.lineNumber); 
                     } else { 
                      var n1 = n.toUpperCase(); 
                      var n2 = state.idDict[mask[o.layer]].toUpperCase(); 
                      if (n1!==n2){ 
                          logError( 
                              'Trying to create an aggregate object (defined in the legend) with both "' 
                              + n1 + '" and "' + n2 + '", which are on the same layer and therefore can\'t coexist.', 
                              dat.lineNumber 
                              ); 
                      } 
                     } 
                    } 
                } 
                added=true; 
                glyphDict[dat[0]] = mask; 
            } 
        } 
    } 
 state.glyphDict = glyphDict; 
 
 var aggregatesDict = {}; 
 for (var i = 0; i < state.legend_aggregates.length; i++) { 
  var entry = state.legend_aggregates[i]; 
  aggregatesDict[entry[0]] = entry.slice(1); 
 } 
 state.aggregatesDict = aggregatesDict; 
 
 var propertiesDict = {}; 
 for (var i = 0; i < state.legend_properties.length; i++) { 
  var entry = state.legend_properties[i]; 
  propertiesDict[entry[0]] = entry.slice(1); 
 } 
 state.propertiesDict = propertiesDict; 
 
 //calculate lookup dictionaries 
 var synonymsDict = {}; 
 for (var i = 0; i < state.legend_synonyms.length; i++) { 
  var entry = state.legend_synonyms[i]; 
  var key = entry[0]; 
  var value=entry[1]; 
  if (value in aggregatesDict) { 
   aggregatesDict[key]=aggregatesDict[value]; 
  } 
  else if (value in propertiesDict) { 
   propertiesDict[key]=propertiesDict[value]; 
  } else if (key!==value) { 
   synonymsDict[key] = value;   
  } 
 } 
 state.synonymsDict = synonymsDict; 
 
 var modified=true; 
 while(modified){ 
  modified=false; 
  for (var n in synonymsDict) { 
   if (synonymsDict.hasOwnProperty(n)) { 
    var value = synonymsDict[n]; 
    if (value in propertiesDict) { 
     delete synonymsDict[n]; 
     propertiesDict[n]=propertiesDict[value]; 
     modified=true; 
    } 
    else if (value in aggregatesDict) { 
     delete aggregatesDict[n]; 
     aggregatesDict[n]=aggregatesDict[value]; 
     modified=true; 
    } else if (value in synonymsDict) { 
     synonymsDict[n]=synonymsDict[value]; 
    } 
   } 
  } 
 
  for (var n in propertiesDict) { 
   if (propertiesDict.hasOwnProperty(n)) { 
    var values = propertiesDict[n]; 
    for (var i=0;i<values.length;i++) { 
     var value = values[i]; 
     if (value in synonymsDict) { 
      values[i]=synonymsDict[value]; 
      modified=true; 
     } else if (value in propertiesDict) { 
      values.splice(i,1); 
      var newvalues=propertiesDict[value]; 
      for (var j=0;j<newvalues.length;j++) { 
       var newvalue=newvalues[j]; 
       if (values.indexOf(newvalue)===-1) { 
        values.push(newvalue); 
       } 
      } 
      modified=true; 
     } if (value in aggregatesDict) { 
      logError('Trying to define property "' + n.toUpperCase() +'" in terms of aggregate "'+value.toUpperCase()+'".'); 
     } 
    } 
   } 
  } 
 
 
  for (var n in aggregatesDict) { 
   if (aggregatesDict.hasOwnProperty(n)) { 
    var values = aggregatesDict[n]; 
    for (var i=0;i<values.length;i++) { 
     var value = values[i]; 
     if (value in synonymsDict) { 
      values[i]=synonymsDict[value]; 
      modified=true; 
     } else if (value in aggregatesDict) { 
      values.splice(i,1); 
      var newvalues=aggregatesDict[value]; 
      for (var j=0;j<newvalues.length;j++) { 
       var newvalue=newvalues[j]; 
       if (values.indexOf(newvalue)===-1) { 
        values.push(newvalue); 
       } 
      } 
      modified=true; 
     } if (value in propertiesDict) { 
      logError('Trying to define aggregate "' + n.toUpperCase() +'" in terms of property "'+value.toUpperCase()+'".'); 
     } 
    } 
   } 
  } 
 } 
 
 /* determine which properties specify objects all on one layer */ 
 state.propertiesSingleLayer = {}; 
 for (var key in propertiesDict) { 
  if (propertiesDict.hasOwnProperty(key)) { 
   var values = propertiesDict[key]; 
   var sameLayer = true; 
   for (var i = 1; i < values.length; i++) { 
    if ((state.objects[values[i-1]].layer !== state.objects[values[i]].layer)) { 
     sameLayer = false; 
     break; 
    } 
   } 
   if (sameLayer) { 
    state.propertiesSingleLayer[key] = state.objects[values[0]].layer; 
   } 
  } 
 } 
 
 if (state.idDict[0]===undefined && state.collisionLayers.length>0) { 
  logError('You need to have some objects defined'); 
 } 
 
 //set default background object 
 var backgroundid; 
 var backgroundlayer; 
 if (state.objects.background===undefined) { 
  if ('background' in state.synonymsDict) { 
   var n = state.synonymsDict['background']; 
   var o = state.objects[n]; 
   backgroundid = o.id; 
   backgroundlayer = o.layer; 
  } else if ('background' in state.propertiesDict) { 
   var n = state.propertiesDict['background'][0]; 
   var o = state.objects[n]; 
   backgroundid = o.id; 
   backgroundlayer = o.layer; 
  }else if ('background' in state.aggregatesDict) { 
   var o=state.objects[state.idDict[0]]; 
   backgroundid=o.id; 
   backgroundlayer=o.layer; 
   logError("background cannot be an aggregate (declared with 'and'), it has to be a simple type, or property (declared in terms of others using 'or')."); 
  } else { 
   var o=state.objects[state.idDict[0]]; 
   backgroundid=o.id; 
   backgroundlayer=o.layer; 
   logError("you have to define something to be the background"); 
  } 
 } else { 
  backgroundid = state.objects.background.id; 
  backgroundlayer = state.objects.background.layer; 
 } 
 state.backgroundid=backgroundid; 
 state.backgroundlayer=backgroundlayer; 
} 
 
function generateExtraMembersPart2(state) { 
 function assignMouseObject(preludeTerm, defaultName) { 
  if (preludeTerm in state.metadata) { 
   var name = state.metadata[preludeTerm] || defaultName; 
   var id = null; 
   if (state.objects[name]) { 
    id = state.objects[name].id; 
   } else { 
    if (name in state.synonymsDict) { 
     var n = state.synonymsDict[name]; 
     var o = state.objects[n]; 
     id = o.id; 
    } else { 
     var o=state.objects[state.idDict[1]]; 
     id=o.id; 
     logError(name + " object/alias has to be defined"); 
    } 
   } 
   return id; 
  } 
 } 
  
 state.lmbID = assignMouseObject("mouse_left", "lmb"); 
 state.rmbID = assignMouseObject("mouse_right", "rmb"); 
 state.dragID = assignMouseObject("mouse_drag", "drag"); 
 state.rdragID = assignMouseObject("mouse_rdrag", "rdrag"); 
 state.lmbupID = assignMouseObject("mouse_up", "lmbup"); 
 state.rmbupID = assignMouseObject("mouse_rup", "rmbup"); 
  
 if ("mouse_obstacle" in state.metadata) { 
  var name = state.metadata["mouse_obstacle"]; 
   
  if (name) { 
   state.obstacleMask = state.objectMasks[name]; 
   if (!state.obstacleMask) { 
    logError(name + " object/alias has to be defined."); 
    state.obstacleMask = state.objectMasks["background"]; 
   } 
  } 
 } 
} 
 
Level.prototype.calcBackgroundMask = function(state) { 
 if (state.backgroundlayer===undefined) { 
   logError("you have to have a background layer"); 
 } 
 
 var backgroundMask = state.layerMasks[state.backgroundlayer]; 
 for (var i=0;i<this.n_tiles;i++) { 
  var cell=this.getCell(i); 
  cell.iand(backgroundMask); 
  if (!cell.iszero()) { 
   return cell; 
  } 
 } 
 cell = new BitVec(STRIDE_OBJ); 
 cell.ibitset(state.backgroundid); 
 return cell; 
} 
 
function levelFromString(state,level) { 
 var backgroundlayer=state.backgroundlayer; 
 var backgroundid=state.backgroundid; 
 var backgroundLayerMask = state.layerMasks[backgroundlayer]; 
 var o = new Level(level[0], level[2].length, level.length-2, state.collisionLayers.length, null, level[1]); 
 o.objects = new Int32Array(o.width * o.height * STRIDE_OBJ); 
 
 for (var i = 0; i < o.width; i++) { 
  for (var j = 0; j < o.height; j++) { 
   var ch = level[j+2].charAt(i); 
   if (ch.length==0) { 
    ch=level[j+2].charAt(level[j+2].length-1); 
   } 
   var mask = state.glyphDict[ch]; 
 
   if (mask == undefined) { 
    if (state.propertiesDict[ch]===undefined) { 
     logError('Error, symbol "' + ch + '", used in map, not found.', level[0]+j); 
    } else { 
     logError('Error, symbol "' + ch + '" is defined using \'or\', and therefore ambiguous - it cannot be used in a map. Did you mean to define it in terms of \'and\'?', level[0]+j);        
    } 
 
   } 
 
   var maskint = new BitVec(STRIDE_OBJ); 
   mask = mask.concat([]);      
   for (var z = 0; z < o.layerCount; z++) { 
    if (mask[z]>=0) { 
     maskint.ibitset(mask[z]); 
    } 
   } 
   for (var w = 0; w < STRIDE_OBJ; ++w) { 
    o.objects[STRIDE_OBJ * (i * o.height + j) + w] = maskint.data[w]; 
   } 
  } 
 } 
 
 var levelBackgroundMask = o.calcBackgroundMask(state); 
 for (var i=0;i<o.n_tiles;i++) 
 { 
  var cell = o.getCell(i); 
  if (!backgroundLayerMask.anyBitsInCommon(cell)) { 
   cell.ior(levelBackgroundMask); 
   o.setCell(i, cell); 
  } 
 } 
 return o; 
} 
//also assigns glyphDict 
function levelsToArray(state) { 
 var levels = state.levels; 
 var processedLevels = []; 
 
 for (var levelIndex = 0; levelIndex < levels.length; levelIndex++) { 
  var level = levels[levelIndex]; 
  if (level.length == 0) { 
   continue; 
  } 
   
  if (level[0] == '\n') { 
 
   var o = { 
    message: level[1], 
    section: level[3] 
   }; 
   splitMessage = wordwrap(o.message,intro_template[0].length); 
   if (splitMessage.length>12){ 
    logWarning('Message too long to fit on screen.', level[2]); 
   } 
 
   processedLevels.push(o); 
  } else { 
   var o = levelFromString(state,level); 
   processedLevels.push(o); 
  } 
 
 } 
 
 state.levels = processedLevels; 
} 
 
function extractSections(state) { 
 var sections = []; 
 
 var lastSection = null; 
 
 for(var i = 0; i < state.levels.length; i++) { 
  var level = state.levels[i]; 
   
  if(level.section != lastSection) { 
   var o = { 
    name: level.section, 
    firstLevel: i 
   }; 
   if(o.name == "__WIN__") { 
    state.winSection = o; 
   } else { 
    sections.push(o); 
   } 
    
   lastSection = level.section; 
  } 
 } 
 
 state.sections = sections; 
} 
 
var directionaggregates = { 
 'horizontal' : ['left', 'right'], 
 'vertical' : ['up', 'down'], 
 'moving' : ['up', 'down', 'left', 'right', 'action'], 
 'orthogonal' : ['up', 'down', 'left', 'right'], 
 'perpendicular' : ['^','v'], 
 'parallel' : ['<','>'] 
}; 
 
var relativeDirections = ['^', 'v', '<', '>','horizontal','vertical']; 
var simpleAbsoluteDirections = ['up', 'down', 'left', 'right']; 
var simpleRelativeDirections = ['^', 'v', '<', '>']; 
var reg_directions_only = /^(\>|\<|\^|v|up|down|left|right|moving|stationary|no|randomdir|random|horizontal|vertical|orthogonal|perpendicular|parallel|action)$/i; 
//redeclaring here, i don't know why 
var commandwords = ["sfx0","sfx1","sfx2","sfx3","sfx4","sfx5","sfx6","sfx7","sfx8","sfx9","sfx10","cancel","checkpoint","restart","win","message","again","undo", 
  "nosave","quit","zoomscreen","flickscreen","smoothscreen","again_interval","realtime_interval","key_repeat_interval",'noundo','norestart','background_color','text_color']; 
function directionalRule(rule) { 
 for (var i=0;i<rule.lhs.length;i++) { 
  var cellRow = rule.lhs[i]; 
  if (cellRow.length>1) { 
   return true; 
  } 
  for (var j=0;j<cellRow.length;j++) { 
   var cell = cellRow[j]; 
   for (var k=0;k<cell.length;k+=2) { 
    if (relativeDirections.indexOf(cell[k])>=0) { 
     return true; 
    } 
   } 
  } 
 } 
 for (var i=0;i<rule.rhs.length;i++) { 
  var cellRow = rule.rhs[i]; 
  if (cellRow.length>1) { 
   return true; 
  } 
  for (var j=0;j<cellRow.length;j++) { 
   var cell = cellRow[j]; 
   for (var k=0;k<cell.length;k+=2) { 
    if (relativeDirections.indexOf(cell[k])>=0) { 
     return true; 
    } 
   } 
  } 
 } 
 return false; 
} 
 
function findIndexAfterToken(str,tokens,tokenIndex){ 
 str=str.toLowerCase(); 
 var curIndex=0; 
 for (var i=0;i<=tokenIndex;i++){ 
  var token = tokens[i].toLowerCase(); 
  curIndex=str.indexOf(token,curIndex)+token.length; 
 } 
 return curIndex; 
} 
 
function processRuleString(rule, state, curRules)  
{ 
/* 
 intermediate structure 
  dirs: Directions[] 
  pre : CellMask[] 
  post : CellMask[] 
  //pre/post pairs must have same lengths 
 final rule structure 
  dir: Direction 
  pre : CellMask[] 
  post : CellMask[] 
*/ 
 var line = rule[0]; 
 var lineNumber = rule[1]; 
 var origLine = rule[2]; 
 
// STEP ONE, TOKENIZE 
 line = line.replace(/\[/g, ' [ ').replace(/\]/g, ' ] ').replace(/\|/g, ' | ').replace(/\-\>/g, ' -> '); 
 line=line.trim(); 
 if (line[0]==='+'){ 
  line = line.substring(0,1)+" "+line.substring(1,line.length); 
 } 
 var tokens = line.split(/\s/).filter(function(v) {return v !== ''}); 
 
 if (tokens.length == 0) { 
  logError('Spooky error!  Empty line passed to rule function.', lineNumber); 
 } 
 
 
// STEP TWO, READ DIRECTIONS 
/* 
 STATE 
 0 - scanning for initial directions 
 LHS 
 1 - reading cell contents LHS 
 2 - reading cell contents RHS 
*/ 
 var parsestate = 0; 
 var directions = []; 
 
 var curcell = null; // [up, cat, down mouse] 
 var curcellrow = []; // [  [up, cat]  [ down, mouse ] ] 
 
 var incellrow = false; 
 
 var appendGroup=false; 
 var rhs = false; 
 var lhs_cells = []; 
 var rhs_cells = []; 
 var late = false; 
 var rigid = false; 
 var groupNumber=lineNumber; 
 var commands=[]; 
 var randomRule=false; 
 var globalRule=false; 
 
 if (tokens.length===1) { 
  if (tokens[0]==="startloop" ) { 
   rule_line = { 
    bracket: 1 
   } 
   return rule_line; 
  } else if (tokens[0]==="endloop" ) { 
   rule_line = { 
    bracket: -1 
   } 
   return rule_line; 
  } 
 } 
 
 if (tokens.indexOf('->') == -1) { 
  logError("A rule has to have an arrow in it.  There's no arrow here! Consider reading up about rules - you're clearly doing something weird", lineNumber); 
 } 
 
 var curcell=[]; 
 for (var i = 0; i < tokens.length; i++) 
 { 
  var token = tokens[i]; 
  switch (parsestate) { 
   case 0: { 
    //read initial directions 
    if (token==='+') {      
     if (groupNumber===lineNumber) { 
      if (curRules.length==0) { 
       logError('The "+" symbol, for joining a rule with the group of the previous rule, needs a previous rule to be applied to.');        
      } 
      if (i!==0) { 
       logError('The "+" symbol, for joining a rule with the group of the previous rule, must be the first symbol on the line '); 
      }       
      groupNumber = curRules[curRules.length-1].groupNumber; 
     } else { 
      logError('Two "+"s ("append to previous rule group" symbol) applied to the same rule.',lineNumber); 
     } 
    } else if (token in directionaggregates) { 
     directions = directions.concat(directionaggregates[token]);       
    } else if (token==='late') { 
      late=true; 
    } else if (token==='rigid') { 
     rigid=true; 
    } else if (token==='random') { 
     randomRule=true; 
    } else if (token==='global') { 
     globalRule=true; 
    }else if (simpleAbsoluteDirections.indexOf(token) >= 0) { 
     directions.push(token); 
    } else if (simpleRelativeDirections.indexOf(token) >= 0) { 
     logError('You cannot use relative directions (\"^v<>\") to indicate in which direction(s) a rule applies.  Use absolute directions indicators (Up, Down, Left, Right, Horizontal, or Vertical, for instance), or, if you want the rule to apply in all four directions, do not specify directions', lineNumber); 
    } else if (token == '[') { 
     if (directions.length == 0) { 
      directions = directions.concat(directionaggregates['orthogonal']); 
     } 
     parsestate = 1; 
     i--; 
    } else { 
     logError("The start of a rule must consist of some number of directions (possibly 0), before the first bracket, specifying in what directions to look (with no direction specified, it applies in all four directions).  It seems you've just entered \"" + token.toUpperCase() + '\".', lineNumber); 
    } 
    break; 
   } 
   case 1: { 
    if (token == '[') { 
     if (curcell.length > 0) { 
      logError('Error, malformed cell rule - encountered a "["" before previous bracket was closed', lineNumber); 
     } 
     incellrow = true; 
     curcell = []; 
    } else if (reg_directions_only.exec(token)) { 
     if (curcell.length % 2 == 1) { 
      logError("Error, an item can only have one direction/action at a time, but you're looking for several at once!", lineNumber); 
     } else if (!incellrow) { 
      logWarning("Invalid syntax. Directions should be placed at the start of a rule.", lineNumber); 
       } else { 
      curcell.push(token); 
     } 
    } else if (token == '|') { 
     if (curcell.length % 2 == 1) { 
      logError('In a rule, if you specify a force, it has to act on an object.', lineNumber); 
     } else { 
      curcellrow.push(curcell); 
      curcell = []; 
     } 
    } else if (token === ']') { 
     if (curcell.length % 2 == 1) { 
      if (curcell[0]==='...') { 
       logError('Cannot end a rule with ellipses.', lineNumber); 
      } else { 
       logError('In a rule, if you specify a force, it has to act on an object.', lineNumber); 
      } 
     } else { 
      curcellrow.push(curcell); 
      curcell = []; 
     } 
 
     if (rhs) { 
      rhs_cells.push(curcellrow); 
     } else { 
      lhs_cells.push(curcellrow); 
     } 
     curcellrow = []; 
     incellrow = false; 
    } else if (token === '->') { 
     if (rhs) { 
      logError('Error, you can only use "->" once in a rule; it\'s used to separate before and after states.', lineNumber); 
     } if (curcellrow.length > 0) { 
      logError('Encountered an unexpected "->" inside square brackets.  It\'s used to separate states, it has no place inside them >:| .', lineNumber); 
     } else { 
      rhs = true; 
     } 
    } else if (state.names.indexOf(token) >= 0) { 
     if (!incellrow) { 
       logWarning("Invalid token "+token.toUpperCase() +". Object names should only be used within cells (square brackets).", lineNumber); 
      } 
      else if (curcell.length % 2 == 0) { 
      curcell.push(''); 
      curcell.push(token); 
     } else if (curcell.length % 2 == 1) { 
      curcell.push(token); 
     } 
    } else if (token==='...') { 
     if (!incellrow) { 
       logWarning("Invalid syntax, ellipses should only be used within cells (square brackets).", lineNumber); 
      } else { 
       curcell.push(token); 
       curcell.push(token); 
      } 
    } else if (commandwords.indexOf(token.toLowerCase())>=0) { 
     if (rhs===false) { 
      logError("Commands cannot appear on the left-hand side of the arrow.",lineNumber); 
     } 
     if (token.toLowerCase()==='message') { 
      var messageIndex = findIndexAfterToken(origLine,tokens,i); 
      var messageStr = origLine.substring(messageIndex).trim(); 
      if (messageStr===""){ 
       messageStr=" "; 
       //needs to be nonempty or the system gets confused and thinks it's a whole level message rather than an interstitial. 
      } 
      commands.push([token.toLowerCase(), messageStr]); 
      i=tokens.length; 
     } else if (twiddleable_params.includes(token.toLowerCase())) { 
      if (!state.metadata.includes("runtime_metadata_twiddling")) { 
       logError("You can only change a flag at runtime if you have the 'runtime_metadata_twiddling' prelude flag defined!",lineNumber) 
      } else { 
       var messageIndex = findIndexAfterToken(origLine,tokens,i); 
       var messageStr = origLine.substring(messageIndex).trim(); 
       if (messageStr===""){ 
        messageStr=" "; 
        //needs to be nonempty or the system gets confused and thinks it's a whole level message rather than an interstitial. 
       } 
       commands.push([token.toLowerCase(), messageStr]); 
      } 
      i=tokens.length; 
     }  else { 
      commands.push([token.toLowerCase()]); 
     } 
    } else { 
     logError('Error, malformed cell rule - was looking for cell contents, but found "' + token + '".  What am I supposed to do with this, eh, please tell me that.', lineNumber); 
    } 
   } 
 
  } 
 } 
 
 if (lhs_cells.length != rhs_cells.length) { 
  if (commands.length>0&&rhs_cells.length==0) { 
   //ok 
  } else { 
   logError('Error, when specifying a rule, the number of matches (square bracketed bits) on the left hand side of the arrow must equal the number on the right', lineNumber); 
  } 
 } else { 
  for (var i = 0; i < lhs_cells.length; i++) { 
   if (lhs_cells[i].length != rhs_cells[i].length) { 
    logError('In a rule, each pattern to match on the left must have a corresponding pattern on the right of equal length (number of cells).', lineNumber); 
   } 
   if (lhs_cells[i].length == 0) { 
    logError("You have an totally empty pattern on the left-hand side.  This will match *everything*.  You certainly don't want this."); 
   } 
  } 
 } 
 
 if (lhs_cells.length == 0) { 
  logError('This rule refers to nothing.  What the heck? :O', lineNumber); 
 } 
 
 var rule_line = { 
  directions: directions, 
  lhs: lhs_cells, 
  rhs: rhs_cells, 
  lineNumber: lineNumber, 
  late: late, 
  rigid: rigid, 
  groupNumber: groupNumber, 
  commands: commands, 
  randomRule: randomRule, 
  globalRule: globalRule 
 }; 
 
 if (directionalRule(rule_line)===false) { 
  rule_line.directions=['up']; 
 } 
 
 /* reset must appear by itself */ 
 
 for (var i=0;i<commands.length;i++) { 
  var cmd = commands[i][0]; 
  if (cmd==='restart') { 
   if (commands.length>1 || rhs_cells.length>0) { 
    logError('The RESTART command can only appear by itself on the right hand side of the arrow.', lineNumber); 
   } 
  } else if (cmd==='cancel') { 
   if (commands.length>1 || rhs_cells.length>0) { 
    logError('The CANCEL command can only appear by itself on the right hand side of the arrow.', lineNumber); 
   } 
  } 
 } 
 
 //next up - replace relative directions with absolute direction 
 
 return rule_line; 
} 
 
function deepCloneHS(HS) { 
 var cloneHS = HS.map(function(arr) {return arr.map(function(deepArr) {return deepArr.slice();});}); 
 return cloneHS; 
} 
 
function deepCloneRule(rule) { 
 var clonedRule = { 
  direction: rule.direction, 
  lhs: deepCloneHS(rule.lhs), 
  rhs: deepCloneHS(rule.rhs), 
  lineNumber: rule.lineNumber, 
  late: rule.late, 
  rigid: rule.rigid, 
  groupNumber: rule.groupNumber, 
  commands:rule.commands, 
  randomRule:rule.randomRule, 
  globalRule:rule.globalRule 
 }; 
 return clonedRule; 
} 
 
function rulesToArray(state) { 
 var oldrules = state.rules; 
 var rules = []; 
 var loops=[]; 
 for (var i = 0; i < oldrules.length; i++) { 
  var lineNumber = oldrules[i][1]; 
  var newrule = processRuleString(oldrules[i], state, rules); 
  if (newrule.bracket!==undefined) { 
   loops.push([lineNumber,newrule.bracket]); 
   continue; 
  } 
  rules.push(newrule); 
 } 
 state.loops=loops; 
 
 //now expand out rules with multiple directions 
 var rules2 = []; 
 for (var i = 0; i < rules.length; i++) { 
  var rule = rules[i]; 
  var ruledirs = rule.directions; 
  for (var j = 0; j < ruledirs.length; j++) { 
   var dir = ruledirs[j]; 
   if (dir in directionaggregates && directionalRule(rule)) { 
    var dirs = directionaggregates[dir]; 
    for (var k = 0; k < dirs.length; k++) { 
     var modifiedrule = deepCloneRule(rule); 
     modifiedrule.direction = dirs[k]; 
     rules2.push(modifiedrule); 
    } 
   } else { 
    var modifiedrule = deepCloneRule(rule); 
    modifiedrule.direction = dir; 
    rules2.push(modifiedrule); 
   } 
  } 
 } 
 
 for (var i = 0; i < rules2.length; i++) { 
  var rule = rules2[i]; 
  //remove relative directions 
  convertRelativeDirsToAbsolute(rule); 
  //optional: replace up/left rules with their down/right equivalents 
  rewriteUpLeftRules(rule); 
  //replace aggregates with what they mean 
  atomizeAggregates(state, rule); 
  //replace synonyms with what they mean 
  rephraseSynonyms(state, rule); 
 } 
 
 var rules3 = []; 
 //expand property rules 
 for (var i = 0; i < rules2.length; i++) { 
  var rule = rules2[i]; 
  rules3 = rules3.concat(concretizeMovingRule(state, rule,rule.lineNumber)); 
 } 
 
 var rules4 = []; 
 for (var i=0;i<rules3.length;i++) { 
  var rule=rules3[i]; 
  rules4 = rules4.concat(concretizePropertyRule(state, rule,rule.lineNumber)); 
 
 } 
 
 state.rules = rules4; 
} 
 
function containsEllipsis(rule) { 
 for (var i=0;i<rule.lhs.length;i++) { 
  for (var j=0;j<rule.lhs[i].length;j++) { 
   if (rule.lhs[i][j][1]==='...') 
    return true; 
  } 
 } 
 return false; 
} 
 
function rewriteUpLeftRules(rule) { 
 if (containsEllipsis(rule)) { 
  return; 
 } 
 
 if (rule.direction == 'up') { 
  rule.direction = 'down'; 
 } else if (rule.direction == 'left') { 
  rule.direction = 'right'; 
 } else { 
  return; 
 } 
 
 for (var i = 0; i < rule.lhs.length; i++) { 
  rule.lhs[i].reverse(); 
  if (rule.rhs.length>0) { 
   rule.rhs[i].reverse(); 
  } 
 } 
} 
 
function getPropertiesFromCell(state,cell ) { 
 var result = []; 
 for (var j = 0; j < cell.length; j += 2) { 
  var dir = cell[j]; 
  var name = cell[j+1]; 
  if (dir=="random") { 
   continue; 
  } 
  if (name in state.propertiesDict) { 
   result.push(name); 
  } 
 } 
 return result; 
} 
 
//returns you a list of object names in that cell that're moving 
function getMovings(state,cell ) { 
 var result = []; 
 for (var j = 0; j < cell.length; j += 2) { 
  var dir = cell[j]; 
  var name = cell[j+1]; 
  if (dir in directionaggregates) { 
   result.push([name,dir]); 
  } 
 } 
 return result; 
} 
 
function concretizePropertyInCell(cell ,property, concreteType) { 
 for (var j = 0; j < cell.length; j += 2) { 
  if (cell[j+1] === property && cell[j]!=="random") { 
   cell[j+1] = concreteType; 
  } 
 } 
} 
 
function concretizeMovingInCell(cell , ambiguousMovement, nameToMove, concreteDirection) { 
 for (var j = 0; j < cell.length; j += 2) { 
  if (cell[j]===ambiguousMovement && cell[j+1] === nameToMove) { 
   cell[j] = concreteDirection; 
  } 
 } 
} 
 
function concretizeMovingInCellByAmbiguousMovementName(cell ,ambiguousMovement, concreteDirection) { 
 for (var j = 0; j < cell.length; j += 2) { 
  if (cell[j] === ambiguousMovement) { 
   cell[j] = concreteDirection; 
  } 
 } 
} 
 
function expandNoPrefixedProperties(state, cell) { 
 var expanded = []; 
 for (var i=0;i<cell.length;i+=2)  { 
  var dir = cell[i]; 
  var name = cell[i+1]; 
 
  if ( dir ==='no' && (name in state.propertiesDict)) { 
   var aliases = state.propertiesDict[name]; 
   for (var j=0;j<aliases.length;j++) { 
    var alias = aliases[j]; 
    expanded.push(dir); 
    expanded.push(alias); 
   } 
  } else { 
   expanded.push(dir); 
   expanded.push(name); 
  }  
 } 
 return expanded; 
} 
 
function concretizePropertyRule(state, rule,lineNumber) {  
 
 //step 1, rephrase rule to change "no flying" to "no cat no bat" 
 for (var i = 0; i < rule.lhs.length; i++) { 
  var cur_cellrow_l = rule.lhs[i]; 
  for (var j=0;j<cur_cellrow_l.length;j++) { 
   cur_cellrow_l[j] = expandNoPrefixedProperties(state,cur_cellrow_l[j]); 
   if (rule.rhs.length > 0) 
    rule.rhs[i][j] = expandNoPrefixedProperties(state,rule.rhs[i][j]); 
  } 
 } 
 
 //are there any properties we could avoid processing? 
 // e.g. [> player | movable] -> [> player | > movable], 
 //   doesn't need to be split up (assuming single-layer player/block aggregates) 
 
 // we can't manage this if they're being used to disambiguate 
 var ambiguousProperties = {}; 
 
 for (var j = 0; j < rule.rhs.length; j++) { 
  var row_l = rule.lhs[j]; 
  var row_r = rule.rhs[j]; 
  for (var k = 0; k < row_r.length; k++) { 
   var properties_l = getPropertiesFromCell(state, row_l[k]); 
   var properties_r = getPropertiesFromCell(state, row_r[k]); 
   for (var prop_n = 0; prop_n < properties_r.length; prop_n++) { 
    var property = properties_r[prop_n]; 
    if (properties_l.indexOf(property) == -1) { 
     ambiguousProperties[property] = true; 
    } 
   } 
  } 
 } 
 
 var shouldremove; 
 var result = [rule]; 
 var modified=true; 
 while (modified) { 
  modified = false; 
  for (var i = 0; i < result.length; i++) { 
   //only need to iterate through lhs 
   var cur_rule = result[i]; 
   shouldremove = false; 
   for (var j = 0; j < cur_rule.lhs.length&&!shouldremove; j++) { 
    var cur_rulerow = cur_rule.lhs[j]; 
    for (var k = 0; k < cur_rulerow.length&&!shouldremove; k++) { 
     var cur_cell = cur_rulerow[k]; 
     var properties = getPropertiesFromCell(state, cur_cell); 
     for (var prop_n = 0; prop_n < properties.length; ++prop_n) { 
      var property = properties[prop_n]; 
 
      if (state.propertiesSingleLayer.hasOwnProperty(property) && 
       ambiguousProperties[property] !== true) { 
       // we don't need to explode this property 
       continue; 
      } 
 
      var aliases = state.propertiesDict[property]; 
 
      shouldremove = true; 
      modified = true; 
 
      //just do the base property, let future iterations take care of the others 
 
      for (var l = 0; l < aliases.length; l++) { 
       var concreteType = aliases[l]; 
       var newrule = deepCloneRule(cur_rule); 
       newrule.propertyReplacement={}; 
       for(var prop in cur_rule.propertyReplacement) { 
        if (cur_rule.propertyReplacement.hasOwnProperty(prop)) { 
         var propDat = cur_rule.propertyReplacement[prop]; 
         newrule.propertyReplacement[prop] = [propDat[0],propDat[1]]; 
        } 
       } 
 
       concretizePropertyInCell(newrule.lhs[j][k], property, concreteType); 
       if (newrule.rhs.length>0) { 
        concretizePropertyInCell(newrule.rhs[j][k], property, concreteType);//do for the corresponding rhs cell as well 
       } 
                             
                            if (newrule.propertyReplacement[property]===undefined) { 
           newrule.propertyReplacement[property]=[concreteType,1]; 
                            } else { 
           newrule.propertyReplacement[property][1]=newrule.propertyReplacement[property][1]+1;                                 
                            } 
 
       result.push(newrule); 
      } 
 
      break; 
     } 
    } 
   } 
   if (shouldremove) 
   { 
    result.splice(i, 1); 
    i--; 
   } 
  } 
 } 
 
     
 for (var i = 0; i < result.length; i++) { 
        //for each rule 
  var cur_rule = result[i]; 
        if (cur_rule.propertyReplacement===undefined) { 
            continue; 
        } 
         
        //for each property replacement in that rule 
        for (var property in cur_rule.propertyReplacement) { 
            if (cur_rule.propertyReplacement.hasOwnProperty(property)) { 
             var replacementInfo = cur_rule.propertyReplacement[property]; 
             var concreteType = replacementInfo[0]; 
             var occurrenceCount = replacementInfo[1]; 
             if (occurrenceCount===1) { 
              //do the replacement 
     for (var j=0;j<cur_rule.rhs.length;j++) { 
      var cellRow_rhs = cur_rule.rhs[j]; 
      for (var k=0;k<cellRow_rhs.length;k++) { 
       var cell=cellRow_rhs[k]; 
       concretizePropertyInCell(cell, property, concreteType); 
      } 
     } 
             } 
            } 
        } 
 } 
 
 //if any properties remain on the RHSes, bleep loudly 
 var rhsPropertyRemains = ''; 
 for (var i = 0; i < result.length; i++) { 
  var cur_rule = result[i]; 
  delete result.propertyReplacement; 
  for (var j = 0; j < cur_rule.rhs.length; j++) { 
   var cur_rulerow = cur_rule.rhs[j]; 
   for (var k = 0; k < cur_rulerow.length; k++) { 
    var cur_cell = cur_rulerow[k]; 
    var properties = getPropertiesFromCell(state, cur_cell); 
    for (var prop_n = 0; prop_n < properties.length; prop_n++) { 
     if (ambiguousProperties.hasOwnProperty(properties[prop_n])) { 
      rhsPropertyRemains = properties[prop_n]; 
     } 
    } 
   } 
  } 
 } 
 
 
 if (rhsPropertyRemains.length > 0) { 
  logError('This rule has a property on the right-hand side, \"'+ rhsPropertyRemains.toUpperCase() + "\", that can't be inferred from the left-hand side.  (either for every property on the right there has to be a corresponding one on the left in the same cell, OR, if there's a single occurrence of a particular property name on the left, all properties of the same name on the right are assumed to be the same).",lineNumber); 
 } 
 
 return result; 
} 
 
 
function concretizeMovingRule(state, rule,lineNumber) {  
 
 var shouldremove; 
 var result = [rule]; 
 var modified=true; 
 while (modified) { 
  modified = false; 
  for (var i = 0; i < result.length; i++) { 
   //only need to iterate through lhs 
   var cur_rule = result[i]; 
   shouldremove = false; 
   for (var j = 0; j < cur_rule.lhs.length; j++) { 
    var cur_rulerow = cur_rule.lhs[j]; 
    for (var k = 0; k < cur_rulerow.length; k++) { 
     var cur_cell = cur_rulerow[k]; 
     var movings = getMovings(state, cur_cell); 
     if (movings.length > 0) { 
      shouldremove = true; 
      modified = true; 
 
      //just do the base property, let future iterations take care of the others 
      var cand_name = movings[0][0]; 
      var ambiguous_dir = movings[0][1]; 
      var concreteDirs = directionaggregates[ambiguous_dir]; 
      for (var l = 0; l < concreteDirs.length; l++) { 
       var concreteDirection = concreteDirs[l]; 
       var newrule = deepCloneRule(cur_rule); 
 
       newrule.movingReplacement={}; 
       for(var moveTerm in cur_rule.movingReplacement) { 
        if (cur_rule.movingReplacement.hasOwnProperty(moveTerm)) { 
         var moveDat = cur_rule.movingReplacement[moveTerm]; 
         newrule.movingReplacement[moveTerm] = [moveDat[0],moveDat[1],moveDat[2]]; 
        } 
       } 
 
       concretizeMovingInCell(newrule.lhs[j][k], ambiguous_dir, cand_name, concreteDirection); 
       if (newrule.rhs.length>0) { 
        concretizeMovingInCell(newrule.rhs[j][k], ambiguous_dir, cand_name, concreteDirection);//do for the corresponding rhs cell as well 
       } 
                             
                            if (newrule.movingReplacement[cand_name]===undefined) { 
           newrule.movingReplacement[cand_name]=[concreteDirection,1,ambiguous_dir]; 
                            } else { 
           newrule.movingReplacement[cand_name][1]=newrule.movingReplacement[cand_name][1]+1;                                 
                            } 
 
       result.push(newrule); 
      } 
     } 
    } 
   } 
   if (shouldremove) 
   { 
    result.splice(i, 1); 
    i--; 
   } 
  } 
 } 
 
     
 for (var i = 0; i < result.length; i++) { 
        //for each rule 
  var cur_rule = result[i]; 
        if (cur_rule.movingReplacement===undefined) { 
            continue; 
        } 
        var ambiguous_movement_dict={}; 
        //strict first - matches movement direction to objects 
        //for each property replacement in that rule 
        for (var cand_name in cur_rule.movingReplacement) { 
            if (cur_rule.movingReplacement.hasOwnProperty(cand_name)) { 
             var replacementInfo = cur_rule.movingReplacement[cand_name]; 
             var concreteMovement = replacementInfo[0]; 
             var occurrenceCount = replacementInfo[1]; 
             var ambiguousMovement = replacementInfo[2]; 
             if ((ambiguousMovement in ambiguous_movement_dict) || (occurrenceCount!==1)) { 
              ambiguous_movement_dict[ambiguousMovement] = "INVALID"; 
             } else { 
              ambiguous_movement_dict[ambiguousMovement] = concreteMovement 
             } 
 
             if (occurrenceCount===1) { 
              //do the replacement 
     for (var j=0;j<cur_rule.rhs.length;j++) { 
      var cellRow_rhs = cur_rule.rhs[j]; 
      for (var k=0;k<cellRow_rhs.length;k++) { 
       var cell=cellRow_rhs[k]; 
       concretizeMovingInCell(cell, ambiguousMovement, cand_name, concreteMovement); 
      } 
     } 
             } 
            } 
        } 
 
        //for each ambiguous word, if there's a single ambiguous movement specified in the whole lhs, then replace that wholesale 
        for(var ambiguousMovement in ambiguous_movement_dict) { 
         if (ambiguous_movement_dict.hasOwnProperty(ambiguousMovement) && ambiguousMovement!=="INVALID") { 
          concreteMovement = ambiguous_movement_dict[ambiguousMovement]; 
          if (concreteMovement==="INVALID"){ 
        continue; 
          } 
    for (var j=0;j<cur_rule.rhs.length;j++) { 
     var cellRow_rhs = cur_rule.rhs[j]; 
     for (var k=0;k<cellRow_rhs.length;k++) { 
      var cell=cellRow_rhs[k]; 
      concretizeMovingInCellByAmbiguousMovementName(cell, ambiguousMovement, concreteMovement); 
     } 
    } 
         } 
        } 
 } 
 
 //if any properties remain on the RHSes, bleep loudly 
 var rhsAmbiguousMovementsRemain = ''; 
 for (var i = 0; i < result.length; i++) { 
  var cur_rule = result[i]; 
  delete result.movingReplacement; 
  for (var j = 0; j < cur_rule.rhs.length; j++) { 
   var cur_rulerow = cur_rule.rhs[j]; 
   for (var k = 0; k < cur_rulerow.length; k++) { 
    var cur_cell = cur_rulerow[k]; 
    var movings = getMovings(state, cur_cell); 
    if (movings.length > 0) { 
     rhsAmbiguousMovementsRemain = movings[0][1];      
    } 
   } 
  } 
 } 
 
 
 if (rhsAmbiguousMovementsRemain.length > 0) { 
  logError('This rule has an ambiguous movement on the right-hand side, \"'+ rhsAmbiguousMovementsRemain + "\", that can't be inferred from the left-hand side.  (either for every ambiguous movement associated to an entity on the right there has to be a corresponding one on the left attached to the same entity, OR, if there's a single occurrence of a particular ambiguous movement on the left, all properties of the same movement attached to the same object on the right are assumed to be the same (or something like that)).",lineNumber); 
 } 
 
 return result; 
} 
 
function rephraseSynonyms(state,rule) { 
 for (var i = 0; i < rule.lhs.length; i++) { 
  var cellrow_l = rule.lhs[i]; 
  var cellrow_r = rule.rhs[i]; 
  for (var j = 0; j < cellrow_l.length; j++) { 
   var cell_l = cellrow_l[j]; 
   for (var k = 1; k < cell_l.length; k += 2) { 
    var name = cell_l[k]; 
    if (name in state.synonymsDict) { 
     cell_l[k] = state.synonymsDict[cell_l[k]]; 
    } 
   } 
   if (rule.rhs.length>0) { 
    var cell_r = cellrow_r[j]; 
    for (var k = 1; k < cell_r.length; k += 2) { 
     var name = cell_r[k]; 
     if (name in state.synonymsDict) { 
      cell_r[k] = state.synonymsDict[cell_r[k]]; 
     } 
    } 
   } 
  } 
 } 
} 
 
function atomizeAggregates(state, rule) { 
 for (var i = 0; i < rule.lhs.length; i++) { 
  var cellrow = rule.lhs[i]; 
  for (var j = 0; j < cellrow.length; j++) { 
   var cell = cellrow[j]; 
   atomizeCellAggregates(state, cell,rule.lineNumber); 
  } 
 } 
 for (var i = 0; i < rule.rhs.length; i++) { 
  var cellrow = rule.rhs[i]; 
  for (var j = 0; j < cellrow.length; j++) { 
   var cell = cellrow[j]; 
   atomizeCellAggregates(state, cell,rule.lineNumber); 
  } 
 } 
} 
 
function atomizeCellAggregates(state, cell, lineNumber) { 
 for (var i = 0; i < cell.length; i += 2) { 
  var dir =cell[i]; 
  var c = cell[i+1]; 
  if (c in state.aggregatesDict) { 
   if (dir==='no') { 
    logError("You cannot use 'no' to exclude the aggregate object " +c.toUpperCase()+" (defined using 'AND'), only regular objects, or properties (objects defined using 'OR').  If you want to do this, you'll have to write it out yourself the long way.",lineNumber); 
   } 
   var equivs = state.aggregatesDict[c]; 
   cell[i+1] = equivs[0]; 
   for (var j= 1; j < equivs.length; j++) { 
    cell.push(cell[i]);//push the direction 
    cell.push(equivs[j]); 
   } 
  } 
 } 
} 
 
function convertRelativeDirsToAbsolute(rule) { 
 var forward = rule.direction; 
 for (var i = 0; i < rule.lhs.length; i++) { 
  var cellrow = rule.lhs[i]; 
  for (var j = 0; j < cellrow.length; j++) { 
   var cell = cellrow[j]; 
   absolutifyRuleCell(forward, cell); 
  } 
 } 
 for (var i = 0; i < rule.rhs.length; i++) { 
  var cellrow = rule.rhs[i]; 
  for (var j = 0; j < cellrow.length; j++) { 
   var cell = cellrow[j]; 
   absolutifyRuleCell(forward, cell); 
  } 
 } 
} 
 
var relativeDirs = ['^','v','<','>','parallel','perpendicular'];//used to index the following 
var relativeDict = { 
 'right': ['up', 'down', 'left', 'right','horizontal','vertical'], 
 'up': ['left', 'right', 'down', 'up','vertical','horizontal'], 
 'down': ['right', 'left', 'up', 'down','vertical','horizontal'], 
 'left': ['down', 'up', 'right', 'left','horizontal','vertical'] 
}; 
 
function absolutifyRuleCell(forward, cell) { 
 for (var i = 0; i < cell.length; i += 2) { 
  var c = cell[i]; 
  var index = relativeDirs.indexOf(c); 
  if (index >= 0) { 
   cell[i] = relativeDict[forward][index];   
  } 
 } 
} 
/* 
 direction mask 
 UP parseInt('%1', 2); 
 DOWN parseInt('0', 2); 
 LEFT parseInt('0', 2); 
 RIGHT parseInt('0', 2); 
 ?  parseInt('', 2); 
*/ 
 
var dirMasks = { 
 'up' : parseInt('00001', 2), 
 'down' : parseInt('00010', 2), 
 'left' : parseInt('00100', 2), 
 'right' : parseInt('01000', 2), 
 'moving': parseInt('01111', 2), 
 'no' : parseInt('00011', 2), 
 'randomdir': parseInt('00101', 2), 
 'random' : parseInt('10010',2), 
 'action' : parseInt('10000', 2), 
 '' : parseInt('00000',2) 
}; 
 
function rulesToMask(state) { 
 /* 
 */ 
 var layerCount = state.collisionLayers.length; 
 var layerTemplate = []; 
 for (var i = 0; i < layerCount; i++) { 
  layerTemplate.push(null); 
 } 
 
 for (var i = 0; i < state.rules.length; i++) { 
  var rule = state.rules[i]; 
  for (var j = 0; j < rule.lhs.length; j++) { 
   var cellrow_l = rule.lhs[j]; 
   var cellrow_r = rule.rhs[j]; 
   for (var k = 0; k < cellrow_l.length; k++) { 
    var cell_l = cellrow_l[k]; 
    var layersUsed_l = layerTemplate.concat([]); 
    var objectsPresent = new BitVec(STRIDE_OBJ); 
    var objectsMissing = new BitVec(STRIDE_OBJ); 
    var anyObjectsPresent = []; 
    var movementsPresent = new BitVec(STRIDE_MOV); 
    var movementsMissing = new BitVec(STRIDE_MOV); 
 
    var objectlayers_l = new BitVec(STRIDE_MOV); 
    for (var l = 0; l < cell_l.length; l += 2) { 
     var object_dir = cell_l[l]; 
     if (object_dir==='...') { 
      objectsPresent = ellipsisPattern; 
      if (cell_l.length!==2) { 
       logError("You can't have anything in with an ellipsis. Sorry.",rule.lineNumber); 
      } else if ((k===0)||(k===cellrow_l.length-1)) { 
       logError("There's no point in putting an ellipsis at the very start or the end of a rule",rule.lineNumber); 
      } else if (rule.rhs.length>0) { 
       var rhscell=cellrow_r[k]; 
       if (rhscell.length!==2 || rhscell[0]!=='...') { 
        logError("An ellipsis on the left must be matched by one in the corresponding place on the right.",rule.lineNumber);         
       } 
      }  
      break; 
     }  else if (object_dir==='random') { 
      logError("'random' cannot be matched on the left-hand side, it can only appear on the right",rule.lineNumber); 
      continue; 
     } 
 
     var object_name = cell_l[l + 1]; 
     var object = state.objects[object_name]; 
     var objectMask = state.objectMasks[object_name]; 
     if (object) { 
      var layerIndex = object.layer|0; 
     } else { 
      var layerIndex = state.propertiesSingleLayer[object_name]; 
     } 
 
     if (typeof(layerIndex)==="undefined"){ 
      logError("Oops!  " +object_name.toUpperCase()+" not assigned to a layer.",rule.lineNumber); 
     } 
 
     if (object_dir==='no') { 
      objectsMissing.ior(objectMask); 
     } else { 
      var existingname = layersUsed_l[layerIndex]; 
      if (existingname !== null) { 
       logError('Rule matches object types that can\'t overlap: "' + object_name.toUpperCase() + '" and "' + existingname.toUpperCase() + '".', rule.lineNumber); 
      } 
 
      layersUsed_l[layerIndex] = object_name; 
 
      if (object) { 
       objectsPresent.ior(objectMask); 
       objectlayers_l.ishiftor(0x1f, 5*layerIndex); 
      } else { 
       anyObjectsPresent.push(objectMask); 
      } 
 
      if (object_dir==='stationary') { 
       movementsMissing.ishiftor(0x1f, 5*layerIndex); 
      } else { 
       movementsPresent.ishiftor(dirMasks[object_dir], 5 * layerIndex); 
      } 
     } 
    } 
 
    if (rule.rhs.length>0) { 
     var rhscell = cellrow_r[k]; 
     var lhscell = cellrow_l[k]; 
     if (rhscell[0]==='...' && lhscell[0]!=='...' ) { 
      logError("An ellipsis on the right must be matched by one in the corresponding place on the left.",rule.lineNumber);         
     } 
     for (var l=0;l<rhscell.length;l+=2) { 
      var content=rhscell[l]; 
      if (content==='...') { 
       if (rhscell.length!==2) { 
        logError("You can't have anything in with an ellipsis. Sorry.",rule.lineNumber);        
       } 
      } 
     } 
    } 
 
    if (objectsPresent === ellipsisPattern) { 
     cellrow_l[k] = ellipsisPattern; 
     continue; 
    } else { 
     cellrow_l[k] = new CellPattern([objectsPresent, objectsMissing, anyObjectsPresent, movementsPresent, movementsMissing, null]); 
    } 
 
    if (rule.rhs.length===0) { 
     continue; 
    } 
 
    var cell_r = cellrow_r[k]; 
    var layersUsed_r = layerTemplate.concat([]); 
    var layersUsedRand_r = layerTemplate.concat([]); 
 
    var objectsClear = new BitVec(STRIDE_OBJ); 
    var objectsSet = new BitVec(STRIDE_OBJ); 
    var movementsClear = new BitVec(STRIDE_MOV); 
    var movementsSet = new BitVec(STRIDE_MOV); 
 
    var objectlayers_r = new BitVec(STRIDE_MOV); 
    var randomMask_r = new BitVec(STRIDE_OBJ); 
    var postMovementsLayerMask_r = new BitVec(STRIDE_MOV); 
    var randomDirMask_r = new BitVec(STRIDE_MOV); 
    for (var l = 0; l < cell_r.length; l += 2) { 
     var object_dir = cell_r[l]; 
     var object_name = cell_r[l + 1]; 
 
     if (object_dir==='...') { 
      //logError("spooky ellipsis found! (should never hit this)"); 
      break; 
     } else if (object_dir==='random') { 
      if (object_name in state.objectMasks) { 
       var mask = state.objectMasks[object_name]; 
        randomMask_r.ior(mask); 
        var values; 
        if (state.propertiesDict.hasOwnProperty(object_name)) { 
         values = state.propertiesDict[object_name]; 
        } else { 
         values = [object_name]; 
        } 
        for (var m = 0; m < values.length; m++) { 
         var subobject = values[m]; 
         var layerIndex = state.objects[subobject].layer|0; 
         var existingname = layersUsed_r[layerIndex]; 
         if (existingname !== null) { 
          var o1 = subobject.toUpperCase(); 
          var o2 = existingname.toUpperCase(); 
          if (o1!==o2) { 
           logWarning("This rule may try to spawn a "+o1+" with random, but also requires a "+o2+" be here, which is on the same layer - they shouldn't be able to coexist!", rule.lineNumber);           
          } 
         } 
  
         layersUsedRand_r[layerIndex] = subobject; 
        }                       
 
      } else { 
       logError('You want to spawn a random "'+object_name.toUpperCase()+'", but I don\'t know how to do that',rule.lineNumber); 
      } 
      continue; 
     } 
 
     var object = state.objects[object_name]; 
     var objectMask = state.objectMasks[object_name]; 
     if (object) { 
      var layerIndex = object.layer|0; 
     } else { 
      var layerIndex = state.propertiesSingleLayer[object_name]; 
     } 
 
      
     if (object_dir=='no') { 
      objectsClear.ior(objectMask); 
     } else { 
      var existingname = layersUsed_r[layerIndex]; 
      if (existingname === null) { 
        existingname = layersUsedRand_r[layerIndex]; 
       } 
 
      if (existingname !== null) { 
       logError('Rule matches object types that can\'t overlap: "' + object_name.toUpperCase() + '" and "' + existingname.toUpperCase() + '".', rule.lineNumber); 
      } 
 
      layersUsed_r[layerIndex] = object_name; 
 
      if (object_dir.length>0) { 
       postMovementsLayerMask_r.ishiftor(0x1f, 5*layerIndex); 
      } 
 
      var layerMask = state.layerMasks[layerIndex]; 
 
      if (object) { 
       objectsSet.ibitset(object.id); 
       objectsClear.ior(layerMask); 
       objectlayers_r.ishiftor(0x1f, 5*layerIndex); 
      } else { 
       // shouldn't need to do anything here... 
      } 
      if (object_dir==='stationary') { 
       movementsClear.ishiftor(0x1f, 5*layerIndex); 
      } if (object_dir==='randomdir') { 
       randomDirMask_r.ishiftor(dirMasks[object_dir], 5 * layerIndex); 
      } else {       
       movementsSet.ishiftor(dirMasks[object_dir], 5 * layerIndex); 
      }; 
     } 
    } 
 
    if (!(objectsPresent.bitsSetInArray(objectsSet.data))) { 
     objectsClear.ior(objectsPresent); // clear out old objects 
    } 
    if (!(movementsPresent.bitsSetInArray(movementsSet.data))) { 
     movementsClear.ior(movementsPresent); // ... and movements 
    } 
 
    for (var l = 0; l < layerCount; l++) { 
     if (layersUsed_l[l] !== null && layersUsed_r[l] === null) { 
      // a layer matched on the lhs, but not on the rhs 
      objectsClear.ior(state.layerMasks[l]); 
      postMovementsLayerMask_r.ishiftor(0x1f, 5*l); 
     } 
    } 
 
    objectlayers_l.iclear(objectlayers_r); 
 
    postMovementsLayerMask_r.ior(objectlayers_l); 
    if (objectsClear || objectsSet || movementsClear || movementsSet || postMovementsLayerMask_r) { 
     // only set a replacement if something would change 
     cellrow_l[k].replacement = new CellReplacement([objectsClear, objectsSet, movementsClear, movementsSet, postMovementsLayerMask_r, randomMask_r, randomDirMask_r]); 
    } 
   } 
  } 
 } 
} 
 
function cellRowMasks(rule) { 
 var ruleMasks=[]; 
 var lhs=rule[1]; 
 for (var i=0;i<lhs.length;i++) { 
  var cellRow = lhs[i]; 
  var rowMask=new BitVec(STRIDE_OBJ); 
  for (var j=0;j<cellRow.length;j++) { 
   if (cellRow[j] === ellipsisPattern) 
    continue; 
   rowMask.ior(cellRow[j].objectsPresent); 
  } 
  ruleMasks.push(rowMask); 
 } 
 return ruleMasks; 
} 
 
function collapseRules(groups) { 
 for (var gn = 0; gn < groups.length; gn++) { 
  var rules = groups[gn]; 
  for (var i = 0; i < rules.length; i++) { 
   var oldrule = rules[i]; 
   var newrule = [0,[],oldrule.rhs.length>0,oldrule.lineNumber/*ellipses,group number,rigid,commands,randomrule,[cellrowmasks]*/]; 
   var ellipses = []; 
   for (var j=0;j<oldrule.lhs.length;j++) { 
    ellipses.push(false); 
   } 
 
   newrule[0]=dirMasks[oldrule.direction]; 
   for (var j = 0; j < oldrule.lhs.length; j++) { 
    var cellrow_l = oldrule.lhs[j]; 
    for (var k = 0; k < cellrow_l.length; k++) { 
     if (cellrow_l[k] === ellipsisPattern) { 
      if (ellipses[j]) { 
       logError("You can't use two ellipses in a single cell match pattern.  If you really want to, please implement it yourself and send me a patch :) ", oldrule.lineNumber); 
      }  
      ellipses[j]=true; 
     } 
    } 
    newrule[1][j] = cellrow_l; 
   } 
   newrule.push(ellipses); 
   newrule.push(oldrule.groupNumber); 
   newrule.push(oldrule.rigid); 
   newrule.push(oldrule.commands); 
   newrule.push(oldrule.randomRule);    
   newrule.push(cellRowMasks(newrule)); 
   newrule.push(oldrule.globalRule); 
   rules[i] = new Rule(newrule); 
  } 
 } 
 matchCache = {}; // clear match cache so we don't slowly leak memory 
} 
 
function ruleGroupRandomnessTest(ruleGroup) { 
 if (ruleGroup.length === 0) 
  return; 
 var firstLineNumber = ruleGroup[0].lineNumber; 
 for (var i=1;i<ruleGroup.length;i++) { 
  var rule=ruleGroup[i]; 
  if (rule.lineNumber === firstLineNumber) // random [A | B] gets turned into 4 rules, skip 
   continue; 
  if (rule.randomRule) { 
   logError("A rule-group can only be marked random by the first rule", rule.lineNumber); 
  } 
 } 
} 
 
function arrangeRulesByGroupNumber(state) { 
 var aggregates = {}; 
 var aggregates_late = {}; 
 for (var i=0;i<state.rules.length;i++) { 
  var rule = state.rules[i]; 
  var targetArray = aggregates; 
  if (rule.late) { 
   targetArray=aggregates_late; 
  } 
 
  if (targetArray[rule.groupNumber]==undefined) { 
   targetArray[rule.groupNumber]=[]; 
  } 
  targetArray[rule.groupNumber].push(rule); 
 } 
 
 var result=[]; 
 for (var groupNumber in aggregates) { 
  if (aggregates.hasOwnProperty(groupNumber)) { 
   var ruleGroup = aggregates[groupNumber]; 
   ruleGroupRandomnessTest(ruleGroup); 
   result.push(ruleGroup); 
  } 
 } 
 var result_late=[]; 
 for (var groupNumber in aggregates_late) { 
  if (aggregates_late.hasOwnProperty(groupNumber)) { 
   var ruleGroup = aggregates_late[groupNumber]; 
   ruleGroupRandomnessTest(ruleGroup); 
   result_late.push(ruleGroup); 
  } 
 } 
 state.rules=result; 
 
 //check that there're no late movements with direction requirements on the lhs 
 state.lateRules=result_late; 
} 
 
 
function checkNoLateRulesHaveMoves(state){ 
 for (var ruleGroupIndex=0;ruleGroupIndex<state.lateRules.length;ruleGroupIndex++) { 
  var lateGroup = state.lateRules[ruleGroupIndex]; 
  for (var ruleIndex=0;ruleIndex<lateGroup.length;ruleIndex++) { 
   var rule = lateGroup[ruleIndex]; 
   for (var cellRowIndex=0;cellRowIndex<rule.patterns.length;cellRowIndex++) { 
    var cellRow_l = rule.patterns[cellRowIndex]; 
    for (var cellIndex=0;cellIndex<cellRow_l.length;cellIndex++) { 
     var cellPattern = cellRow_l[cellIndex]; 
     if (cellPattern === ellipsisPattern) { 
      continue; 
     } 
     var moveMissing = cellPattern.movementsMissing; 
     var movePresent = cellPattern.movementsPresent; 
     if (!moveMissing.iszero() || !movePresent.iszero()) { 
      logError("Movements cannot appear in late rules.",rule.lineNumber); 
      return; 
     } 
 
     if (cellPattern.replacement!=null) { 
      var movementsClear = cellPattern.replacement.movementsClear; 
      var movementsSet = cellPattern.replacement.movementsSet; 
 
      if (!movementsClear.iszero() || !movementsSet.iszero()) { 
       logError("Movements cannot appear in late rules.",rule.lineNumber); 
       return; 
      } 
     }     
    } 
   } 
  } 
 } 
} 
 
function generateRigidGroupList(state) { 
 var rigidGroupIndex_to_GroupIndex=[]; 
 var groupIndex_to_RigidGroupIndex=[]; 
 var groupNumber_to_GroupIndex=[]; 
 var groupNumber_to_RigidGroupIndex=[]; 
 var rigidGroups=[]; 
 for (var i=0;i<state.rules.length;i++) { 
  var ruleset=state.rules[i]; 
  var rigidFound=false; 
  for (var j=0;j<ruleset.length;j++) { 
   var rule=ruleset[j]; 
   if (rule.isRigid) { 
    rigidFound=true; 
   } 
  } 
  rigidGroups[i]=rigidFound; 
  if (rigidFound) { 
   var groupNumber=ruleset[0].groupNumber; 
   groupNumber_to_GroupIndex[groupNumber]=i; 
   var rigid_group_index = rigidGroupIndex_to_GroupIndex.length; 
   groupIndex_to_RigidGroupIndex[i]=rigid_group_index; 
   groupNumber_to_RigidGroupIndex[groupNumber]=rigid_group_index; 
   rigidGroupIndex_to_GroupIndex.push(i); 
  } 
 } 
 if (rigidGroupIndex_to_GroupIndex.length>60) { 
  logError("There can't be more than 60 rigid groups (rule groups containing rigid members).",rules[0][0][3]); 
 } 
 
 state.rigidGroups=rigidGroups; 
 state.rigidGroupIndex_to_GroupIndex=rigidGroupIndex_to_GroupIndex; 
 state.groupNumber_to_RigidGroupIndex=groupNumber_to_RigidGroupIndex; 
 state.groupIndex_to_RigidGroupIndex=groupIndex_to_RigidGroupIndex; 
} 
 
function getMaskFromName(state,name) { 
 var objectMask=new BitVec(STRIDE_OBJ); 
 if (name in state.objects) { 
  var o=state.objects[name]; 
  objectMask.ibitset(o.id); 
 } 
 
 if (name in state.aggregatesDict) { 
  var objectnames = state.aggregatesDict[name]; 
  for(var i=0;i<objectnames.length;i++) { 
   var n=objectnames[i]; 
   var o = state.objects[n]; 
   objectMask.ibitset(o.id); 
  } 
 } 
 
 if (name in state.propertiesDict) { 
  var objectnames = state.propertiesDict[name]; 
  for(var i=0;i<objectnames.length;i++) { 
   var n = objectnames[i]; 
   var o = state.objects[n]; 
   objectMask.ibitset(o.id); 
  } 
 } 
 
 if (name in state.synonymsDict) { 
  var n = state.synonymsDict[name]; 
  var o = state.objects[n]; 
  objectMask.ibitset(o.id); 
 } 
 
 if (!state.metadata.includes("nokeyboard") && objectMask.iszero()) { 
  logErrorNoLine("error, didn't find any object called player, either in the objects section, or the legends section. there must be a player!"); 
 } 
 return objectMask; 
} 
 
function generateMasks(state) { 
 state.playerMask=getMaskFromName(state,'player'); 
 
 var layerMasks=[]; 
 var layerCount = state.collisionLayers.length; 
 for (var layer=0;layer<layerCount;layer++){ 
  var layerMask=new BitVec(STRIDE_OBJ); 
  for (var j=0;j<state.objectCount;j++) { 
   var n=state.idDict[j]; 
   var o = state.objects[n]; 
   if (o.layer==layer) { 
    layerMask.ibitset(o.id); 
   } 
  } 
  layerMasks.push(layerMask); 
 } 
 state.layerMasks=layerMasks; 
 
 var objectMask={}; 
 for(var n in state.objects) { 
  if (state.objects.hasOwnProperty(n)) { 
   var o = state.objects[n]; 
   objectMask[n] = new BitVec(STRIDE_OBJ); 
   objectMask[n].ibitset(o.id); 
  } 
 } 
 
 // Synonyms can depend on properties, and properties can depend on synonyms. 
 // Process them in order by combining & sorting by linenumber. 
 
 var synonyms_and_properties = state.legend_synonyms.concat(state.legend_properties); 
 synonyms_and_properties.sort(function(a, b) { 
  return a.lineNumber - b.lineNumber; 
 }); 
 
 for (var i=0;i<synonyms_and_properties.length;i++) { 
  var synprop = synonyms_and_properties[i]; 
  if (synprop.length == 2) { 
   // synonym (a = b) 
   objectMask[synprop[0]]=objectMask[synprop[1]]; 
  } else { 
   // property (a = b or c) 
   var val = new BitVec(STRIDE_OBJ); 
   for (var j=1;j<synprop.length;j++) { 
    var n = synprop[j]; 
    val.ior(objectMask[n]); 
   } 
   objectMask[synprop[0]]=val; 
  } 
 } 
 
 state.objectMasks = objectMask; 
} 
 
function checkObjectsAreLayered(state) { 
 for (var n in state.objects) { 
  if (state.objects.hasOwnProperty(n)) { 
   var found=false; 
   for (var i=0;i<state.collisionLayers.length;i++) { 
    var layer = state.collisionLayers[i]; 
    for (var j=0;j<layer.length;j++) { 
     if (layer[j]===n) { 
      found=true; 
      break; 
     } 
    } 
    if (found) { 
     break; 
    } 
   } 
   if (found===false) { 
    var o = state.objects[n]; 
    logError('Object "' + n.toUpperCase() + '" has been defined, but not assigned to a layer.',o.lineNumber); 
   } 
  } 
 } 
} 
 
function twiddleMetaData(state, update = false) { 
 var newmetadata; 
 
 if (!update) { 
  newmetadata = {}; 
  for (var i=0;i<state.metadata.length;i+=2) { 
   var key = state.metadata[i]; 
   var val = state.metadata[i+1]; 
   newmetadata[key]=val; 
  } 
 } else { 
  newmetadata = state.metadata; 
 } 
 
 if (newmetadata.flickscreen!==undefined) { 
  var val = newmetadata.flickscreen; 
  var coords = val.split('x'); 
  var intcoords = [parseInt(coords[0]),parseInt(coords[1])]; 
  newmetadata.flickscreen=intcoords; 
 } 
 if (newmetadata.zoomscreen!==undefined) { 
  var val = newmetadata.zoomscreen; 
  var coords = val.split('x'); 
  var intcoords = [parseInt(coords[0]),parseInt(coords[1])]; 
  newmetadata.zoomscreen=intcoords; 
 } 
 if (newmetadata.smoothscreen!==undefined) { 
  var val = newmetadata.smoothscreen; 
  var args = val.split(/\s+/); 
 
  var validArguments = true 
 
  if (args.length < 1) { 
   logErrorNoLine('smoothscreen given no arguments but expects at least 1: smoothscreen [flick] WxH [IxJ] [S]') 
   validArguments = false 
  } else if (args.length > 4) { 
   logErrorNoLine('smoothscreen given ' + args.length + ' arguments but expects at most 4: smoothscreen [flick] WxH [IxJ] [S]') 
   validArguments = false 
  } 
 
  const smoothscreen = { 
   screenSize: { width: 0, height: 0 }, 
   boundarySize: { width: 1, height: 1 }, 
   cameraSpeed: 0.125, 
   flick: false, 
   debug: !!newmetadata.smoothscreen_debug 
  } 
 
  if (args[0] === 'flick') { 
   smoothscreen.flick = true 
   args.shift() 
  } 
 
  const screenSizeMatch = args[0].match(/^(?<width>\d+)x(?<height>\d+)$/) 
  if (screenSizeMatch) { 
   smoothscreen.screenSize.width = parseInt(screenSizeMatch.groups.width) 
   smoothscreen.screenSize.height = parseInt(screenSizeMatch.groups.height) 
 
   if (smoothscreen.flick) { 
    smoothscreen.boundarySize.width = smoothscreen.screenSize.width 
    smoothscreen.boundarySize.height = smoothscreen.screenSize.height 
   } 
  } else { 
   logErrorNoLine('smoothscreen given first argument ' + args[0] + ' but must be formatted WxH where W and H are integers') 
   validArguments = false 
  } 
 
  if (args.length > 1) { 
   const boundarySizeMatch = args[1].match(/^(?<width>\d+)x(?<height>\d+)$/) 
   if (boundarySizeMatch) { 
    smoothscreen.boundarySize.width = parseInt(boundarySizeMatch.groups.width) 
    smoothscreen.boundarySize.height = parseInt(boundarySizeMatch.groups.height) 
   } else { 
    logErrorNoLine('smoothscreen given second argument ' + args[1] + ' but must be formatted IxJ where I and J are integers') 
    validArguments = false 
   } 
  } 
 
  if (args.length > 2) { 
   const cameraSpeedMatch = args[2].match(/^(?<speed>\d+(\.\d+)?)$/) 
   if (cameraSpeedMatch) { 
    smoothscreen.cameraSpeed = parseFloat(cameraSpeedMatch.groups.speed) 
   } else { 
    logErrorNoLine('smoothscreen given third argument ' + args[2] + ' but must be a number') 
    validArguments = false 
   } 
  } 
 
  if (validArguments) { 
   newmetadata.smoothscreen = smoothscreen; 
  } else { 
   delete newmetadata.smoothscreen 
  } 
 } 
 
 state.metadata=newmetadata; 
 
 if (!update) { 
  state.default_metadata = deepClone(newmetadata); 
 } 
} 
 
function processWinConditions(state) { 
// [-1/0/1 (no,some,all),ob1,ob2] (ob2 is background by default) 
 var newconditions=[];  
 for (var i=0;i<state.winconditions.length;i++)  { 
  var wincondition=state.winconditions[i]; 
  if (wincondition.length==0) { 
   return; 
  } 
  var num=0; 
  switch(wincondition[0].toLowerCase()) { 
   case 'no':{num=-1;break;} 
   case 'all':{num=1;break;} 
  } 
 
  var lineNumber=wincondition[wincondition.length-1]; 
 
  var n1 = wincondition[1]; 
  var n2; 
  if (wincondition.length==5) { 
   n2 = wincondition[3]; 
  } else { 
   n2 = 'background'; 
  } 
 
  var mask1=0; 
  var mask2=0; 
  if (n1 in state.objectMasks) { 
   mask1=state.objectMasks[n1]; 
  } else { 
   logError('unwelcome term "' + n1 +'" found in win condition. Win conditions objects have to be objects or properties (defined using "or", in terms of other properties)', lineNumber); 
  } 
  if (n2 in state.objectMasks) { 
   mask2=state.objectMasks[n2]; 
  } else { 
   logError('unwelcome term "' + n2+ '" found in win condition. Win conditions objects have to be objects or properties (defined using "or", in terms of other properties)', lineNumber); 
  } 
  var newcondition = [num,mask1,mask2,lineNumber]; 
  newconditions.push(newcondition); 
 } 
 state.winconditions=newconditions; 
} 
 
function printCellRow(cellRow) { 
 var result ="[ "; 
 for (var i=0;i<cellRow.length;i++) { 
  if (i>0) { 
   result += "| "; 
  } 
  var cell = cellRow[i]; 
  for (var j=0;j<cell.length;j+=2) { 
   var direction = cell[j]; 
   var object = cell[j+1] 
   if (direction==="...") { 
    result += direction+" "; 
   } else { 
    result += direction+" "+object+" "; 
   } 
  }   
 } 
 result +="] "; 
 return result; 
} 
 
function printRule(rule) { 
 var result="(<a onclick=\"jumpToLine('"+ rule.lineNumber.toString() + "');\"  href=\"javascript:void(0);\">"+rule.lineNumber+"</a>) "+ rule.direction.toString().toUpperCase()+" "; 
 if (rule.rigid) { 
  result = "RIGID "+result+" "; 
 } 
 if (rule.randomRule) { 
  result = "RANDOM "+result+" "; 
 } 
 if (rule.globalRule) { 
  result = "GLOBAL "+result+" "; 
 } 
 if (rule.late) { 
  result = "LATE "+result+" "; 
 } 
 for (var i=0;i<rule.lhs.length;i++) { 
  var cellRow = rule.lhs[i]; 
  result = result + printCellRow(cellRow); 
 } 
 result = result + "-> "; 
 for (var i=0;i<rule.rhs.length;i++) { 
  var cellRow = rule.rhs[i]; 
  result = result + printCellRow(cellRow); 
 } 
 for (var i=0;i<rule.commands.length;i++) { 
  var command = rule.commands[i]; 
  if (command.length===1) { 
   result = result +command[0].toString(); 
  } else { 
   result = result + '('+command[0].toString()+", "+command[1].toString()+') ';    
  } 
 } 
 //print commands next 
 return result; 
} 
function printRules(state) { 
 var output = "<br>Rule Assembly : ("+ state.rules.length +" rules )<br>===========<br>"; 
 var loopIndex = 0; 
 var loopEnd = -1; 
 for (var i=0;i<state.rules.length;i++) { 
  var rule = state.rules[i]; 
  if (loopIndex < state.loops.length) { 
   if (state.loops[loopIndex][0] < rule.lineNumber) { 
    output += "STARTLOOP<br>"; 
    loopIndex++; 
    if (loopIndex < state.loops.length) { // don't die with mismatched loops 
     loopEnd = state.loops[loopIndex][0]; 
     loopIndex++; 
    } 
   } 
  } 
  if (loopEnd !== -1 && loopEnd < rule.lineNumber) { 
   output += "ENDLOOP<br>"; 
   loopEnd = -1; 
  } 
  output += printRule(rule) +"<br>"; 
 } 
 if (loopEnd !== -1) { // no more rules after loop end 
  output += "ENDLOOP<br>"; 
 } 
 output+="===========<br>"; 
 consolePrint(output); 
} 
 
function removeDuplicateRules(state) { 
 var record = {}; 
 var newrules=[]; 
 var lastgroupnumber=-1; 
 for (var i=state.rules.length-1;i>=0;i--) { 
  var r = state.rules[i]; 
  var groupnumber = r.groupNumber; 
  if (groupnumber!==lastgroupnumber) { 
   record={}; 
  } 
  var r_string=printRule(r); 
  if (record.hasOwnProperty(r_string)) { 
   state.rules.splice(i,1); 
  } else { 
   record[r_string]=true; 
  } 
  lastgroupnumber=groupnumber; 
 } 
} 
function generateLoopPoints(state) { 
 var loopPoint={}; 
 var loopPointIndex=0; 
 var outside=true; 
 var source=0; 
 var target=0; 
 if (state.loops.length%2===1) { 
  logErrorNoLine("have to have matching number of  'startLoop' and 'endLoop' loop points."); 
 } 
 
 for (var j=0;j<state.loops.length;j++) { 
  var loop = state.loops[j]; 
  for (var i=0;i<state.rules.length;i++) { 
   var ruleGroup = state.rules[i]; 
 
   var firstRule = ruleGroup[0];    
   var lastRule = ruleGroup[ruleGroup.length-1]; 
 
   var firstRuleLine = firstRule.lineNumber; 
   var lastRuleLine = lastRule.lineNumber; 
 
   if (outside) { 
    if (firstRuleLine>=loop[0]) { 
     target=i; 
     outside=false; 
     if (loop[1]===-1) { 
      logErrorNoLine("Need have to have matching number of  'startLoop' and 'endLoop' loop points.");       
     } 
     break; 
    } 
   } else { 
    if (firstRuleLine>=loop[0]) { 
     source = i-1;   
     loopPoint[source]=target; 
     outside=true; 
     if (loop[1]===1) { 
      logErrorNoLine("Need have to have matching number of  'startLoop' and 'endLoop' loop points.");       
     } 
     break; 
    } 
   } 
  } 
 } 
 if (outside===false) { 
  var source = state.rules.length; 
  loopPoint[source]=target; 
 } else { 
 } 
 state.loopPoint=loopPoint; 
 
 loopPoint={}; 
 outside=true; 
 for (var j=0;j<state.loops.length;j++) { 
  var loop = state.loops[j]; 
  for (var i=0;i<state.lateRules.length;i++) { 
   var ruleGroup = state.lateRules[i]; 
 
   var firstRule = ruleGroup[0];    
   var lastRule = ruleGroup[ruleGroup.length-1]; 
 
   var firstRuleLine = firstRule.lineNumber; 
   var lastRuleLine = lastRule.lineNumber; 
 
   if (outside) { 
    if (firstRuleLine>=loop[0]) { 
     target=i; 
     outside=false; 
     if (loop[1]===-1) { 
      logErrorNoLine("Need have to have matching number of  'startLoop' and 'endLoop' loop points.");       
     } 
     break; 
    } 
   } else { 
    if (firstRuleLine>=loop[0]) { 
     source = i-1;   
     loopPoint[source]=target; 
     outside=true; 
     if (loop[1]===1) { 
      logErrorNoLine("Need have to have matching number of  'startLoop' and 'endLoop' loop points.");       
     } 
     break; 
    } 
   } 
  } 
 } 
 if (outside===false) { 
  var source = state.lateRules.length; 
  loopPoint[source]=target; 
 } else { 
 } 
 state.lateLoopPoint=loopPoint; 
} 
 
var soundEvents = ["titlescreen", "startgame", "cancel", "endgame", "startlevel","undo","restart","endlevel","showmessage","closemessage","sfx0","sfx1","sfx2","sfx3","sfx4","sfx5","sfx6","sfx7","sfx8","sfx9","sfx10"]; 
var soundMaskedEvents =["create","destroy","move","cantmove","action"]; 
var soundVerbs = soundEvents.concat(soundMaskedEvents); 
 
 
function validSeed (seed ) { 
 return /^\s*\d+\s*$/.exec(seed)!==null; 
} 
 
 
var soundDirectionIndicatorMasks = { 
 'up'   : parseInt('00001', 2), 
 'down'   : parseInt('00010', 2), 
 'left'   : parseInt('00100', 2), 
 'right'   : parseInt('01000', 2), 
 'horizontal' : parseInt('01100', 2), 
 'vertical'  : parseInt('00011', 2), 
 'orthogonal' : parseInt('01111', 2), 
 '___action____'  : parseInt('10000', 2) 
}; 
 
var soundDirectionIndicators = ["up","down","left","right","horizontal","vertical","orthogonal","___action____"]; 
 
 
function generateSoundData(state) { 
 var sfx_Events={}; 
 var sfx_CreationMasks=[]; 
 var sfx_DestructionMasks=[]; 
 var sfx_MovementMasks=[]; 
 var sfx_MovementFailureMasks=[]; 
 
 for (var i=0;i<state.sounds.length;i++) { 
  var sound=state.sounds[i]; 
  if (sound.length<=1) { 
   continue; 
  } 
  var lineNumber=sound[sound.length-1]; 
 
  if (sound.length===2){    
   logError('incorrect sound declaration.',lineNumber); 
   continue; 
  } 
 
  if (soundEvents.indexOf(sound[0])>=0) { 
   if (sound.length>4) { 
    logError("too much stuff to define a sound event.",lineNumber); 
   } 
   var seed = sound[1]; 
   if (validSeed(seed)) { 
    if (sfx_Events[sound[0]]!==undefined){ 
     logWarning(sound[0].toUpperCase()+" already declared.",lineNumber);     
    }  
    sfx_Events[sound[0]]=sound[1]; 
   } else { 
    logError("Expecting sfx data, instead found \""+sound[1]+"\".",lineNumber);     
   } 
  } else { 
   var target = sound[0].trim(); 
   var verb = sound[1].trim(); 
   var directions = sound.slice(2,sound.length-2); 
   if (directions.length>0&&(verb!=='move'&&verb!=='cantmove')) { 
    logError('incorrect sound declaration.',lineNumber); 
   } 
 
   if (verb==='action') { 
    verb='move'; 
    directions=['___action____']; 
   } 
 
   if (directions.length==0) { 
    directions=["orthogonal"]; 
   } 
   var seed = sound[sound.length-2]; 
 
   if (target in state.aggregatesDict) { 
    logError('cannot assign sound events to aggregate objects (declared with "and"), only to regular objects, or properties, things defined in terms of "or" ("'+target+'").',lineNumber); 
   } 
   else if (target in state.objectMasks) { 
 
   } else { 
    logError('Object "'+ target+'" not found.',lineNumber); 
   } 
 
   var objectMask = state.objectMasks[target]; 
 
   var directionMask=0; 
   for (var j=0;j<directions.length;j++) { 
    directions[j]=directions[j].trim(); 
    var direction=directions[j]; 
    if (soundDirectionIndicators.indexOf(direction)===-1) { 
     logError('Was expecting a direction, instead found "'+direction+'".',lineNumber); 
    } else { 
     var soundDirectionMask = soundDirectionIndicatorMasks[direction]; 
     directionMask |= soundDirectionMask; 
    } 
   } 
 
 
   var targets=[target]; 
   var modified=true; 
   while(modified) { 
    modified=false; 
    for (var k=0;k<targets.length;k++) { 
     var t = targets[k]; 
     if (t in state.synonymsDict) { 
      targets[k]=state.synonymsDict[t]; 
      modified=true; 
     } else if (t in state.propertiesDict) { 
      modified=true; 
      var props = state.propertiesDict[t]; 
      targets.splice(k,1); 
      k--; 
      for (var l=0;l<props.length;l++) { 
       targets.push(props[l]); 
      } 
     } 
    } 
   } 
 
   if (verb==='move' || verb==='cantmove') { 
    for (var j=0;j<targets.length;j++) { 
     var targetName = targets[j]; 
     var targetDat = state.objects[targetName]; 
     var targetLayer = targetDat.layer; 
     var shiftedDirectionMask = new BitVec(STRIDE_MOV); 
     shiftedDirectionMask.ishiftor(directionMask, 5*targetLayer); 
 
     var o = { 
      objectMask: objectMask, 
      directionMask: shiftedDirectionMask, 
      seed: seed 
     }; 
 
     if (verb==='move') { 
      sfx_MovementMasks.push(o);       
     } else { 
      sfx_MovementFailureMasks.push(o); 
     } 
    } 
   } 
 
 
   if (!validSeed(seed)) { 
    logError("Expecting sfx data, instead found \""+seed+"\".",lineNumber);  
   } 
 
   var targetArray; 
   switch(verb) { 
    case "create": { 
     var o = { 
      objectMask: objectMask, 
      seed: seed 
     } 
     sfx_CreationMasks.push(o); 
     break; 
    } 
    case "destroy": { 
     var o = { 
      objectMask: objectMask, 
      seed: seed 
     } 
     sfx_DestructionMasks.push(o); 
     break; 
    } 
   } 
  } 
 } 
 
 state.sfx_Events = sfx_Events; 
 state.sfx_CreationMasks = sfx_CreationMasks; 
 state.sfx_DestructionMasks = sfx_DestructionMasks; 
 state.sfx_MovementMasks = sfx_MovementMasks; 
 state.sfx_MovementFailureMasks = sfx_MovementFailureMasks; 
} 
 
 
function formatHomePage(state){ 
 if ('background_color' in state.metadata) { 
  state.bgcolor=colorToHex(colorPalette,state.metadata.background_color); 
 } else { 
  state.bgcolor="#000000"; 
 } 
 if ('text_color' in state.metadata) { 
  state.fgcolor=colorToHex(colorPalette,state.metadata.text_color); 
 } else { 
  state.fgcolor="#FFFFFF"; 
 } 
  
 if (isColor(state.fgcolor)===false ){ 
  logError("text_color in incorrect format - found "+state.fgcolor+", but I expect a color name (like 'pink') or hex-formatted color (like '#1412FA').") 
 } 
 if (isColor(state.bgcolor)===false ){ 
  logError("background_color in incorrect format - found "+state.bgcolor+", but I expect a color name (like 'pink') or hex-formatted color (like '#1412FA').") 
 } 
 
 if (canSetHTMLColors) { 
   
  if ('background_color' in state.metadata)  { 
   document.body.style.backgroundColor=state.bgcolor; 
  } 
   
  if ('text_color' in state.metadata) { 
   var separator = document.getElementById("separator"); 
   if (separator!=null) { 
      separator.style.color = state.fgcolor; 
   } 
    
   var h1Elements = document.getElementsByTagName("a"); 
   for(var i = 0; i < h1Elements.length; i++) { 
      h1Elements[i].style.color = state.fgcolor; 
   } 
 
   var h1Elements = document.getElementsByTagName("h1"); 
   for(var i = 0; i < h1Elements.length; i++) { 
      h1Elements[i].style.color = state.fgcolor; 
   } 
  } 
 } 
 
 if ('homepage' in state.metadata) { 
  var url = state.metadata['homepage']; 
  url=url.replace("http://",""); 
  url=url.replace("https://",""); 
  state.metadata['homepage']=url; 
 } 
} 
 
var MAX_ERRORS=5; 
function loadFile(str) { 
 var processor = new codeMirrorFn(); 
 var state = processor.startState(); 
 
 var lines = str.split('\n'); 
 for (var i = 0; i < lines.length; i++) { 
  var line = lines[i]; 
  state.lineNumber = i + 1; 
  var ss = new CodeMirror.StringStream(line, 4); 
  do { 
   processor.token(ss, state); 
 
   if (errorCount>MAX_ERRORS) { 
    consolePrint("too many errors, aborting compilation"); 
    return; 
   } 
  }   
  while (ss.eol() === false); 
 } 
 
 delete state.lineNumber; 
 
 generateExtraMembers(state); 
 generateMasks(state); 
 levelsToArray(state); 
 extractSections(state); 
 rulesToArray(state); 
 
 removeDuplicateRules(state); 
 
 if (debugMode) { 
  printRules(state); 
 } 
 
 rulesToMask(state); 
 arrangeRulesByGroupNumber(state); 
 collapseRules(state.rules); 
 collapseRules(state.lateRules); 
 
 checkNoLateRulesHaveMoves(state); 
 
 generateRigidGroupList(state); 
 
 processWinConditions(state); 
 checkObjectsAreLayered(state); 
 
 twiddleMetaData(state); 
  
 generateExtraMembersPart2(state); 
 
 generateLoopPoints(state); 
 
 generateSoundData(state); 
 
 formatHomePage(state); 
 
 delete state.commentLevel; 
 delete state.names; 
 delete state.abbrevNames; 
 delete state.objects_candname; 
 delete state.objects_section; 
 delete state.objects_spritematrix; 
 delete state.section; 
 delete state.subsection; 
 delete state.tokenIndex; 
 delete state.visitedSections; 
 delete state.loops; 
 /* 
 var lines = stripComments(str); 
 window.console.log(lines); 
 var sections = generateSections(lines); 
 window.console.log(sections); 
 var sss = generateSemiStructuredSections(sections);*/ 
 return state; 
} 
 
var ifrm; 
function compile(command,text,randomseed) { 
 matchCache={}; 
 forceRegenImages=true; 
 if (command===undefined) { 
  command = ["restart"]; 
 } 
 if (randomseed===undefined) { 
  randomseed = null; 
 } 
 lastDownTarget=canvas;  
 
 if (text===undefined){ 
  var code = window.form1.code; 
 
  var editor = code.editorreference; 
 
  text = editor.getValue()+"\n"; 
 } 
 if (canDump===true) { 
  compiledText=text; 
 } 
 
 errorCount = 0; 
 compiling = true; 
 errorStrings = []; 
 consolePrint('================================='); 
 try 
 { 
  var state = loadFile(text); 
//  consolePrint(JSON.stringify(state)); 
 } finally { 
  compiling = false; 
 } 
 
 if (state && state.levels && state.levels.length===0){  
  logError('No levels found.  Add some levels!',undefined,true); 
 } 
 
 if (errorCount>MAX_ERRORS) { 
  return; 
 } 
 /*catch(err) 
 { 
  if (anyErrors===false) { 
   logErrorNoLine(err.toString()); 
  } 
 }*/ 
 
 if (errorCount>0) { 
  consoleError('<span class="systemMessage">Errors detected during compilation, the game may not work correctly.</span>'); 
 } 
 else { 
  var ruleCount=0; 
  for (var i=0;i<state.rules.length;i++) { 
   ruleCount+=state.rules[i].length; 
  } 
  for (var i=0;i<state.lateRules.length;i++) { 
   ruleCount+=state.lateRules[i].length; 
  } 
  if (command[0]=="restart") { 
   consolePrint('<span class="systemMessage">Successful Compilation, generated ' + ruleCount + ' instructions.</span>'); 
  } else { 
   consolePrint('<span class="systemMessage">Successful live recompilation, generated ' + ruleCount + ' instructions.</span>'); 
 
  } 
 } 
 setGameState(state,command,randomseed); 
 
 clearInputHistory(); 
 
 consoleCacheDump(); 
} 
 
 
 
function qualifyURL(url) { 
 var a = document.createElement('a'); 
 a.href = url; 
 return a.href; 
}</script> <script>function selectText(e,t){t=t||window.event;var l=document.getElementById(e);if(t&&(t.ctrlKey||t.metaKey)){if(solving)return;var o=["console"].concat(l.innerHTML.split("<br>")),n=levelFromString(state,o);loadLevelFromLevelDat(state,n,null),canvasResize()}else if(document.selection){var i=document.body.createTextRange();i.moveToElementText(l),i.select()}else if(window.getSelection){var i=document.createRange();i.selectNode(l),window.getSelection().addRange(i)}}function recalcLevelBounds(){}function arrCopy(e,t,l,o,n){for(;n--;)l[o++]=e[t]++}function adjustLevel(e,t,l){backups.push(backupLevel());var o=e.clone();e.width+=t,e.height+=l,e.n_tiles=e.width*e.height,e.objects=new Int32Array(e.n_tiles*STRIDE_OBJ);var n=new BitVec(STRIDE_OBJ);n.ibitset(state.backgroundid);for(var i=0;i<e.n_tiles;++i)e.setCell(i,n);return e.movements=new Int32Array(e.objects.length),columnAdded=!0,RebuildLevelArrays(),o}function addLeftColumn(){for(var e=adjustLevel(level,1,0),t=1;t<level.width;++t)for(var l=0;l<level.height;++l){var o=t*level.height+l;level.setCell(o,e.getCell(o-level.height))}}function addRightColumn(){for(var e=adjustLevel(level,1,0),t=0;t<level.width-1;++t)for(var l=0;l<level.height;++l){var o=t*level.height+l;level.setCell(o,e.getCell(o))}}function addTopRow(){for(var e=adjustLevel(level,0,1),t=0;t<level.width;++t)for(var l=1;l<level.height;++l){var o=t*level.height+l;level.setCell(o,e.getCell(o-t-1))}}function addBottomRow(){for(var e=adjustLevel(level,0,1),t=0;t<level.width;++t)for(var l=0;l<level.height-1;++l){var o=t*level.height+l;level.setCell(o,e.getCell(o-t))}}function removeLeftColumn(){if(!(level.width<=1))for(var e=adjustLevel(level,-1,0),t=0;t<level.width;++t)for(var l=0;l<level.height;++l){var o=t*level.height+l;level.setCell(o,e.getCell(o+level.height))}}function removeRightColumn(){if(!(level.width<=1))for(var e=adjustLevel(level,-1,0),t=0;t<level.width;++t)for(var l=0;l<level.height;++l){var o=t*level.height+l;level.setCell(o,e.getCell(o))}}function removeTopRow(){if(!(level.height<=1))for(var e=adjustLevel(level,0,-1),t=0;t<level.width;++t)for(var l=0;l<level.height;++l){var o=t*level.height+l;level.setCell(o,e.getCell(o+t+1))}}function removeBottomRow(){if(!(level.height<=1))for(var e=adjustLevel(level,0,-1),t=0;t<level.width;++t)for(var l=0;l<level.height;++l){var o=t*level.height+l;level.setCell(o,e.getCell(o+t))}}function matchGlyph(e,t){for(var l,o=-1,n=0;n<t.length;++n){var i=t[n][0],r=t[n][1],a=t[n][2];if(r.bitsSetInArray(e.data)){for(var s=0,c=0;c<32*STRIDE_OBJ;++c)a.get(c)&&e.get(c)&&s++,r.get(c)&&e.get(c)&&s++;s>o&&(o=s,l=i)}}return o>0?l:(logErrorNoLine("Wasn't able to approximate a glyph value for some tiles, using '.' as a placeholder.",!0),".")}function printLevel(){var e=[];for(var t in state.glyphDict)if(state.glyphDict.hasOwnProperty(t)&&1===t.length){for(var l=state.glyphDict[t],o=new BitVec(STRIDE_OBJ),n=0;n<l.length;n++){var i=l[n];i>=0&&o.ibitset(i)}var r=o.clone(),a=state.layerMasks[state.backgroundlayer];o.iclear(a),e.push([t,o,r])}selectableint++;var s="selectable"+selectableint,c='Printing level contents:<br><br><span id="'+s+'" onclick="selectText(\''+s+"',event)\"><br>";cache_console_messages=!1;for(var d=0;d<level.height;d++){for(var n=0;n<level.width;n++){var u=d+n*level.height,v=level.getCell(u),l=matchGlyph(v,e);l in htmlEntityMap&&(l=htmlEntityMap[l]),c+=l}d<level.height-1&&(c+="<br>")}c+="</span><br><br>",consolePrint(c,!0)}function levelEditorClick(e,t){if(mouseCoordY<=-2){var l=editorRowCount-(-mouseCoordY-2)-1,o=mouseCoordX+(screenwidth-1)*l;-1===mouseCoordX?printLevel():mouseCoordX>=0&&o<glyphImages.length&&(glyphSelectedIndex=o,redraw())}else if(mouseCoordX>-1&&mouseCoordY>-1&&mouseCoordX<screenwidth-2&&mouseCoordY<screenheight-2-editorRowCount){for(var n=glyphImagesCorrespondance[glyphSelectedIndex],i=state.glyphDict[n],r=new BitVec(STRIDE_OBJ),a=0;a<i.length;a++){var s=i[a];s>=0&&r.ibitset(s)}var c=state.layerMasks[state.backgroundlayer];r.bitsClearInArray(c.data)&&r.ibitset(state.backgroundid);var d=mouseCoordY+mouseCoordX*level.height,u=level.getCell(d);if(u.equals(r))return;!1===anyEditsSinceMouseDown&&(anyEditsSinceMouseDown=!0,backups.push(backupLevel())),level.setCell(d,r),redraw()}else t&&(-1===mouseCoordX?(addLeftColumn(),canvasResize()):mouseCoordX===screenwidth-2&&(addRightColumn(),canvasResize()),-1===mouseCoordY?(addTopRow(),canvasResize()):mouseCoordY===screenheight-2-editorRowCount&&(addBottomRow(),canvasResize()))}function levelEditorRightClick(e,t){if(-2===mouseCoordY)mouseCoordX<=glyphImages.length&&(glyphSelectedIndex=mouseCoordX,redraw());else if(mouseCoordX>-1&&mouseCoordY>-1&&mouseCoordX<screenwidth-2&&mouseCoordY<screenheight-2-editorRowCount){var l=mouseCoordY+mouseCoordX*level.height,o=new BitVec(STRIDE_OBJ);o.ibitset(state.backgroundid),level.setCell(l,o),redraw()}else t&&(-1===mouseCoordX?(removeLeftColumn(),canvasResize()):mouseCoordX===screenwidth-2&&(removeRightColumn(),canvasResize()),-1===mouseCoordY?(removeTopRow(),canvasResize()):mouseCoordY===screenheight-2-editorRowCount&&(removeBottomRow(),canvasResize()))}function getTilesTraversingPoints(e,t,l,o){if(cellwidth!==cellheight)throw"Error: Cell is not square.";for(var n=l-e,i=o-t,r=t*n,a=e*i-r,s=cellwidth*(Math.abs(n)+Math.abs(i)),c=2*a-s,d=2*a+s,u=Math.floor(e/cellwidth),v=Math.floor(t/cellheight),g=Math.floor(l/cellwidth),m=Math.floor(o/cellheight),h=cellwidth-1,f=g-u>=0?1:-1,p=m-v>=0?1:-1,y=v,C=[],S=[],w=u;w!=g+f;w+=f)for(var k=!1,b=y;b!=m+p;b+=p){if(b>=level.height||b<0||w>=level.width||w<0)throw error="Mouse input loop failed; it:"+w+" "+b+" cell1:"+u+" "+v+" cell2:"+g+" "+m,console.log(error),error;if(function(e,t){return fOfPointTimesTwo=i*e-n*t,c<fOfPointTimesTwo==fOfPointTimesTwo<=d}(2*w*cellwidth+h,2*b*cellwidth+h))C.push(w),S.push(b),k=!0,y=b;else if(k)break}for(var M=("mouse_obstacle"in state.metadata),x=[u],T=[v];u!==g||v!==m;){if(v>=level.height||v<0||u>=level.width||u<0)throw error="Mouse input loop failed; cell1:"+u+" "+v+" cell2:"+g+" "+m,console.log(error),error;if(hitObstacle=function(){var e=screenOffsetY+v+(screenOffsetX+u)*level.height,t=level.getCell(e);return!!state.obstacleMask.anyBitsInCommon(t)},cellCornerXTimesTwo=2*u*cellwidth+h+f*cellwidth,cellCornerYTimesTwo=2*v*cellwidth+h+p*cellwidth,fOfPointTimesTwo=i*cellCornerXTimesTwo-n*cellCornerYTimesTwo,fOfPointTimesTwo>2*a==p>0!=f>0?(u+=f,M&&hitObstacle()&&(u-=f,v+=p)):(v+=p,M&&hitObstacle()&&(v-=p,u+=f)),M&&hitObstacle())break;x.push(u),T.push(v)}if(M)C=x,S=T;else for(var w=0;w<C.length;w++)if(C[w]!==x[w]||S[w]!==T[w]){try{displayError("line tile placement algorithm discrepancies detected")}catch(e){}throw consolePrint("line tile placement algorithm discrepancies detected",!0),"line tile placement algorithm discrepancies detected"}return{tileListX:C,tileListY:S}}function mouseAction(e,t,l){if(textMode){if(!t)return;if(!titleScreen||quittingTitleScreen||titleSelected)!1===messageselected&&state.levels[curlevel].message&&(messageselected=!0,timer=0,quittingMessageScreen=!0,tryPlayCloseMessageSound(),titleScreen=!1,drawMessageScreen());else if(0===titleMode)titleButtonSelected();else if(1===titleMode)5===mouseCoordY&&titleSelectOptions>=1?(titleSelection=0,titleButtonSelected()):6===mouseCoordY&&titleSelectOptions>=3?(titleSelection=1,titleButtonSelected()):7===mouseCoordY&&titleSelectOptions>=2?(2===titleSelectOptions?titleSelection=1:titleSelection=2,titleButtonSelected()):8===mouseCoordY&&titleSelectOptions>=4&&(titleSelection=3,titleButtonSelected());else if(2===titleMode)if(0===mouseCoordY)titleSelection=0,goToTitleScreen(),tryPlayTitleSound(),canvasResize();else if(2===mouseCoordY)0!=levelSelectScrollPos&&levelSelectScroll(-3);else if(12===mouseCoordY)titleSelectOptions-amountOfLevelsOnScreen>levelSelectScrollPos&&levelSelectScroll(3);else{var o=-1;switch(mouseCoordY){case 3:o=0;break;case 4:o=1;break;case 5:o=2;break;case 6:o=3;break;case 7:o=4;break;case 8:o=5;break;case 9:o=6;break;case 10:o=7;break;case 11:o=8}-1!=o&&(o+=levelSelectScrollPos)<titleSelectOptions&&(titleSelection=o,titleSelected=!0,messageselected=!1,timer=0,quittingTitleScreen=!0,generateLevelSelectScreen(),redraw())}}else if(x1=x2,y1=y2,x2=mousePixelX,y2=mousePixelY,x2=Math.max(0,Math.min(cellwidth*screenwidth-1,mousePixelX)),y2=Math.max(0,Math.min(cellheight*screenheight-1,mousePixelY)),t){if(mouseCoordX>=0&&mouseCoordY>=0&&mouseCoordX<screenwidth&&mouseCoordY<screenheight){var n=screenOffsetY+mouseCoordY+(screenOffsetX+mouseCoordX)*level.height;if(lastCoord=n,againing);else try{var i=backupLevel(),r=level.getCell(n);r.ibitset(l),level.setCell(n,r);var a=5;pushInput(a),processInput(a,!1,!1,i)&&redraw()}catch(e){console.log(e),consolePrint(e,!0)}}}else for(var s=getTilesTraversingPoints(x1,y1,x2,y2),c=s.tileListX,d=s.tileListY,u=0;u<c.length;u++){var n=screenOffsetY+d[u]+(screenOffsetX+c[u])*level.height;if(lastCoord!==n)if(lastCoord=n,againing);else try{var i=backupLevel(),r=level.getCell(n);r.ibitset(l),level.setCell(n,r);var a=5;pushInput(a),processInput(a,!1,!1,i)&&redraw()}catch(e){console.log(e),consolePrint(e,!0)}}}function onMouseDown(e){if(0!==e.button||e.ctrlKey||e.metaKey)if(2===e.button||0===e.button&&(e.ctrlKey||e.metaKey))if("gameCanvas"===e.target.id){if(setMouseCoord(e),dragging=!1,rightdragging=!0,levelEditorOpened)return levelEditorRightClick(e,!0);if("mouse_right"in state.metadata)return mouseAction(e,!0,state.rmbID)}else dragging=!1,rightdragging=!1;else 1===e.button&&!1===textMode&&levelEditorOpened&&(pushInput("undo"),DoUndo(!1,!0),canvasResize());else{if(lastDownTarget=e.target,keybuffer=[],e.target===canvas){if(setMouseCoord(e),dragging=!0,rightdragging=!1,anyEditsSinceMouseDown=!1,levelEditorOpened)return levelEditorClick(e,!0);if("mouse_left"in state.metadata)return mouseAction(e,!0,state.lmbID)}dragging=!1,rightdragging=!1}}function rightClickCanvas(e){return"mouse_right"in state.metadata?prevent(e):levelEditorOpened?prevent(e):void 0}function onMouseUp(e){if(dragging=!1,rightdragging=!1,0===e.button){if(e.target===canvas&&(setMouseCoord(e),"mouse_up"in state.metadata))return mouseAction(e,!0,state.lmbupID)}else if(2===e.button&&"gameCanvas"===e.target.id&&(setMouseCoord(e),"mouse_rup"in state.metadata))return mouseAction(e,!0,state.rmbupID)}function onKeyDown(e){e=e||window.event,!IDE&&[32,37,38,39,40].indexOf(e.keyCode)>-1&&prevent(e),IDE||77!==e.keyCode||toggleMute(),keybuffer.indexOf(e.keyCode)>=0||((lastDownTarget===canvas||window.Mobile&&lastDownTarget===window.Mobile.focusIndicator)&&-1===keybuffer.indexOf(e.keyCode)&&(keybuffer.splice(keyRepeatIndex,0,e.keyCode),keyRepeatTimer=0,checkKey(e,!0)),!0===canDump&&(74===e.keyCode&&(e.ctrlKey||e.metaKey)?(dumpTestCase(),prevent(e)):75===e.keyCode&&(e.ctrlKey||e.metaKey)?(makeGIF(),prevent(e)):83===e.keyCode&&(e.ctrlKey||e.metaKey)?(saveClick(),prevent(e)):66===e.keyCode&&(e.ctrlKey||e.metaKey)?(rebuildClick(),prevent(e),e.target.blur(),canvas.focus()):82===e.keyCode&&(e.ctrlKey||e.metaKey)?(runClick(),prevent(e),e.target.blur(),canvas.focus()):120===e.keyCode?(prevent(e),solve()):119===e.keyCode&&(prevent(e),stopSolving())))}function relMouseCoords(e){var t=0,l=0,o=0,n=0,i=this;do{t+=i.offsetLeft-i.scrollLeft,l+=i.offsetTop-i.scrollTop}while(i=i.offsetParent);return o=e.pageX-t,n=e.pageY-l,{x:o,y:n}}function onKeyUp(e){e=e||window.event;var t=keybuffer.indexOf(e.keyCode);t>=0&&(keybuffer.splice(t,1),keyRepeatIndex>=t&&keyRepeatIndex--)}function onMyFocus(e){keybuffer=[],keyRepeatIndex=0,keyRepeatTimer=0}function onMyBlur(e){keybuffer=[],keyRepeatIndex=0,keyRepeatTimer=0}function setMouseCoord(e){var t=canvas.relMouseCoords(e);mousePixelX=t.x-xoffset,mousePixelY=t.y-yoffset,mouseCoordX=Math.floor(mousePixelX/cellwidth),mouseCoordY=Math.floor(mousePixelY/cellheight)}function onMouseMove(e){levelEditorOpened?(setMouseCoord(e),dragging?levelEditorClick(e,!1):rightdragging&&levelEditorRightClick(e,!1),redraw()):dragging&&"mouse_drag"in state.metadata?(setMouseCoord(e),mouseAction(e,!1,state.dragID),redraw()):rightdragging&&"mouse_rdrag"in state.metadata&&(setMouseCoord(e),mouseAction(e,!1,state.rdragID),redraw())}function onMouseIn(){mouseInCanvas=!0}function onMouseOut(){mouseInCanvas=!1}function onMouseWheel(e){mouseInCanvas&&!e.ctrlKey&&(normalizedDelta=Math.sign(e.deltaY),titleScreen&&2==titleMode&&(state.metadata.mouse_left||state.metadata.mouse_drag)&&(levelSelectScroll(normalizedDelta),redraw(),prevent(e)),levelEditorOpened&&(glyphSelectedIndex=clamp(glyphSelectedIndex+normalizedDelta,0,glyphCount()-1),redraw(),prevent(e)))}function levelSelectScroll(e){levelSelectScrollPos=clamp(levelSelectScrollPos+e,0,Math.max(state.sections.length-amountOfLevelsOnScreen,0)),titleSelection=clamp(titleSelection+e,0,state.sections.length-1),console.log(levelSelectScrollPos+" "+titleSelection),generateLevelSelectScreen(),redraw()}function clamp(e,t,l){return Math.min(Math.max(e,t),l)}function prevent(e){return e.preventDefault&&e.preventDefault(),e.stopImmediatePropagation&&e.stopImmediatePropagation(),e.stopPropagation&&e.stopPropagation(),e.returnValue=!1,!1}function titleButtonSelected(){!1===titleSelected&&(tryPlayStartGameSound(),titleSelected=!0,messageselected=!1,timer=0,quittingTitleScreen=!0,generateTitleScreen(),canvasResize())}function pollGamepads(){function e(e,t){return!(e.length<t)&&("object"==typeof e[t]?e[t].pressed:1==e[t])}function t(e,t,l){return!(e.length<t)&&e[t]*l>.5}function l(e){-1===keybuffer.indexOf(e)&&(keybuffer.splice(keyRepeatIndex,0,e),keyRepeatTimer=0,checkKey({keyCode:e},!0)),n.splice(0,0,e)}function o(){for(var e=0;e<gamepadKeys.length;e++)if(!(n.indexOf(gamepadKeys[e])>=0)){var t=keybuffer.indexOf(gamepadKeys[e]);t>=0&&(keybuffer.splice(t,1),keyRepeatIndex>=t&&keyRepeatIndex--)}gamepadKeys=n}var n=[],i=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[];if(null==i||0==i.length)return void o();for(var r=0;r<i.length;r++){var a=i[r];null!=a&&a.connected&&((e(a.buttons,3)||e(a.buttons,4))&&l(82),(e(a.buttons,1)||t(a.axes,2,1))&&l(90),(e(a.buttons,2)||e(a.buttons,0)||e(a.buttons,5)||t(a.axes,1,1))&&l(88),e(a.buttons,7)&&l(27),e(a.buttons,6)&&l(69),(t(a.axes,0,1)||t(a.axes,6,1))&&l(39),(t(a.axes,0,-1)||t(a.axes,6,-1))&&l(37),(t(a.axes,1,-1)||t(a.axes,7,-1))&&l(38),(t(a.axes,1,1)||t(a.axes,7,1))&&l(40))}o()}function checkKey(e,t){if(!winning){var l=-1;switch(e.keyCode){case 65:case 37:l=1;break;case 38:case 87:l=0;break;case 68:case 39:l=3;break;case 83:case 40:l=2;break;case 80:printLevel();break;case 13:case 32:case 67:case 88:if(!1!==norepeat_action&&!t)return;l=4;break;case 85:case 90:if(!1===textMode)return pushInput("undo"),DoUndo(!1,!0),canvasResize(),prevent(e);break;case 82:if(!1===textMode&&t)return pushInput("restart"),DoRestart(),canvasResize(),prevent(e);break;case 27:if(solving){stopSolving();break}if(!1===titleScreen||titleMode>1)return(timer/1e3>.5||titleMode>1)&&(titleSelection=0,timer=0,!1===titleScreen&&void 0!==state.metadata.level_select?gotoLevelSelectScreen():goToTitleScreen(),tryPlayTitleSound(),canvasResize()),prevent(e);break;case 69:if(!solving&&canOpenEditor)return t&&(titleScreen&&("EMPTY GAME"===state.title?compile(["loadFirstNonMessageLevel"]):nextLevel()),levelEditorOpened=!levelEditorOpened,!1===levelEditorOpened&&printLevel(),restartTarget=backupLevel(),canvasResize()),prevent(e);break;case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:if(levelEditorOpened&&t){var o=9;return e.keyCode>=49&&(o=e.keyCode-49),o<glyphImages.length?glyphSelectedIndex=o:consolePrint("Trying to select tile outside of range in level editor.",!0),canvasResize(),prevent(e)}}if(throttle_movement&&l>=0&&l<=3){if(lastinput==l&&input_throttle_timer<repeatinterval)return;lastinput=l,input_throttle_timer=0}if(textMode){if(!throttle_movement){if(lastinput==l&&input_throttle_timer<repeatinterval)return;lastinput=l,input_throttle_timer=0}if(0===state.levels.length);else if(titleScreen)0===titleMode?4===l&&t&&titleButtonSelected():4==l&&t?!1===titleSelected&&(tryPlayStartGameSound(),titleSelected=!0,messageselected=!1,timer=0,quittingTitleScreen=!0,1==titleMode?generateTitleScreen():2==titleMode&&generateLevelSelectScreen(),redraw()):0!==l&&2!==l||(0===l?titleSelection--:titleSelection++,titleSelection>=titleSelectOptions?titleSelection-=titleSelectOptions:titleSelection<0&&(titleSelection+=titleSelectOptions),1==titleMode?generateTitleScreen():2==titleMode&&generateLevelSelectScreen(),redraw());else if(4==l&&t){if(unitTesting)return void nextLevel();!1===messageselected&&(messageselected=!0,timer=0,quittingMessageScreen=!0,tryPlayCloseMessageSound(),titleScreen=!1,drawMessageScreen())}}else if(!againing&&l>=0)return 4===l&&"noaction"in state.metadata||(pushInput(l),processInput(l)&&redraw()),prevent(e)}}function update(){var e=!1;if(timer+=deltatime,input_throttle_timer+=deltatime,quittingTitleScreen&&timer/1e3>.3&&(quittingTitleScreen=!1,titleMode<=1?nextLevel():2==titleMode&&gotoSelectedLevel()),againing&&timer>againinterval&&0==messagetext.length&&processInput(-1)&&(e=!0,keyRepeatTimer=0,autotick=0),quittingMessageScreen&&timer/1e3>.15&&(quittingMessageScreen=!1,""===messagetext?nextLevel():(messagetext="",textMode=!1,titleScreen=!1,titleMode=curlevel>0||null!==curlevelTarget?1:0,titleSelected=!1,titleSelection=0,canvasResize(),checkWin())),winning&&timer/1e3>.5&&(winning=!1,nextLevel()),pollGamepads(),keybuffer.length>0){keyRepeatTimer+=deltatime;var t=throttle_movement?repeatinterval:repeatinterval/Math.sqrt(keybuffer.length);if(keyRepeatTimer>t){keyRepeatTimer=0,keyRepeatIndex=(keyRepeatIndex+1)%keybuffer.length;checkKey({keyCode:keybuffer[keyRepeatIndex]},!1)}}!(autotickinterval>0)||textMode||levelEditorOpened||againing||winning||(autotick+=deltatime,autotick>autotickinterval&&(autotick=0,pushInput("tick"),processInput(-1)&&(e=!0))),(e||void 0!==state&&void 0!==state.metadata.smoothscreen)&&redraw()}var keyRepeatTimer=0,keyRepeatIndex=0,input_throttle_timer=0,lastinput=-100,dragging=!1,rightdragging=!1,columnAdded=!1,htmlEntityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},selectableint=0,lastCoord,x1=5,y1=5,x2=5,y2=5,anyEditsSinceMouseDown=!1;HTMLCanvasElement.prototype.relMouseCoords=relMouseCoords;var mouseCoordX=0,mouseCoordY=0,mousePixelX=0,mousePixelY=0;mouseInCanvas=!1,document.addEventListener("mousedown",onMouseDown,!1),document.addEventListener("mouseup",onMouseUp,!1),document.addEventListener("mousemove",onMouseMove,!1),document.addEventListener("contextmenu",rightClickCanvas,!1),document.addEventListener("keydown",onKeyDown,!1),document.addEventListener("keyup",onKeyUp,!1),document.addEventListener("wheel",onMouseWheel,{passive:!1}),window.addEventListener("focus",onMyFocus,!1),window.addEventListener("blur",onMyBlur,!1),canvas.addEventListener("mouseenter",onMouseIn,!1),canvas.addEventListener("mouseleave",onMouseOut,!1);var gamepadKeys=[];setInterval(function(){update()},deltatime);</script> <script>function Animatable(t,i,e){function n(){var t;return o+=i,o>=1&&(t=!0,o=1),e(o),t}function s(){var t;return o-=i,o<=0&&(t=!0,o=0),e(o),t}var o,a;return a={animateUp:function(){Animator.getInstance().animate(t,n)},animateDown:function(){Animator.getInstance().animate(t,s)}},o=0,a}window.Mobile={},Mobile.hasTouch=function(){var t;return("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)&&(t=!0),t},Mobile.enable=function(t){return(t||Mobile.hasTouch()&&!Mobile._instance)&&(Mobile._instance=new Mobile.GestureHandler,Mobile._instance.bindEvents(),Mobile._instance.bootstrap()),Mobile._instance},window.Mobile.GestureHandler=function(){this.initialize.apply(this,arguments)},Mobile.log=function(t){var i;i=document.getElementsByTagName("h1")[0],i.innerHTML=Math.random().toString().substring(4,1)+"-"+t},Mobile.debugDot=function(t){var i,e,n;n="border-radius: 50px;width: 5px;height: 5px;background: red;position: absolute;left: "+t.touches[0].clientX+"px;top: "+t.touches[0].clientY+"px;",i=document.createElement("div"),i.setAttribute("style",n),e=document.getElementsByTagName("body")[0],e.appendChild(i)},function(t){"use strict";var i={action:88,left:37,right:39,up:38,down:40,undo:85,restart:82,quit:27},e=['<div class="tab">','  <div class="tab-affordance"></div>','  <div class="tab-icon">','    <div class="slice"></div>','    <div class="slice"></div>',"  </div>","</div>"].join("\n");t.initialize=function(){this.firstPos={x:0,y:0},this.setTabAnimationRatio=this.setTabAnimationRatio.bind(this),this.setMenuAnimationRatio=this.setMenuAnimationRatio.bind(this),this.repeatTick=this.repeatTick.bind(this),this.isFocused=!0},t.setFocusElement=function(t){this.focusElement=t,this.isFocused=!1,this.buildFocusIndicator()},t.bindEvents=function(){window.addEventListener("touchstart",this.onTouchStart.bind(this)),window.addEventListener("touchend",this.onTouchEnd.bind(this)),window.addEventListener("touchmove",this.onTouchMove.bind(this))},t.bootstrap=function(){this.showTab(),this.disableScrolling(),this.isAudioSupported()||this.disableAudio(),this.disableSelection()},t.onTouchStart=function(t){this.isTouching||(this.handleFocusChange(t),this.isFocused&&"A"!==t.target.tagName.toUpperCase()&&(this.isTouching=!0,this.mayBeSwiping=!0,this.gestured=!1,this.swipeDirection=void 0,this.swipeDistance=0,this.startTime=(new Date).getTime(),this.firstPos.x=t.touches[0].clientX,this.firstPos.y=t.touches[0].clientY))},t.onTouchEnd=function(t){this.isFocused&&this.isTouching&&(this.gestured||0===t.touches.length&&this.handleTap(),0===t.touches.length&&(this.isTouching=!1,this.endRepeatWatcher()))},t.onTouchMove=function(t){if(this.isFocused)return this.isSuccessfulSwipe()?(this.handleSwipe(this.swipeDirection,this.touchCount),this.gestured=!0,this.mayBeSwiping=!1,this.beginRepeatWatcher(t)):this.mayBeSwiping?this.swipeStep(t):this.isRepeating&&this.repeatStep(t),prevent(t),!1},t.handleFocusChange=function(t){this.focusElement&&(this.isFocused=this.isTouchInsideFocusElement(t),this.setFocusIndicatorVisibility(this.isFocused))},t.isTouchInsideFocusElement=function(t){var i;return!(!t.touches||!t.touches[0])&&(i=this.absoluteElementPosition(this.focusElement),!(t.touches[0].clientX<i.left||t.touches[0].clientY<i.top)&&!(t.touches[0].clientX>i.left+this.focusElement.clientWidth||t.touches[0].clientY>i.top+this.focusElement.clientHeight))},t.setFocusIndicatorVisibility=function(t){var i;i="visible",t||(i="hidden"),this.focusIndicator.setAttribute("style","visibility: "+i+";")},t.absoluteElementPosition=function(t){var i,e;for(i={top:t.offsetTop||0,left:t.offsetLeft||0},e=document.getElementsByTagName("body")[0],i.top-=e.scrollTop||0;;){if(!(t=t.offsetParent))break;i.top+=t.offsetTop||0,i.left+=t.offsetLeft||0}return i},t.beginRepeatWatcher=function(t){var i;this.repeatInterval||(this.isRepeating=!0,i=1e3*state.metadata.key_repeat_interval,!isNaN(i)&&i||(i=150),this.repeatInterval=setInterval(this.repeatTick,i),this.recenter(t))},t.endRepeatWatcher=function(){this.repeatInterval&&(clearInterval(this.repeatInterval),delete this.repeatInterval,this.isRepeating=!1)},t.repeatTick=function(){this.isTouching&&this.handleSwipe(this.direction,this.touchCount)},t.recenter=function(t){this.firstPos.x=t.touches[0].clientX,this.firstPos.y=t.touches[0].clientY},t.isSuccessfulSwipe=function(){var t;return this.mayBeSwiping&&void 0!==this.swipeDirection&&this.swipeDistance>=50&&(t=!0),t},t.swipeStep=function(t){var i,e,n;this.mayBeSwiping&&(i={x:t.touches[0].clientX,y:t.touches[0].clientY},e=(new Date).getTime(),n=t.touches.length,this.swipeDistance=this.cardinalDistance(this.firstPos,i),this.swipeDirection?e-this.startTime>1e3&&(this.mayBeSwiping=!1):this.swipeDistance>10&&(this.swipeDirection=this.dominantDirection(this.firstPos,i),this.touchCount=n))},t.repeatStep=function(t){var i,e;i={x:t.touches[0].clientX,y:t.touches[0].clientY},(e=this.cardinalDistance(this.firstPos,i))>=50&&(this.swipeDirection=this.dominantDirection(this.firstPos,i),this.recenter(t))},t.cardinalDistance=function(t,i){var e,n;return e=Math.abs(t.x-i.x),n=Math.abs(t.y-i.y),Math.max(e,n)},t.dominantDirection=function(t,i){var e,n,s;return e=i.x-t.x,n=i.y-t.y,s="x",Math.abs(n)>Math.abs(e)&&(s="y"),"x"===s?e>0?"right":"left":n>0?"down":"up"},t.handleSwipe=function(t,i){1===i?this.emitKeydown(this.swipeDirection):i>1&&this.toggleMenu()},t.handleTap=function(){this.emitKeydown("action")},t.emitKeydown=function(t){if(this.isMenuVisible||"undo"!=t&&"restart"!=t&&"quit"!=t){var e;e={keyCode:i[t]},this.fakeCanvasFocus(),onKeyDown(e),onKeyUp(e)}},t.fakeCanvasFocus=function(){var t;t=document.getElementById("gameCanvas"),onMouseDown({button:0,target:t})},t.toggleMenu=function(){this.isMenuVisible?this.hideMenu():this.showMenu()},t.showMenu=function(){this.menuElem||this.buildMenu(),this.getAnimatables().menu.animateUp(),this.isMenuVisible=!0,this.hideTab()},t.hideMenu=function(){this.menuElem&&this.getAnimatables().menu.animateDown(),this.isMenuVisible=!1,this.showTab()},t.getAnimatables=function(){var t=this;return this._animatables||(this._animatables={tab:Animatable("tab",.1,t.setTabAnimationRatio),menu:Animatable("menu",.1,t.setMenuAnimationRatio)}),this._animatables},t.showTab=function(){this.tabElem||this.buildTab(),this.getAnimatables().tab.animateDown()},t.hideTab=function(){this.tabElem&&this.tabElem.setAttribute("style","display: none;"),this.getAnimatables().tab.animateUp()},t.buildTab=function(){var t,i,n,s,o=this;t=document.createElement("div"),t.innerHTML=e,s=t.children[0],n=function(t){t.stopPropagation(),o.showMenu()},this.tabAffordance=s.getElementsByClassName("tab-affordance")[0],this.tabElem=s.getElementsByClassName("tab-icon")[0],this.tabAffordance.addEventListener("touchstart",n),this.tabElem.addEventListener("touchstart",n),i=document.getElementsByTagName("body")[0],i.appendChild(s)},t.buildMenu=function(){var t,i,e,n,s,o,a,c=this;t=document.createElement("div"),t.innerHTML=this.buildMenuString(state),this.menuElem=t.children[0],this.closeElem=this.menuElem.getElementsByClassName("close")[0],a=function(t){t.stopPropagation(),c.hideMenu()},this.closeAffordance=this.menuElem.getElementsByClassName("close-affordance")[0],o=this.menuElem.getElementsByClassName("close")[0],this.closeAffordance.addEventListener("touchstart",a),o.addEventListener("touchstart",a),e=this.menuElem.getElementsByClassName("undo")[0],e&&e.addEventListener("touchstart",function(t){t.stopPropagation(),c.emitKeydown("undo")}),n=this.menuElem.getElementsByClassName("restart")[0],n&&n.addEventListener("touchstart",function(t){t.stopPropagation(),c.emitKeydown("restart")}),s=this.menuElem.getElementsByClassName("quit")[0],s.addEventListener("touchstart",function(t){t.stopPropagation(),c.emitKeydown("quit")}),i=document.getElementsByTagName("body")[0],i.appendChild(this.menuElem)},t.buildMenuString=function(t){var i,e,n,s;return n=t.metadata.noundo,s=t.metadata.norestart,i=3,n&&(i-=1),s&&(i-=1),e=['<div class="mobile-menu item-count-'+i+'">','  <div class="close-affordance"></div>','  <div class="close">','    <div class="slice"></div>','    <div class="slice"></div>',"  </div>"],n||e.push('  <div class="undo button">Undo</div>'),s||e.push('  <div class="restart button">Restart</div>'),e=e.concat(['  <div class="quit button">Quit to Menu</div>','  <div class="clear"></div>',"</div>"]),e.join("\n")},t.buildFocusIndicator=function(){var t;this.focusIndicator=document.createElement("DIV"),this.focusIndicator.setAttribute("class","tapFocusIndicator"),this.focusIndicator.setAttribute("style","visibility: hidden;"),t=this.focusElement.parentNode,t.appendChild(this.focusIndicator)},t.setTabAnimationRatio=function(t){var i,e,n;t=Math.round(1e3*t)/1e3,t>=.999?this.tabAffordance.setAttribute("style","display: none;"):this.tabAffordance.setAttribute("style","display: block;"),i=66*t+18*(1-t),e="opacity: "+(1-t)+";",n=e+" width: "+i+"px;",this.tabElem.setAttribute("style",n)},t.setMenuAnimationRatio=function(t){var i,e,n;t=Math.round(1e3*t)/1e3,i=-18*t+-66*(1-t),e="opacity: "+t+";",n="left: "+(i-4)+"px; "+e+" width: "+-i+"px;",t=Math.round(1e3*t)/1e3,t<=.001?(this.closeAffordance.setAttribute("style","display: none;"),e="display:none;"):this.closeAffordance.setAttribute("style","display: block;"),this.closeElem.setAttribute("style",n),this.menuElem.setAttribute("style",e)},t.disableScrolling=function(){var t={height:"100%",overflow:"hidden",position:"fixed",width:"100%"},i="";for(var e in t)i+=e+": "+t[e]+"; ";document.body.setAttribute("style",i)},t.disableAudio=function(){window.playSeed=function(){}},t.isAudioSupported=function(){var t=!0;return"undefined"!=typeof webkitAudioContext&&(t=!1),t},t.disableSelection=function(){var t;t=document.getElementsByTagName("body")[0],t.setAttribute("class",t.getAttribute("class")+" disable-select")}}(window.Mobile.GestureHandler.prototype),window.Animator=function(){this.initialize.apply(this,arguments)},function(t){t.initialize=function(){this._animations={},this.tick=this.tick.bind(this)},t.animate=function(t,i){this._animations[t]=i,this.wakeup()},t.wakeup=function(){this._isAnimating||(this._isAnimating=!0,this.tick())},t.tick=function(){var t,i,e,n,s;n=[],e=!0;for(t in this._animations){if(!this._animations.hasOwnProperty(t))return;i=this._animations[t](),i?n.push(t):e=!1}if(e){for(s=0;s<n.length;n++)delete this._isAnimating[n[s]];this._isAnimating=!1}else requestAnimationFrame(this.tick)}}(window.Animator.prototype),window.Animator.getInstance=function(){return window.Animator._instance||(window.Animator._instance=new window.Animator),window.Animator._instance},function(){"use strict";var t,i,e=["ms","moz","webkit","o"];for(t=0;t<e.length&&!window.requestAnimationFrame;t++)window.requestAnimationFrame=window[e[t]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[t]+"CancelAnimationFrame"],window.cancelAnimationFrame||(window.cancelAnimationFrame=window[e[t]+"CancelRequestAnimationFrame"]);window.requestAnimationFrame||(i=0,window.requestAnimationFrame=function(t,e){var n,s,o;return n=(new Date).getTime(),s=Math.max(0,16-(n-i)),o=window.setTimeout(function(){t(n+s)},s),i=n+s,o}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)}),Mobile.enable()}();</script> <script>var sourceCode="title Snail\nauthor Acorn Studios\nhomepage https://acorn-studios.itch.io/\nbackground_color black\ntext_color lightgreen\n\nsprite_size 5x5\n\n========\nOBJECTS\n========\n\nBackground\nblack\n\n\nTarget\nwhite darkblue \n01010\n10101\n01010\n1....\n1....\n\nWall0\ngreen\n.....\n.....\n.....\n.....\n00000\n\nWall1\ngreen\n0....\n0....\n0....\n0....\n0....\n\nWall2\ngreen\n00000\n.....\n.....\n.....\n.....\n\nWall3\ngreen\n....0\n....0\n....0\n....0\n....0\n\nPlayer\nwhite brown lightbrown darkbrown lightgreen\n.....\n..4.4\n11.4.\n1314.\n111..\n\n\nCrate\ngray darkgray black\n..00.\n.0010\n10101\n01101\n11010\n\nNoMove\nbrown lightbrown darkbrown\n.000.\n02020\n00200\n02020\n.000.\n\n\n=======\nLEGEND\n=======\n\n. = Background\n0 = Wall0\n1 = Wall1\n- = Wall2\n_ = Wall3\n/ = NoMove\nP = Player\n* = Crate\n@ = Crate and Target\nO = Target\n\n\n=======\nSOUNDS\n=======\n\nCrate MOVE 36772507\nEndLevel 28067900\nshowmessage 48648304\nstartgame 68679102\n\n================\nCOLLISIONLAYERS\n================\n\nBackground\nTarget\nPlayer, Wall0, Crate, Wall1, Wall2, Wall3, NoMove\n\n======\nRULES\n======\n\n[ >  Player | Crate ] -> [  >  Player | > Crate  ]\n\n==============\nWINCONDITIONS\n==============\n\nAll Target on Crate\n\n=======\nLEVELS\n=======\n\nmessage *Male Voice Over* - \"Hello, and welcome to the snail lab, this is where we test snails to see if they are ready for the real world!\"\n\nmessage \"We also have snacks for you guys, feel free to watch the snails and keep safe. Have a good day.\"\n\nmessage *Female Voice Over* - \"Open S.R.C. Labs - Building Better Ecosystems -- One Creature At A Time\"\n\n.0000.\n_....1\n_o*.p1\n_o*..1\n_....1\n.----.\n\nmessage *Male Voice Over* - \"This snail that we have here (Test 638109823) seems to be highly intelligent!\"\n\nmessage \"I wonder how it will react to unmoveable barrels... Lets see!\"\n\n.0000000.\n_..//./o1\n_o..*...1\n_o.***.p1\n_...o...1\n.-------.\n\nmessage *Male Voice Over* - \"Wow! Lets introduce more snails... That are clones of Test 638109823! Lets see what happens.\"\n\n.000000000.\n_.../p....1\n_......*.o1\n_o*p...*o.1\n_......*.o1\n_.../p....1\n.---------.\n\nmessage *Muffled Crowd Cheers* *Male Voice Over* - \"Interesting... They can be controlled together. Thats something new.\"\n\nmessage \"Time for 2 more chambers for mental and physical testing!\"\n\n.0000000000.\n_........o.1\n_o*./*p./..1\n_....o../*.1\n_........p.1\n_..p.../...1\n_.....//../1\n.----------.\n\nmessage *Male Voice Over* - \"My goodness that was very satisfying!\"\n\nmessage \"Time For a 'maze'!\"\n\n.000000000.\n_/o/.///o/1\n_/*/o*./*/1\n_/p/p/p/p/1\n_/*/./././1\n_/o/p/././1\n.---------.\n\nmessage *Crowd Cheers* *Male Voice* - \"Amazing!\" *Female Voice* - \"Outstanding!\" *Male Voice Over* - \"Ah, yes this snails brain seems to have developed much since the first chamber! Thank you for staying with us for these rigorous tests!\"\n\nmessage *Female Voice Over* - \"Open S.R.C. Labs - Building Better Ecosystems -- One Creature At A Time\"\n\nmessage THE\n\nmessage THE END\n\nmessage THE END?\n\nmessage THE END? - Thanks for playing ";compile(["restart"],sourceCode);</script> </body> </html> 
